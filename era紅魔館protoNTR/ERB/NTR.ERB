;-------------------------------------------------------------------------------
;NTRメイン処理
;　訪問者による住人NTR関係の主要な処理
;
;-----------------------------------------------------------
;各種NTRフラグの初期化
@NTR_CLEAR_FLG
#DIM LOOP_CHR
CFLAG:MASTER:射精者V = 0
CFLAG:MASTER:射精者M = 0
CFLAG:MASTER:射精者A = 0
FOR LOOP_CHR,1,CHARANUM
    CFLAG:LOOP_CHR:射精者V = 0
    CFLAG:LOOP_CHR:射精者M = 0
    CFLAG:LOOP_CHR:射精者A = 0
    CFLAG:LOOP_CHR:覗き発覚回数 = 0
    CFLAG:LOOP_CHR:覗き発覚時行為 = 0
    CFLAG:LOOP_CHR:同席目撃回数 = 0
    CFLAG:LOOP_CHR:同席目撃時行為 = 0
    CFLAG:LOOP_CHR:ローター挿入者 = 0
    CFLAG:LOOP_CHR:訪問者行為 = NTR_行為_なし
NEXT
FLAG:ハーレム時カウンタ = 0
    ;睡姦関連
FLAG:睡姦フラグ = 0
FOR LOOP_CHR,1,CHARANUM
    CFLAG:LOOP_CHR:NTR睡姦 = 0
    CFLAG:LOOP_CHR:覚醒 = 0
    CFLAG:LOOP_CHR:挿入 = 0
NEXT
    ;FOR TEST キス経験クリア
    ;FOR LOOP_CHR,1,CHARANUM
    ;   CSTR:LOOP_CHR:Ｍ初体験の相手 '= ""
    ;   EXP:LOOP_CHR:キス経験 = 0
    ;NEXT
RETURN 0

;-------------------------------------------------------------------------------
;訪問者の出現処理
;@return 1:xxx,0:xxx
@VISITER_APPEARANCE
#DIM LOOP_CHR
#DIM 奉仕種別
#DIM 帰宅フラグ
#DIM 移動ルートループ
#DIM 移動目撃フラグ
SIF !GETBIT(FLAG:ＮＴＲパッチ設定,0)
    CALL NTR_OPTION
    ;お持ち帰りされていた場合は位置を初期化
SIF CFLAG:1:現在位置 < 場所_訪問者宅
    CFLAG:1:現在位置 = 場所_守衛小屋
SIF CFLAG:2:現在位置 < 場所_訪問者宅
    CFLAG:2:現在位置 = 場所_小悪魔私室
SIF CFLAG:3:現在位置 < 場所_訪問者宅
    CFLAG:3:現在位置 = 場所_パチュリー私室
SIF CFLAG:4:現在位置 < 場所_訪問者宅
    CFLAG:4:現在位置 = 場所_咲夜私室
SIF CFLAG:5:現在位置 < 場所_訪問者宅
    CFLAG:5:現在位置 = 場所_レミリア私室
SIF CFLAG:6:現在位置 < 場所_訪問者宅
    CFLAG:6:現在位置 = 場所_地下室
SIF CFLAG:7:現在位置 < 場所_訪問者宅
    CFLAG:7:現在位置 = (TALENT:7:恋慕 ? 15 # 8)
SIF CFLAG:8:現在位置 < 場所_訪問者宅
    CFLAG:8:現在位置 = 場所_チルノの家
SIF CFLAG:9:現在位置 < 場所_訪問者宅
    CFLAG:9:現在位置 = 場所_大妖精の家
SIF CFLAG:10:現在位置 < 場所_訪問者宅
    CFLAG:10:現在位置 = 場所_魔理沙の家
SIF CFLAG:11:現在位置 < 場所_訪問者宅
    CFLAG:11:現在位置 = 場所_博麗神社
SIF CFLAG:12:現在位置 < 場所_訪問者宅
    CFLAG:12:現在位置 = 場所_ルーミアの住処
SIF CFLAG:13:現在位置 < 場所_訪問者宅
    CFLAG:13:現在位置 = 場所_アリスの家
    ;前日お持ち帰りされて帰ってきてない場合は朝帰り
IF IS_NTR_IMPRISON_ENABLE()
    TRYCALL NTR_MORNING_MASTER
ELSE
    TRYCALL NTR_MORNING_MASTER_OLD
ENDIF
FOR LOOP_CHR,1,CHARANUM
    帰宅フラグ = !IS_NTR_LONG_STAY()
    IF NTR_GET_STAYOUT_CURRENT(LOOP_CHR) >= NTR_GET_STAYOUT_MAXIMUM(LOOP_CHR)
            ;外泊日数が最大日数に達していたら帰ってくる
        帰宅フラグ = 1
    ELSEIF ( 100 - 100 * CFLAG:LOOP_CHR:屈服度 / MAX(1,CFLAG:LOOP_CHR:好感度) ) > RAND:100
            ;屈服度より好感度が高い場合、比率に応じた確率で帰ってくる
        帰宅フラグ = 1
    ENDIF
    IF CFLAG:LOOP_CHR:現在位置 == 場所_訪問者宅 && 帰宅フラグ
        PRINTFORML 
            ;滞在日数のリセット
        CALL NTR_SET_STAYOUT_CURRENT(LOOP_CHR,0)
            ;朝のご奉仕イベント
        IF NTR_CHK_VISIBLE(900)
            CALL NTR_MESSAGE_14(LOOP_CHR)
        ENDIF
            ;奉仕種別…行為(0:口奉仕,1:尻穴奉仕,2:淫壷奉仕,)
        奉仕種別 = 0
        奉仕種別 = RAND:(3 - TALENT:LOOP_CHR:処女)
        IF FLAG:再教育フラグ
            IF TALENT:LOOP_CHR:処女
                奉仕種別 = 1
            ELSE
                奉仕種別 = 2
            ENDIF
        ENDIF
            ;奉仕実行
        IF 奉仕種別 == 0
            CALL NTR_MORNING_SERVICE_FELLATIO(LOOP_CHR)
        ELSEIF 奉仕種別 == 1
            CALL NTR_MORNING_SERVICE_ASEX(LOOP_CHR)
        ELSEIF 奉仕種別 == 2
            CALL NTR_MORNING_SERVICE_VSEX(LOOP_CHR)
        ENDIF
        PRINTW
            ;公衆便所時もっと汚れて帰ってくる
        CALL MORNING_ADD_STAIN(LOOP_CHR)
            ;帰宅時のおみやげ
        CALL NTR_PUNISHMENT(LOOP_CHR)
        CALL NTR_SOURCE_CHECK(LOOP_CHR, 人物_訪問者)
        PRINTFORMW  ：
        PRINTFORMW  ：
        PRINTFORMW %CALLNAME:LOOP_CHR%がどこかから帰ってきたようだ
        CFLAG:LOOP_CHR:現在位置 = GET_PRIVATE_ROOM(LOOP_CHR, 0)
            ;紅魔館玄関から私室への移動経路を算出
        CALLF FARMOVE(LOOP_CHR,場所_正門,CFLAG:LOOP_CHR:現在位置)
        移動目撃フラグ = 0
        FOR 移動ルートループ,0,移動ルートMAX
            IF NTR_CHK_VISIBLE( 移動ルート:LOOP_CHR:移動ルートループ )
                移動目撃フラグ = 1
            ENDIF
        NEXT
            ;恋慕かつ浮気公認状態なら、あなたを探して報告してくれる
        IF TALENT:LOOP_CHR:恋慕 && TALENT:LOOP_CHR:浮気公認
            移動目撃フラグ = 1
            ;お持ち帰り時イベント写真取得
            CALL NTR_TAKEOUT_PHOTO1(LOOP_CHR)
        ENDIF
            ;移動経路算出に使った移動ルートを消去しておく
        CALLF RESET_ROUTE(LOOP_CHR,1)
            ;帰宅を目撃できていれば口上を表示
        IF 移動目撃フラグ
            CALL NTR_MESSAGE_0(LOOP_CHR)
            TRYCALLLIST
                FUNC NTR_KOJO_K{LOOP_CHR}_0(LOOP_CHR)
                FUNC NTR_KOJO_K_0(LOOP_CHR)
            ENDFUNC
            ;お持ち帰り時イベント写真表示
            CALL NTR_TAKEOUT_PHOTO2(LOOP_CHR)
        ENDIF
        SIF !TALENT:LOOP_CHR:親愛
            EXP:LOOP_CHR:浮気外泊経験 ++
            ;訪問者と同伴してくる
            ;RETURN 0
            ;同行解除
        CFLAG:LOOP_CHR:同行 = 0
    ELSEIF CFLAG:LOOP_CHR:現在位置 == 場所_訪問者宅 
        CFLAG:LOOP_CHR:長期滞在最大日数 += 1
        CALL NTR_RESET_VISITOR_ACTION(LOOP_CHR)
        FLAG:訪問者との汚れ判定に使用 = 0
            ;口上呼び出しの前に口上の特殊な客情報生成があれば実行
        TRYCALLLIST
            FUNC NTR_KOJO_K{CFLAG:LOOP_CHR:297}_MAKE_CLIENT(LOOP_CHR)
            FUNC NTR_KOJO_K_MAKE_CLIENT(LOOP_CHR)
        ENDFUNC
        IF NTR_CHK_VISIBLE(CFLAG:LOOP_CHR:現在位置)
                ;滞在継続時口上
            TRYCALLLIST
                FUNC NTR_KOJO_K{CFLAG:LOOP_CHR:297}_10_7(LOOP_CHR)
                FUNC NTR_KOJO_K_10_7(LOOP_CHR)
            ENDFUNC
        ENDIF
    ENDIF
    FLAG:再教育フラグ = 0
NEXT
    ;露出プレイ強制中断時のフォロー。私室に戻す。
FOR LOOP_CHR,1,CHARANUM
    IF CFLAG:LOOP_CHR:NTR野外調教 != 0
        CALL NTR_EXHIBITION_END(LOOP_CHR)
        CFLAG:LOOP_CHR:現在位置 = GET_PRIVATE_ROOM(LOOP_CHR, 0)
    ENDIF
NEXT
    ;下記値を変更すると訪問者の来る確率が変わります
IF (GETBIT(FLAG:ゲームモード, 3) && IS_NTR_VISITOR_COME()) || (RAND:100 < 90 && DAY > 7 && IS_NTR_VISITOR_COME())
    FOR LOOP_CHR,0,CHARANUM
        IF CFLAG:LOOP_CHR:現在位置 == 場所_訪問者宅
            FLAG:訪問者の現在位置 = 場所_訪問者宅
            FLAG:訪問者滞在時間カウンタ = 0
            RETURN 0
        ENDIF
    NEXT
        ;訪問者出現場所
        ;FLAG:訪問者の現在位置 = 場所_薄暗い路地裏
    FLAG:訪問者の現在位置 = 場所_正門
        ;FLAG:訪問者の現在位置 = 場所_納屋
        ;FLAG:訪問者の現在位置 = 場所_大浴場
    CALL NTR_RESET_VISITOR_ACTION(-1)
    FLAG:訪問者との汚れ判定に使用 = 0
    FLAG:訪問者滞在時間カウンタ = 0
    PRINTFORML 
    PRINTFORML 館に誰か訪ねて来たようだ
ELSE
    FLAG:訪問者の現在位置 = 場所_訪問者宅
    FLAG:訪問者滞在時間カウンタ = 0
ENDIF

;お持ち帰り時イベント写真取得
@NTR_TAKEOUT_PHOTO1(奴隷)
	#DIM 奴隷
	
	; 初売春時、オークション写真贈呈
	IF CFLAG:奴隷:前回売春フラグ & 前回売春_初売春
		CFLAG:奴隷:前回売春フラグ |= 前回売春_写真
	; 結婚式イベント対応(オークションとは排他)
	ELSEIF CFLAG:奴隷:持帰分岐 == NTR_持帰分岐_結婚式
		CFLAG:奴隷:前回売春フラグ |= 前回売春_結婚式
		CFLAG:奴隷:前回売春フラグ |= 前回売春_写真
	ENDIF
RETURN 0

;お持ち帰り時イベント写真表示
@NTR_TAKEOUT_PHOTO2(奴隷)
	#DIM 奴隷
	
	IF CFLAG:奴隷:前回売春フラグ & 前回売春_写真
		; 初売春時、オークション写真贈呈
		IF CFLAG:奴隷:前回売春フラグ & 前回売春_初売春
			; ステージ上で競り
			CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_処女競売0)
			; お買い上げ後抱擁
			CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_処女競売1)
			; お買い上げ後キス
			CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_処女競売2)
		ENDIF
		; 結婚式イベント対応
		IF 奴隷 == 人物_咲夜
			IF CFLAG:奴隷:前回売春フラグ & 前回売春_結婚式
				; ウエディングドレス
				CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_結婚式0)
				; 指輪交換
				CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_結婚式1)
				; 誓いのキス
				CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_結婚式2)
				; 着衣セックス
				CALL GET_NTR_TAKEOUT_PHOTO(奴隷, 写真_NTR_売春, 写真詳細_売春_結婚式3)
			ENDIF
		ENDIF
	ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;訪問者移動
;引数…なし
;戻り値…0:移動しない
;処理結果…FLAG:訪問者の現在位置を更新する
@VISITER_MOVEMENT
#DIM 訪問者移動先
#DIM 未表示
#DIM LOOP_CHR

    ;気になる場所が設定されていてまだ1度も到達していない場合、気になる場所に到達したかどうか判定
IF FLAG:訪問者の気になる場所 != 0 && FLAG:1832 == 0 && FLAG:訪問者の現在位置 == FLAG:訪問者の気になる場所
    FLAG:1832 += 1
ENDIF
    ;訪問者の滞在時間更新
FLAG:訪問者滞在時間カウンタ += TIME_PROGRESS(TFLAG:300)
    ;訪問者移動可否判定
CALL CHK_VISITOR_MOVE
IF RESULT == 0
    RETURN 0
ENDIF
TRYCALL DEBUGPRINT_あの人は何処に？()
    ;訪問者移動先判定
CALL JUDGE_VISITOR_MOVE_POS
訪問者移動先 = RESULT
    ;訪問者の移動
IF 訪問者移動先
    IF CFLAG:MASTER:現在位置 == 訪問者移動先
        PRINTFORML %NTR_NAME(0)%が【%GETPLACENAME(訪問者移動先)%】に入ってきた
        未表示 = 1
        FOR LOOP_CHR,0,CHARANUM
            IF CFLAG:LOOP_CHR:現在位置 == 訪問者移動先
                IF CFLAG:LOOP_CHR:うふふ != 0
                    IF 未表示
                        PRINTFORML %NTR_NAME(0)%が入ってきたことで空気が変わってしまった・・・
                        未表示 = 0
                    ENDIF
                    CFLAG:LOOP_CHR:うふふ = 0
                ENDIF
                CALL CLOTHES_RESET(LOOP_CHR)
                CALL CLOTHES_SETTING_TRAIN(LOOP_CHR)
            ENDIF
        NEXT
    ELSE
        IF NTR_CHK_VISIBLE(訪問者移動先) || NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORML %NTR_NAME(0)%は【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】から【%NTR_GETPLACENAME(訪問者移動先)%】に移動した
        ENDIF
    ENDIF
        ;訪問者の現在位置更新
    FLAG:訪問者の現在位置 = 訪問者移動先
    FLAG:訪問者滞在時間カウンタ = 0
        ;訪問者移動時はムード等リセット
    CALL NTR_RESET_VISITOR_ACTION(-1)
ENDIF

;-------------------------------------------------------------------------------
;訪問者移動可否判定
;戻り値…1:移動する 0:移動しない
@CHK_VISITOR_MOVE
#DIM RET_MOVE
#DIM LOOP_CHR
#DIM 睡眠同室   ; 睡眠中の住人と同室 0:睡眠中の住人と同室ではない
#DIM 滞在フラグ ; 1:滞在 他:移動
    ;;肉便器系追加処理
    ;;人里プレイが開始したら、人里周辺へ移動。人里周辺に居るなら、移動しない。１時間経過してるとあなたの元へ
IF TALENT:MASTER:肉便器 && CFLAG:MASTER:WC_人里プレイ開始 > 0
    SELECTCASE FLAG:訪問者の現在位置
        CASE 場所_人間の里,場所_人間の里周辺
            SIF TIME_PROGRESS(CFLAG:MASTER:WC_人里プレイ開始) >= 90 && CFLAG:MASTER:WC_人里プレイ開始 != 0
                RETURN 1
            RETURN 0
        CASEELSE
            RETURN 1
    ENDSELECT
ENDIF
    ;;
    ;訪問者宅などの場合移動しない
SIF FLAG:訪問者の現在位置 == 0 || FLAG:訪問者の現在位置 == 場所_訪問者宅 || FLAG:訪問者の現在位置 == 901
    RETURN 0
SIF FLAG:1840 > 0 && FLAG:1840 < 9
    RETURN 0
    ;訪問者行動中であれば移動しない
SIF FLAG:訪問者との行為の終了時刻 != 0
    RETURN 0
睡眠同室 = 0
滞在フラグ = 0
FOR LOOP_CHR,0,CHARANUM
    IF FLAG:訪問者の現在位置 == CFLAG:LOOP_CHR:現在位置
        IF FLAG:訪問者の嫌いな相手 != 999 && LOOP_CHR == FLAG:訪問者の嫌いな相手
                ;嫌いなキャラが登録済み、居た場合
            滞在フラグ = 10
            BREAK
        ELSEIF CFLAG:LOOP_CHR:睡眠
            睡眠同室 = 1
            RETURN 0
        ELSEIF !IS_NTR_ATTACK_LOVER_ONLY() || (TALENT:LOOP_CHR:恋慕 || TALENT:LOOP_CHR:NTR)
            IF FLAG:訪問者のお気に入り != 999 && LOOP_CHR == FLAG:訪問者のお気に入り
                    ;お気に入りキャラ設定時、お気に入りキャラが居る時は移動なし
                RETURN 0
            ELSEIF FLAG:訪問者のお気に入り != 999 && LOOP_CHR != FLAG:訪問者のお気に入り
                    ;お気に入りキャラ設定時、お気に入りキャラが居ない時は移動あり
                    ;屈服度依存
                IF 滞在フラグ != 1
                    SELECTCASE CFLAG:LOOP_CHR:屈服度
                        CASE IS < 50
                            滞在フラグ = RAND:5 - 3
                        CASE IS < 300
                            滞在フラグ = RAND:4 - 2
                        CASE IS < 1000
                            滞在フラグ = RAND:3 - 1
                        CASE IS < 5000
                            滞在フラグ = RAND:2
                        CASEELSE
                            滞在フラグ = 1
                    ENDSELECT
                ENDIF
            ELSE
                    ;訪問者の現在位置に起きている誰かがいれば移動しない
                RETURN 0
            ENDIF
        ENDIF
    ENDIF
NEXT
    ;RET_MOVE…1:移動する 0:移動しない
RET_MOVE = 1
IF 滞在フラグ == 1
    RET_MOVE = 0
ENDIF
    ;現在位置を強制的に開錠
;FLAG:(300 + FLAG:訪問者の現在位置) = 0
    ;移動確率の判定 右辺のRAND:の数値が大きいと滞在時間が伸びる
SIF RAND:(TIME_PROGRESS(TFLAG:300) + 1) <= RAND:60
    RET_MOVE = 0
    ;最大滞在時間とのチェック。30分以上経過で移動
SIF FLAG:訪問者滞在時間カウンタ >= 30
    RET_MOVE = 1
    ;睡眠中の住人と同室であれば睡姦する可能性
SIF 睡眠同室
    RET_MOVE = 0
RETURN RET_MOVE

;-------------------------------------------------------------------------------
;訪問者移動先判定
;戻り値…訪問者の移動先
@JUDGE_VISITOR_MOVE_POS
#DIM RET_POS        ; 戻り値（場所)
#DIM RATE_ROOM, 場所番号最大値+1    ; 部屋ごとの確率
#DIM RATE_ROOM_MAX  ; その部屋に行く最大確率
#DIM RATE_MAX       ; 過去最大の確率
#DIM LOOP_POS       ; ループ変数(場所)
#DIM LOOP_I         ; ループ変数
#DIM RATE_WK        ; 移動確率判定用ワーク
RET_POS = 0
RATE_ROOM:0 = 0
RATE_MAX = 0
    ;;肉便器系追加処理
    ;;人里プレイが開始したら、人里周辺へ移動。人里周辺に居るなら、移動しない。１時間経過してるとあなたの元へ
IF TALENT:MASTER:肉便器 && CFLAG:MASTER:WC_人里プレイ開始 > 0
    SELECTCASE FLAG:訪問者の現在位置
        CASE 場所_人間の里,場所_人間の里周辺
            SIF TIME_PROGRESS(CFLAG:MASTER:WC_人里プレイ開始) >= 90 && CFLAG:MASTER:WC_人里プレイ開始 != 0
                RETURN CFLAG:MASTER:現在位置
        CASEELSE
                ;;同行フラグを解除しておく
            FLAG:訪問者同行フラグ = 0
            RETURN 場所_人間の里周辺
    ENDSELECT
ENDIF
    ;;
FOR LOOP_POS,1,MAXROOM()
        ; LOOP_POS…ループ変数「部屋番号」
        ; 初期化
    RATE_ROOM:LOOP_POS = 0
        ; 入れない場合はcontinue
    SIF CAN_MOVE(FLAG:訪問者の現在位置, LOOP_POS) == 0
        CONTINUE
        ;基本確率 / 施錠時は確率半減。 / 人数補正2.5％／人
    RATE_ROOM_MAX = (FLAG:(300 + LOOP_POS) ? 3000 # 10000) + CHK_TGT_IN_POS(LOOP_POS) * 250
        ;行きにくくしたい補正
        ;睡眠中、妊娠中の住人がいる部屋は確率半減
    SIF GET_ATTRIBUTE_OF_PERSON_IN_ROOM(LOOP_POS)
        RATE_ROOM_MAX /= 2
        ;嫌いなキャラが登録ずみ、居た場合確率1/4
    IF FLAG:訪問者の嫌いな相手 != 999 && LOOP_POS == CFLAG:(FLAG:訪問者の嫌いな相手):現在位置
        RATE_ROOM_MAX /= 4
    ENDIF
        ;住人がいない部屋は確率半減
    SIF CHK_TGT_IN_POS(LOOP_POS) == 0
        RATE_ROOM_MAX /= 2
        ;見えるけど直接行けない部屋は確率半減
    SIF CAN_MOVE(FLAG:訪問者の現在位置, LOOP_POS) > 1
        RATE_ROOM_MAX /= 2
    RATE_ROOM:LOOP_POS = RAND:RATE_ROOM_MAX + 1
        ;誰かいると移動確率が増える
        ;人数分だけループを回す
    FOR LOOP_I, 1, CHK_TGT_IN_POS(LOOP_POS)
        RATE_WK = RAND:RATE_ROOM_MAX + 1
        SIF RATE_ROOM:LOOP_POS < RATE_WK
            RATE_ROOM:LOOP_POS = RATE_WK
    NEXT
        ;正門にいるとき、広間への確率を多めに補正
    IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
        RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 2500
        SIF RATE_ROOM:LOOP_POS < RATE_WK
            RATE_ROOM:LOOP_POS = RATE_WK
    ENDIF
        ;気になる場所が設定されていて、今日は1度気になる場所に到達していて、気になる場所へ移動できる場合確率を多めに補正
    IF FLAG:訪問者の気になる場所 != 0 && FLAG:1832 >= 1 && FLAG:訪問者の現在位置 != FLAG:訪問者の気になる場所 && LOOP_POS == FLAG:訪問者の気になる場所 && GETBIT(FLAG:雑多設定, 4)
        RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 7500
        SIF RATE_ROOM:LOOP_POS < RATE_WK
            RATE_ROOM:LOOP_POS = RATE_WK
    ENDIF
        ;気になる場所が設定されていて、今日は一度も気になる場所に到達しておらず、お気に入りのキャラがあなたではない場合のみ
    IF FLAG:訪問者の気になる場所 != 0 && FLAG:1832 == 0 && FLAG:訪問者のお気に入り != 0
        SELECTCASE FLAG:訪問者の気になる場所
                    ;正門を除く広間に隣接した場所が気になる場合
            CASE 3,4,11,17,18,23
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;庭、屋外トイレ、厨房が気になる場合
            CASE 5,10,22
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == 場所_食堂
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_食堂 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;パチュリー私室、小悪魔私室が気になる場合
            CASE 7,8
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == 場所_図書室
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_図書室 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;二階廊下、レミリア私室が気になる場合
            CASE 12,16
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == 場所_二階踊り場
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_二階踊り場 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;咲夜私室、妖精メイド詰め所、あなた私室、2Fトイレが気になる場合
            CASE 13,14,15,24
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == 場所_二階踊り場
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_二階踊り場 && LOOP_POS == 場所_二階廊下
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_二階廊下 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;3Fテラスが気になる場合
            CASE 26
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_広間
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == 場所_二階踊り場
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_二階踊り場 && LOOP_POS == 場所_レミリア私室
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_レミリア私室 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;湖南部、魔法の森内部が気になる場合
            CASE 27,28
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_湖
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_湖 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;チルノの家、大妖精の家が気になる場合
            CASE 20,21
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_湖
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_湖 && LOOP_POS == 場所_湖南部
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_湖南部 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;魔理沙の家、ルーミアの住処、アリスの家が気になる場合
            CASE 25,29,30
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == 場所_湖
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_湖 && LOOP_POS == 場所_魔法の森内部
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ELSEIF FLAG:訪問者の現在位置 == 場所_魔法の森内部 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
                    ;正門に隣接した場所が気になる場合
            CASEELSE
                IF FLAG:訪問者の現在位置 == 場所_正門 && LOOP_POS == FLAG:訪問者の気になる場所
                    RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
                    SIF RATE_ROOM:LOOP_POS < RATE_WK
                        RATE_ROOM:LOOP_POS = RATE_WK
                ENDIF
        ENDSELECT
    ENDIF
        ;条件(女あなたがお気に入り + 女あなたが私室にいる + 訪問者が館内にいる)を満たしたらまっしぐら
    IF FLAG:訪問者のお気に入り == 0 && CFLAG:MASTER:現在位置 == 場所_あなた私室 && FLAG:1840 == 0
        IF (FLAG:訪問者の現在位置 == 場所_納屋 || FLAG:訪問者の現在位置 == 場所_守衛小屋 || FLAG:訪問者の現在位置 == 場所_庭 || FLAG:訪問者の現在位置 == 場所_屋外トイレ) && LOOP_POS == 場所_正門
            RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
            SIF RATE_ROOM:LOOP_POS < RATE_WK
                RATE_ROOM:LOOP_POS = RATE_WK
        ELSEIF (FLAG:訪問者の現在位置 == 場所_正門 || FLAG:訪問者の現在位置 == 場所_食堂) && LOOP_POS == 場所_広間
            RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
            SIF RATE_ROOM:LOOP_POS < RATE_WK
                RATE_ROOM:LOOP_POS = RATE_WK
        ELSEIF FLAG:訪問者の現在位置 == 場所_広間 && LOOP_POS == 場所_二階踊り場
            RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
            SIF RATE_ROOM:LOOP_POS < RATE_WK
                RATE_ROOM:LOOP_POS = RATE_WK
        ELSEIF FLAG:訪問者の現在位置 == 場所_二階踊り場 && LOOP_POS == 場所_二階廊下
            RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
            SIF RATE_ROOM:LOOP_POS < RATE_WK
                RATE_ROOM:LOOP_POS = RATE_WK
        ELSEIF FLAG:訪問者の現在位置 == 場所_二階廊下 && LOOP_POS == 場所_あなた私室
            RATE_WK = RAND:(RATE_ROOM_MAX + 7500) + 12500
            SIF RATE_ROOM:LOOP_POS < RATE_WK
                RATE_ROOM:LOOP_POS = RATE_WK
        ENDIF
    ENDIF
        ; 最大値更新？
    IF RATE_ROOM:LOOP_POS > RATE_MAX
        RATE_MAX = RATE_ROOM:LOOP_POS
        RET_POS = LOOP_POS
    ENDIF
    DEBUGPRINTFORML 移動確率 {LOOP_POS}：【%GETPLACENAME(LOOP_POS)%】→ {RATE_ROOM:LOOP_POS}／{RATE_ROOM_MAX}％、{CHK_TGT_IN_POS(LOOP_POS)}人在室
NEXT
SIF FLAG:訪問者同行フラグ
    RETURN CFLAG:MASTER:現在位置
RETURN RET_POS

;-------------------------------------------------------------------------------
;引数で指定した場所に住人がいるとその人数を返す。
;寝取られ寸前、寝取られそうの場合倍カウントとする。
;睡眠中の住人およびストライクゾーン未満の住人はカウントしない。
;戻り値…指定した場所にいる住人の人数
@CHK_TGT_IN_POS(場所)
#FUNCTION
#DIM 場所
#DIM RET_CNT    ; 戻り値カウンタ
#DIM LOOP_CHR   ; ループカウンタ（キャラ番号）
RET_CNT = 0
FOR LOOP_CHR,1,CHARANUM
        ; 訪問者「妊婦プレイは危険なの。」
    SIF CFLAG:LOOP_CHR:にんっしんっ > 0
        CONTINUE
        ; 訪問者「子供には興味はない。」
    SIF !NTR_CHK_STRIKE_ZONE(LOOP_CHR)
        CONTINUE
        ; 訪問者「カレシ持ちじゃないオンナには用はないッ！」
    SIF IS_NTR_ATTACK_LOVER_ONLY() && ! (TALENT:LOOP_CHR:恋慕 || TALENT:LOOP_CHR:NTR)
        CONTINUE
    IF CFLAG:(LOOP_CHR):現在位置 == 場所
            ;恋慕持ちは狙われやすい
        RET_CNT += TALENT:LOOP_CHR:恋慕
            ;人妻はさらに狙われやすい
        RET_CNT += TALENT:LOOP_CHR:人妻
            ;お気に入り補正
        IF FLAG:訪問者のお気に入り != 999 && LOOP_CHR == FLAG:訪問者のお気に入り
            RET_CNT += 2
        ENDIF
        IF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_寝取られ)
            RET_CNT += 1
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_寝取られ寸前)
            RET_CNT += 2
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_寝取られそう)
            RET_CNT += 2
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_主人より高い)
            RET_CNT += 3
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_うふふする程度)
            RET_CNT += 2
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_奉仕する程度)
            RET_CNT += 1
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_体を触らせる程度)
            RET_CNT += 1
        ELSEIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_キスする程度)
            RET_CNT += 1
        ELSE
            RET_CNT += 1
        ENDIF
    ENDIF
NEXT
RETURNF RET_CNT

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@VISITER_DO
#DIM LOOP_CHR

    ;ハーレム可否チェック
    CALL NTR_HARAM_ABLE
    IF RESULT
        CALL NTR_HARAM
        RETURN 0
    ENDIF
    ;誰かいないかチェック
    FOR LOOP_CHR,1,CHARANUM
        SIF !GETBIT(TALENT:LOOP_CHR:性別,0)
            CONTINUE
        IF CFLAG:LOOP_CHR:現在位置 == FLAG:訪問者の現在位置 && FLAG:訪問者の現在位置 != 場所_訪問者宅
                ;ストライクゾーン範囲外の時スキップ
            SIF !NTR_CHK_STRIKE_ZONE(LOOP_CHR)
                CONTINUE
                ;非恋慕住人が対象外のときスキップ
            IF IS_NTR_ATTACK_LOVER_ONLY() && !TALENT:LOOP_CHR:恋慕 && !TALENT:LOOP_CHR:NTR
                PRINTFORML %NTR_NAME(0)%は%CALLNAME:LOOP_CHR%と挨拶程度に言葉を交わした。
                CONTINUE
            ENDIF
            CALL NTR_ADD_SURRENDER(LOOP_CHR, TIME_PROGRESS(TFLAG:300))
                ;好感度吸収あり
            IF TALENT:LOOP_CHR:親愛 && CFLAG:LOOP_CHR:屈服度 > 500
                CALL NTR_DRAIN_LOVE(LOOP_CHR, 100)
            ENDIF       
            CALL NTR_DRAIN_LOVE(LOOP_CHR, TIME_PROGRESS(TFLAG:300))
            TRYCALL NTRPRINT_VISITOR_POINT(LOOP_CHR)
                ;寝取られ寸前（デバッグ用）
                ;IF CFLAG:LOOP_CHR:好感度 < 1000 && CFLAG:LOOP_CHR:屈服度 > CFLAG:LOOP_CHR:好感度 && TALENT:LOOP_CHR:恋慕 
                ;   PRINTFORMW %CALLNAME:LOOP_CHR%は陥落寸前だ…
                ;ENDIF
                CALL VISITER_FRIENDSHIP(LOOP_CHR)
        ELSEIF CFLAG:LOOP_CHR:現在位置 == 場所_訪問者宅 && FLAG:訪問者の現在位置 == 場所_訪問者宅
            CALL VISITER_TAKEOUT(LOOP_CHR)
        ELSE
            ; 同じ場所にいないときお不問者行為CNTをクリア
            CFLAG:LOOP_CHR:訪問者行為CNT = 0
        ENDIF
    NEXT
    SIF !TALENT:MASTER:肉便器
        TRYCALL NTR_COM416
RETURN 0

;-------------------------------------------------------------------------------
;MASTER含め訪問者と同じ部屋に居る人数を返す
;@param ARG:未使用
@GET_N_WITH_VISITER(ARG)
#FUNCTION
#DIM RET_CNT
#DIM LOOP_CHR
RET_CNT = 0
FOR LOOP_CHR,0,CHARANUM
    IF FLAG:訪問者の現在位置 == CFLAG:LOOP_CHR:現在位置
        RET_CNT ++
    ENDIF
NEXT
RETURNF RET_CNT

;-------------------------------------------------------------------------------
;引数で指定された場所に居る人の属性の総和を返す
;RESULT 1p1:妊娠
@GET_ATTRIBUTE_OF_PERSON_IN_ROOM(場所)
#FUNCTION
#DIM 場所
#DIM RET_CNT
#DIM LOOP_CHR
RET_CNT = 0
FOR LOOP_CHR,0,CHARANUM
    IF 場所 == CFLAG:LOOP_CHR:現在位置
        SIF CFLAG:LOOP_CHR:にんっしんっ
            RET_CNT |= 1p1
    ENDIF
NEXT
RETURNF RET_CNT

;-------------------------------------------------------------------------------
;デバッグプリント：住人の居場所
;@param NoUse
@DEBUGPRINT_あの人は何処に？()
#DIM LOOP_CHR
FOR LOOP_CHR,0,CHARANUM
    DEBUGPRINTFORML %CALLNAME:LOOP_CHR%は、{CFLAG:LOOP_CHR:現在位置}：【%GETPLACENAME(CFLAG:LOOP_CHR:現在位置)%】にいる。
NEXT
DEBUGPRINTFORML %NTR_NAME(0)%は、{FLAG:訪問者の現在位置}：【%GETPLACENAME(FLAG:訪問者の現在位置)%】にいる。
RETURN

;-------------------------------------------------------------------------------
;住民を口説きます
@VISITER_FRIENDSHIP(奴隷)
#DIM 奴隷
#DIM 同席人数       ;MASTER含め訪問者と同じ部屋に居る人数
#DIM 密室度         ;0:堂々 1:普通 2:個室 3:私室
#DIM ムード上限値
#DIM お持ち帰り     ;0:なし 1:あり

同席人数 = GET_N_WITH_VISITER(1)
IF 同席人数 == 2 && CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
    IF IS_AIR_MASTER(奴隷) < FLAG:訪問者のムード && 354 != PREVCOM
            ; MASTERによる「そこまでよ」
            ; [354]邪魔しない選択時は継続
        CALL NTR_RESET_VISITOR_ACTION(奴隷)
    ENDIF
ELSEIF 同席人数 > 1
        ; ハーレム判定に失敗しているので、多人数ならリセット
    CALL NTR_RESET_VISITOR_ACTION(奴隷)
ENDIF
    ;デバッグ用
    ;PRINTFORML 
    ;PRINTFORML ムード    ：{FLAG:訪問者のムード}
    ;PRINTFORML 終了時間  ：{FLAG:訪問者との行為の終了時刻}
    ;PRINTFORML 行為      ：{FLAG:訪問者との行為}
    ;PRINTFORML 行為CNT：{CFLAG:奴隷:訪問者行為CNT}
    ;PRINTFORML カウンター：{CFLAG:奴隷:NTRカウンターセクハラ}
    ;PRINTFORML 
CFLAG:奴隷:訪問者行為CNT += 1
密室度 = GET_ROOM_SECURITY(FLAG:訪問者の現在位置)
IF FLAG:訪問者のムード == 0
        ;条件を満たしていくと行動の選択肢が増える
    IF CFLAG:奴隷:睡眠 && 同席人数 == 1 && IS_NTR_SLEEP_RAPE()
            ;PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の部屋の鍵を開け、部屋に侵入した後鍵を掛けた
        FLAG:睡姦フラグ = 1
    ENDIF
    CALL JUDGE_VISITOR_MOOD_MAX(奴隷, 密室度, 同席人数)
    ムード上限値 = RESULT
        ;ムード上限値 = MAX(1, ムード上限値)
        ;NTRカウンター実行時それに応じる
    IF CFLAG:奴隷:NTRカウンターセクハラ && CFLAG:奴隷:にんっしんっ == 0
        CALL NTR_COUNTER_COUNTER(奴隷, ムード上限値)
        FLAG:訪問者のムード = RESULT
            ;覗きバレ後の行為エスカレート補正はNTR_COUNTER_COUNTER内で処理
    ELSE
        FLAG:訪問者のムード = RAND:(ムード上限値+1)
            ;覗きバレ後は行為エスカレート
        IF !IS_NTR_SOFT() || NTR_CHK_FAVORABLY(奴隷, FAV_主人より高い)
            IF CFLAG:奴隷:覗き発覚回数 && FLAG:訪問者のムード < 2
                FLAG:訪問者のムード += 1
            ENDIF
            IF CFLAG:奴隷:覗き発覚回数 > 7 && FLAG:訪問者のムード < 5
                FLAG:訪問者のムード += 3
            ELSEIF CFLAG:奴隷:覗き発覚回数 > 5 && FLAG:訪問者のムード < 4
                FLAG:訪問者のムード += 2
            ELSEIF CFLAG:奴隷:覗き発覚回数 > 3 && FLAG:訪問者のムード < 3
                FLAG:訪問者のムード += 1
            ENDIF
        ENDIF
    ENDIF
ENDIF
;訪問者行為CNTに基づく訪問者のムード上限再判定
CALL JUDGE_VISITOR_MOOD_MAX_LIMIT(奴隷, FLAG:訪問者のムード)
FLAG:訪問者のムード = RESULT
    ;好感度が高く、私室に居る場合は施錠
IF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 && 密室度 >= 3 && IS_CAN_LOCK(FLAG:訪問者の現在位置)
    IF TALENT:奴隷:浮気公認 >= 浮気_性交公認
        IF !isLocked(CFLAG:奴隷:現在位置)
            IF tryLock(奴隷, CFLAG:奴隷:現在位置)
                IF CAN_MOVE(CFLAG:MASTER:現在位置, FLAG:訪問者の現在位置) == 2 || IS_NTR_SHOW_ALL()
                    PRINTFORML %CALLNAME:奴隷 + "は" + NTR_NAME(0) + "との一時を邪魔されないように、【" + NTR_GETPLACENAME(FLAG:訪問者の現在位置) + "】の扉に閂をかけようとしたが、"%
                    PRINTFORML %MSG_RE_LOVER(奴隷) + "が他の男に抱かれて喜ぶ" + CALLNAME:MASTER + "のためにと、閂は外して普通の鍵をかけておいた。"%
                ENDIF
            ENDIF
        ENDIF
    ELSE
        IF !isLocked(CFLAG:奴隷:現在位置)
            IF RAND(CFLAG:奴隷:屈服度) > CFLAG:奴隷:好感度
                IF tryLockBolt(奴隷, CFLAG:奴隷:現在位置)
                    IF CAN_MOVE(CFLAG:MASTER:現在位置, FLAG:訪問者の現在位置) == 2 || IS_NTR_SHOW_ALL()
                        PRINTFORML %CALLNAME:奴隷 + "は" + NTR_NAME(0) + "との一時を邪魔されないように、【" + NTR_GETPLACENAME(FLAG:訪問者の現在位置) + "】の扉に閂をかけた。"%
                    ENDIF
                ENDIF
            ELSE
                IF tryLock(奴隷, CFLAG:奴隷:現在位置) 
                    IF CAN_MOVE(CFLAG:MASTER:現在位置, FLAG:訪問者の現在位置) == 2 || IS_NTR_SHOW_ALL()
                        PRINTFORML %CALLNAME:奴隷 + "は" + NTR_NAME(0) + "との一時を邪魔されないように、【" + NTR_GETPLACENAME(FLAG:訪問者の現在位置) + "】の扉に鍵をかけた。"%
                    ENDIF
                ENDIF
            ENDIF
        ENDIF
    ENDIF
ENDIF
IF CFLAG:奴隷:屈服度 < 100 || DAY < 2 || CFLAG:奴隷:にんっしんっ > 0
        ; さほど親しくなければリセット
    CALL NTR_RESET_VISITOR_ACTION(奴隷)
ENDIF
お持ち帰り = 0
    ; お持ち帰り判定。お持ち帰り有効かつ睡眠中でない場合のみ
IF 同席人数 == 1 && IS_NTR_TAKINGOUT_ENABLE() && CFLAG:奴隷:NTR野外調教 == 0 && !CFLAG:奴隷:睡眠
        ;親愛持ちを連れ去る
    IF TALENT:奴隷:親愛 && BASE:奴隷:体力 < 700
        IF TALENT:奴隷:公衆便所 
            PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の耳元で『仕事』の時間だと囁いた。
            PRINTFORML 逆らうならその首輪に鎖をつけて犬のように引きずって晒し者にすると脅された%CALLNAME:奴隷%は
            PRINTFORMW 悔しさにうつむきながら%NTR_KARE()%に同行していった・・
        ELSE
            PRINTFORMW 中々屈服しない%CALLNAME:奴隷%に憤慨した%NTR_NAME(0)%は%CALLNAME:奴隷%を縛り付け、連れ攫ったようだ・・・
        ENDIF
        CALL VISITER_TAKINGOUT(奴隷)
        お持ち帰り = 1
    ENDIF
        ;二人きりで寝取り返し寸前の時、1/2でバレて再教育
    IF NTR_CHK_FAVORABLY(奴隷, FAV_寝取り返し寸前) && RAND:2
        PRINTFORMW %NTR_NAME(0)%は%CALLNAME:奴隷%の態度から、彼女をより快楽漬けにする必要があると考えた。
        FLAG:再教育フラグ = 1
        CALL VISITER_TAKINGOUT(奴隷)
        お持ち帰り = 1
        ;お持ち帰り条件を満たしている（二人きり＆堂々とした場所＆キス許容以上のムード）
        ;会話の場合は、通常の分岐側に移動したよ。
    ELSEIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 && 密室度 == 0 && FLAG:訪問者のムード > 0 
            ;好感度が"あなた"より高ければお持ち帰り
        CALL VISITER_TAKINGOUT(奴隷)
        お持ち帰り = 1
    ENDIF
ENDIF
    ;その他の状態で行動中か行動が未決定(終了時間が0なら未決定とする)
IF 0 == お持ち帰り
        ;訪問者が待機（行動終了状態）の場合。
    IF FLAG:訪問者との行為の終了時刻 == 0
        CALL VISITER_FRIENDSHIP_START(奴隷, 密室度)
            ;訪問者が行動中（行動終了時刻に満たない）の場合。
    ELSEIF FLAG:訪問者との行為の終了時刻 > DATETIME()
        CALL VISITER_FRIENDSHIP_CONT(奴隷, 密室度)
            ;訪問者が行動完了（行動終了時刻に到達した）の場合。
    ELSE
        CALL VISITER_FRIENDSHIP_FINISH(奴隷)
    ENDIF
ENDIF
TRYCALL NTRPRINT_VISITOR_STATE
    ;睡姦実行
CALL VISITER_FRIENDSHIP_SLEEP(奴隷)
    ;あなたが訪問者の行為対象者と同じ場所にいない時に限り実行
SIF CFLAG:MASTER:現在位置 != CFLAG:奴隷:現在位置
    CALL EXP_GOT_CHECK(奴隷)

;-------------------------------------------------------------------------------
;密室度取得
;戻り値…密室度 ;0:堂々 1:普通 2:個室 3:私室)
@GET_ROOM_SECURITY(場所)
#FUNCTION
#DIM 場所
#DIM 密室度
密室度 = 0
SELECTCASE 場所
            ; 堂々とした場所
    CASE 場所_正門, 場所_広間, 場所_食堂, 場所_二階踊り場, 場所_妖精メイド詰め所, 場所_3Fテラス
        密室度 = 0
            ;あまり堂々としていない場所(正門, 広間, 食堂, 二階踊り場以外. 庭と湖はロマン)なら密室度:3を1に
    CASE 場所_二階廊下, 場所_あなた私室, 場所_大浴場, 場所_魔法の森内部
        密室度 = 1
            ;さらに目立たない場所(死角のある場所や個室等…主観ですが)なら密室度:3を2に
    CASE 場所_図書室, 場所_厨房, 場所_納屋, 場所_庭, 場所_湖 , 場所_湖南部
        密室度 = 2
            ; 個室
    CASE 場所_パチュリー私室, 場所_小悪魔私室, 場所_守衛小屋, 場所_咲夜私室, 場所_レミリア私室, 場所_地下室
        密室度 = 3
    CASE 場所_チルノの家, 場所_大妖精の家, 場所_魔理沙の家, 場所_ルーミアの住処, 場所_アリスの家
        密室度 = 3
            ; トイレ
    CASE 場所_屋外トイレ, 場所_1Fトイレ, 場所_2Fトイレ
        密室度 = 2
            ; Lv1が少ない ;-(
ENDSELECT
RETURNF 密室度

;-------------------------------------------------------------------------------
;訪問者のムード上限値判定
;戻り値…訪問者のムード上限値
@JUDGE_VISITOR_MOOD_MAX(奴隷, 密室度, 同席人数)
#DIM 奴隷
#DIM 密室度
#DIM 同席人数
#DIM ムード上限値
ムード上限値 = 0
    ;訪問者と住民が二人きりまたは主人空気化（屈服度高いとき？）
IF 同席人数 == 1 || (同席人数 == 2 && CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 && IS_AIR_MASTER(奴隷))
    SIF NTR_CHK_FAVORABLY(奴隷, FAV_キスする程度)
        ムード上限値 += 1
        ;堂々としていない場所
    IF 密室度 > 0
        SIF NTR_CHK_FAVORABLY(奴隷, FAV_体を触らせる程度)
            ムード上限値 += 1
            ;さらに目立たない場所または私室
        IF 密室度 >= 2
            SIF NTR_CHK_FAVORABLY(奴隷, FAV_奉仕する程度)
                ムード上限値 += 1
            SIF NTR_CHK_FAVORABLY(奴隷, FAV_うふふする程度)
                ムード上限値 += 1
        ENDIF
    ENDIF
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        ムード上限値 += 1
    SIF CFLAG:奴隷:屈服度 > 500
        ムード上限値 += 1
        ;浮気を公認している場合
    ムード上限値 += TALENT:奴隷:浮気公認
        ;和姦モード時は抑える
    IF IS_NTR_SOFT()
        IF TALENT:奴隷:公衆便所
                ; 制限なし
        ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ)
                ; 制限なし
        ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ寸前)
                ; 制限なし
        ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られそう)
                ; 制限なし
        ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_主人より高い)
                ; 奉仕が上限
            ムード上限値 = LIMIT(ムード上限値-2, NTR_MOOD_会話, NTR_MOOD_奉仕)
        ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_うふふする程度2)
                ; 愛撫が上限
            ムード上限値 = LIMIT(ムード上限値-2, NTR_MOOD_会話, NTR_MOOD_愛撫)
        ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_うふふする程度)
                ; キスが上限
            ムード上限値 = LIMIT(ムード上限値-2, NTR_MOOD_会話, NTR_MOOD_キス)
        ELSE
                ; これ以下はキスもしない
            ムード上限値 = NTR_MOOD_会話
        ENDIF
    ENDIF
ELSE
    CALL NTR_RESET_VISITOR_ACTION(奴隷)
ENDIF
RETURN ムード上限値


;-------------------------------------------------------------------------------
;訪問者行為CNTに基づく訪問者のムード上限値再判定
;戻り値…訪問者のムード上限値
@JUDGE_VISITOR_MOOD_MAX_LIMIT(奴隷, ムード上限値)
#DIM 奴隷
#DIM ムード上限値

    SELECTCASE CFLAG:奴隷:訪問者行為CNT
    CASE 0, 1
        ; 初手の上限は会話
        ムード上限値 = MIN(ムード上限値, NTR_MOOD_会話)
    CASE 2
        ; 二手目の上限はキス
        ムード上限値 = MIN(ムード上限値, NTR_MOOD_キス)
    CASE 3
        ; 三手目の上限は愛撫
        ムード上限値 = MIN(ムード上限値, NTR_MOOD_愛撫)
    ENDSELECT
RETURN ムード上限値


;-------------------------------------------------------------------------------
;訪問者の行為開始
@VISITER_FRIENDSHIP_START(奴隷, 密室度)
#DIM 奴隷
#DIM 密室度
#DIM 訪問者ムード
訪問者ムード = FLAG:訪問者のムード
    ; お持ち帰りフラグがない場合、ムードLv5は抑制する。;副作用が怖いのでローカル変数で。
IF IS_NTR_TAKINGOUT_ENABLE() == 0
    訪問者ムード = MIN(訪問者ムード, NTR_MOOD_性交)
ELSE
    訪問者ムード = MIN(訪問者ムード, NTR_MOOD_同伴)
ENDIF
    ;浮気公認状態で見せつけることにしていた場合、見せつけるために結構な確率で持ち帰りを防いでくれる
IF (TALENT:奴隷:浮気公認 == 浮気_性交公認) && ( 100 < RAND:(CFLAG:奴隷:好感度) )
    訪問者ムード = MIN(訪問者ムード, NTR_MOOD_性交)
ENDIF
IF CFLAG:奴隷:睡眠
    訪問者ムード = 0
ENDIF
IF CFLAG:奴隷:自慰中 && !TALENT:奴隷:訪問者への弱み && !CFLAG:奴隷:睡眠
        ; 自慰目撃による弱み獲得
    CALL NTR_GET_WEAKNESS_1(奴隷)
ELSEIF RAND:100 < 30 && CFLAG:奴隷:自慰中 && TALENT:奴隷:訪問者への弱み && !CFLAG:奴隷:NTR野外調教  && !CFLAG:奴隷:睡眠
        ; 弱みを握られた状態で自慰を目撃されるとNTR野外調教開始
    SIF IS_NTR_EXHIBITION()
        CALL NTR_EXHIBITION_START(奴隷)
ELSEIF RAND:100 < 5 && TALENT:奴隷:訪問者への弱み && !CFLAG:奴隷:NTR野外調教 && !CFLAG:奴隷:睡眠 
        ; 弱みを握られた状態で5%でNTR野外調教開始
    SIF IS_NTR_EXHIBITION()
        CALL NTR_EXHIBITION_START(奴隷)
ENDIF
IF CFLAG:奴隷:NTR野外調教 && !CFLAG:奴隷:睡眠
        ; 訪問者による野外調教実行
    CALL NTR_EXHIBITION(奴隷)
ELSE
        ;NTR野外調教ではない
    SELECTCASE 訪問者ムード
        CASE NTR_MOOD_会話
            $SELECT_CASE_ELSE
                ; 行動選択→会話
            IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 && !CFLAG:奴隷:睡眠
                    ;会話（主人同席）
                CALL NTR_MESSAGE_1_1(奴隷)
                CALL NTR_RESET_VISITOR_ACTION(奴隷)
                TRYCALLLIST
                    FUNC NTR_KOJO_KW{CFLAG:奴隷:297}_1(奴隷)
                    FUNC NTR_KOJO_KW_1(奴隷)
                ENDFUNC
            ELSEIF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置) && !CFLAG:奴隷:睡眠
                    ;会話（主人不在）
                CALL NTR_MESSAGE_1_0(奴隷)
                CALL NTR_RESET_VISITOR_ACTION(奴隷)
                TRYCALLLIST 
                    FUNC NTR_KOJO_K{CFLAG:奴隷:297}_1(奴隷)
                    FUNC NTR_KOJO_K_1(奴隷)
                ENDFUNC
            ENDIF
            CALL NTR_COUNTER(奴隷)
        CASE NTR_MOOD_キス
                ; 行動選択→キス
            CALL NTR_KISS(奴隷)
            CFLAG:奴隷:NTRカウンターセクハラ = NTR_CNT_なし
        CASE NTR_MOOD_愛撫
                ; 行動選択→愛撫
                ;前回住人がNTRカウンターで胸を揉ませていた場合胸愛撫
            IF CFLAG:奴隷:NTRカウンターセクハラ == NTR_CNT_胸を揉ませる
                CALL NTR_BUST_PET(奴隷)
                    ;前回住人がNTRカウンターでスカートの中身を見せていた場合愛撫
            ELSEIF CFLAG:奴隷:NTRカウンターセクハラ == NTR_CNT_スカートの中を見せる
                CALL NTR_PET(奴隷)
                    ;その他
            ELSE
                IF RAND:2 == 0
                        ;愛撫
                    CALL NTR_PET(奴隷)
                ELSE
                        ;胸愛撫
                    CALL NTR_BUST_PET(奴隷)
                ENDIF
            ENDIF
            CFLAG:奴隷:NTRカウンターセクハラ = NTR_CNT_なし
        CASE NTR_MOOD_奉仕
                ; 行動選択→奉仕
            IF 密室度 != 3  && CFLAG:奴隷:現在位置 != 場所_納屋
                CALL VISITOR_GOWITH_ROOM(奴隷)
            ENDIF
                ;前回住人がNTRカウンターで股間をまさぐっていた場合フェラチオ
            IF CFLAG:奴隷:NTRカウンターセクハラ == NTR_CNT_股間をまさぐる
                CALL NTR_FELLATIO(奴隷)
                    ;前回住人がNTRカウンターでディープキスした場合フェラチオか69
            ELSEIF CFLAG:奴隷:NTRカウンターセクハラ == NTR_CNT_ディープキス
                IF RAND:2
                    CALL NTR_FELLATIO(奴隷)
                ELSE
                    CALL NTR_69(奴隷)
                ENDIF
                    ;その他
            ELSE
                IF RAND:3 == 0
                    CALL NTR_FELLATIO(奴隷)
                ELSEIF RAND:2 == 1
                    CALL NTR_69(奴隷)
                ELSE
                    CALL NTR_THUG(奴隷)
                ENDIF
            ENDIF
            CFLAG:奴隷:NTRカウンターセクハラ = NTR_CNT_なし
        CASE NTR_MOOD_性交
                ; 行動選択→性交(お持ち帰り抑制時も)に成功
            IF 密室度 != 3  && CFLAG:奴隷:現在位置 != 場所_納屋
                CALL VISITOR_GOWITH_ROOM(奴隷)
            ENDIF
            IF IS_NTR_KEEP_VIRGIN() && TALENT:奴隷:処女
                    ;処女アナル厨の時はアナル貫通の閾値が低い
                IF EXP:奴隷:Ａ経験 > 20
                    CALL NTR_A_SEX(奴隷, 密室度)
                ELSE
                        ;条件を満たしていない時は69で我慢
                    CALL NTR_69(奴隷)
                ENDIF
            ELSEIF RAND:4 == 0 && EXP:奴隷:Ａ経験 > 80
                CALL NTR_A_SEX(奴隷, 密室度)
            ELSE
                CALL NTR_SEX(奴隷, 密室度)
            ENDIF
            CFLAG:奴隷:NTRカウンターセクハラ = NTR_CNT_なし
        CASE NTR_MOOD_同伴
                ; 行動選択→お持ち帰り
                ;好感度が"あなた"より高ければお持ち帰り
            CALL VISITER_TAKINGOUT(奴隷)
        CASEELSE
            GOTO SELECT_CASE_ELSE
    ENDSELECT
ENDIF

;-------------------------------------------------------------------------------
;納屋、私室に同行
@VISITOR_GOWITH_ROOM(奴隷)
#DIM 奴隷
#DIM 誘いフラグ     ; 0:訪問者が連行　1:住人が誘惑
誘いフラグ = 0
    ;寝取られだと私室に誘う/ここぁは例外(メッセージが異なるため)
IF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ) && 奴隷 != 7 && RAND:4 == 0
    FLAG:訪問者の現在位置 = GET_PRIVATE_ROOM(奴隷, 1)
    FLAG:訪問者同行フラグ = 0
    誘いフラグ = 1
    IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%を【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】に誘ったようだ
    ENDIF
        ;寝取られ寸前、寝取られそうだと私室に誘う/ここぁは例外(メッセージが異なるため)
ELSEIF (NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ寸前) || NTR_CHK_FAVORABLY(奴隷, FAV_寝取られそう) || NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ)) && 奴隷 != 7 && RAND:3 > 0
    IF FLAG:訪問者のお気に入りの場所 > 0 && RAND:3 > 0
            ;お気に入りあれば移動
        FLAG:訪問者の現在位置 = FLAG:訪問者のお気に入りの場所
        FLAG:訪問者同行フラグ = 0
        誘いフラグ = 0
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORMW %NTR_NAME(0)%は%CALLNAME:奴隷%を【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】に誘ったようだ
            PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%に大人しく従ったようだ。
        ENDIF
    ELSE
        FLAG:訪問者の現在位置 = GET_PRIVATE_ROOM(奴隷, 1)
        FLAG:訪問者同行フラグ = 0
        誘いフラグ = 1
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            IF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ寸前) || TALENT:奴隷:浮気公認
                PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%を【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】に誘ったようだ
            ELSE
                PRINTFORMW %CALLNAME:奴隷%はこっそり%NTR_NAME(0)%を【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】に誘ったようだ
            ENDIF
        ENDIF
    ENDIF
        ;そうでなければ納屋へ/ここぁは常にこっち
ELSE
    IF FLAG:訪問者のお気に入りの場所 > 0 && RAND:3 > 0
            ;お気に入りあれば移動
        FLAG:訪問者の現在位置 = FLAG:訪問者のお気に入りの場所
        FLAG:訪問者同行フラグ = 0
    ELSE
        FLAG:訪問者の現在位置 = 場所_納屋
        FLAG:訪問者同行フラグ = 0
    ENDIF
    IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        PRINTFORMW %NTR_NAME(0)%は%CALLNAME:奴隷%を【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】に連れて行ったようだ
    ENDIF
ENDIF
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_11(奴隷, 誘いフラグ)
        FUNC NTR_KOJO_K_11(奴隷, 誘いフラグ)
    ENDFUNC
ENDIF
CFLAG:奴隷:現在位置 = FLAG:訪問者の現在位置
FLAG:訪問者滞在時間カウンタ = 0
    ;同行解除
CFLAG:奴隷:同行 = 0

;-------------------------------------------------------------------------------
;訪問者の行為継続
@VISITER_FRIENDSHIP_CONT(奴隷, 密室度)
#DIM 奴隷
#DIM 密室度
SELECTCASE FLAG:訪問者との行為
    CASE NTR_行為_キス
        CALL NTR_KISS(奴隷)
    CASE NTR_行為_愛撫
        CALL NTR_PET(奴隷)
    CASE NTR_行為_胸愛撫
        CALL NTR_BUST_PET(奴隷)
    CASE NTR_行為_フェラチオ
        CALL NTR_FELLATIO(奴隷)
    CASE NTR_行為_シックスナイン
        CALL NTR_69(奴隷)
    CASE NTR_行為_素股
        CALL NTR_THUG(奴隷)
    CASE NTR_行為_Ｖ正常位 TO NTR_行為_Ｖ背面立位
        CALL NTR_SEX(奴隷, 密室度)
    CASE NTR_行為_Ａ正常位 TO NTR_行為_Ａ背面立位
        CALL NTR_A_SEX(奴隷, 密室度)
ENDSELECT
CFLAG:奴隷:NTRカウンターセクハラ = NTR_CNT_なし

;-------------------------------------------------------------------------------
;訪問者の行為終了
@VISITER_FRIENDSHIP_FINISH(奴隷)
#DIM 奴隷
#DIM カウンター     ;1:カウンターセクハラ実行 0:実行しない
カウンター = 0
SELECTCASE FLAG:訪問者との行為
    CASE NTR_行為_キス
        CALL NTR_KISS_FINISH(奴隷)
        カウンター = 1
    CASE NTR_行為_愛撫
        CALL NTR_PET_FINISH(奴隷)
    CASE NTR_行為_胸愛撫
        CALL NTR_BUST_PET_FINISH(奴隷)
    CASE NTR_行為_フェラチオ
        CALL NTR_FELLATIO_FINISH(奴隷)
    CASE NTR_行為_シックスナイン
        CALL NTR_69_FINISH(奴隷)
    CASE NTR_行為_素股
        CALL NTR_THUG_FINISH(奴隷)
    CASE NTR_行為_Ｖ正常位 TO NTR_行為_Ｖ背面立位
        CALL NTR_SEX_FINISH(奴隷)
    CASE NTR_行為_Ａ正常位 TO NTR_行為_Ａ背面立位
        CALL NTR_A_SEX_FINISH(奴隷)
ENDSELECT
CALL NTR_RESET_VISITOR_ACTION(奴隷)
CFLAG:奴隷:NTRカウンターセクハラ = NTR_CNT_なし
IF カウンター == 1
    CALL NTR_COUNTER(奴隷)
ENDIF

;-------------------------------------------------------------------------------
;睡姦実行
@VISITER_FRIENDSHIP_SLEEP(奴隷)
#DIM 奴隷
IF FLAG:睡姦フラグ == 1
    IF CFLAG:奴隷:睡眠
        IF CFLAG:奴隷:覚醒 == 10
            PRINTFORMW %CALLNAME:奴隷%が目を覚ましそうなので%NTR_NAME(0)%は行為を中断した
            CFLAG:奴隷:覚醒 = 0
        ELSEIF CFLAG:奴隷:挿入 == 1
            PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の膣にペニスをゆっくりと挿入した
            EXP:奴隷:Ｖ経験 ++
            EXP:奴隷:被睡姦経験 ++
            SOURCE:奴隷:情愛 = 100
            SOURCE:奴隷:性行動 = 300
            CFLAG:奴隷:性欲 += 10
            CFLAG:奴隷:挿入 += 1
            IF RAND:3 < 1
                CFLAG:奴隷:覚醒 += 1
            ENDIF
            IF TALENT:奴隷:処女
                PRINTFORMW %CALLNAME:奴隷%は自分でも気がつかないうちに処女を散らされてしまった
                CALL LOST_VIRGIN(奴隷, 人物_訪問者)
                CUP:奴隷:苦痛 += 500
                CFLAG:奴隷:覚醒 += 2
ENDIF       
                IF 訪問者_Ｐ大きさ == 2
                    EXP:奴隷:Ｖ拡張経験 += 1
                    SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
                        PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
                    IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
                        CUP:奴隷:欲情 += 500
                        CUP:奴隷:苦痛 += 250
                    ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
                        CUP:奴隷:苦痛 += 500
                    ENDIF
                    CFLAG:奴隷:覚醒 += 1
                ENDIF
            ELSEIF CFLAG:奴隷:挿入 == 2
                PRINTFORMW %NTR_NAME(0)%はゆっくりと腰を動かしている
                EXP:奴隷:Ｖ経験 ++
                EXP:奴隷:被睡姦経験 ++
                SOURCE:奴隷:情愛 = 100
                SOURCE:奴隷:性行動 = 300
                CFLAG:奴隷:性欲 += 10
                IF RAND:10 < 2
                    CFLAG:奴隷:覚醒 += 1
                    CFLAG:奴隷:挿入 += 1
                ENDIF
                IF 訪問者_Ｐ大きさ == 2
                    EXP:奴隷:Ｖ拡張経験 += 1
                    SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
                        PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
                    IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
                        CUP:奴隷:欲情 += 500
                        CUP:奴隷:苦痛 += 250
                    ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
                        CUP:奴隷:苦痛 += 500
                    ENDIF
                    CFLAG:奴隷:覚醒 += 1
                ENDIF
            ELSEIF CFLAG:奴隷:挿入 == 3
                PRINTFORMW %NTR_NAME(0)%が射精すると、%CALLNAME:奴隷%は無意識のうちに訪問者に抱き付いた
                PRINTFORMW %NTR_NAME(0)%は再び腰を振り始めた
                EXP:奴隷:Ｖ経験 ++
                EXP:奴隷:被睡姦経験 ++
                SOURCE:奴隷:情愛 = 100
                SOURCE:奴隷:性行動 = 300
                CFLAG:奴隷:性欲 += 10
                CFLAG:奴隷:挿入 -= 1
                CALL EJACULATION_V(奴隷, 人物_訪問者)
                IF 訪問者_Ｐ大きさ == 2
                    EXP:奴隷:Ｖ拡張経験 += 1
                    SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
                        PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
                    IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
                        CUP:奴隷:欲情 += 500
                        CUP:奴隷:苦痛 += 250
                    ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
                        CUP:奴隷:苦痛 += 500
                    ENDIF
                    CFLAG:奴隷:覚醒 += 1
                ENDIF
            ELSEIF CFLAG:奴隷:NTR睡姦 > 3
                IF RAND:70 < 15
                    PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の口に男根をねじ込んだ
                    EXP:奴隷:被睡姦経験 ++
                    EXP:奴隷:精飲経験 ++
                    SOURCE:奴隷:情愛 = 100
                    SOURCE:奴隷:性行動 = 300
                    CFLAG:奴隷:性欲 += 10
                ELSEIF RAND:70 < 30
                    PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の股間に性器を擦り付けている
                    EXP:奴隷:Ｃ経験 ++
                    EXP:奴隷:被睡姦経験 ++
                    EXP:奴隷:精液経験 ++
                    SOURCE:奴隷:快Ｃ = 180
                    SOURCE:奴隷:情愛 = 100
                    SOURCE:奴隷:性行動 = 300    
                    CFLAG:奴隷:性欲 += 10
                    IF RAND:10 > 7
                        CFLAG:奴隷:覚醒 += 1
                    ELSE 
                        IF IS_NTR_KEEP_VIRGIN() && TALENT:奴隷:処女
                            ;処女アナル厨の時は見逃してもらえる
                        ELSE
                            CFLAG:奴隷:挿入 += 1
                        ENDIF
                    ENDIF
                ELSEIF RAND:70 < 50
                    PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の菊門に性器をぐりぐりと押し付けている
                    EXP:奴隷:Ａ経験 ++
                    EXP:奴隷:被睡姦経験 ++
                    EXP:奴隷:精液経験 ++
                    SOURCE:奴隷:快Ａ = 180
                    SOURCE:奴隷:情愛 = 100
                    SOURCE:奴隷:性行動 = 300
                    CFLAG:奴隷:性欲 += 10
                ELSEIF !CFLAG:奴隷:服装_下半身下着２
                    PRINTFORMW %NTR_NAME(0)%は%CALLNAME:奴隷%が寝ているのをいいことに%CALLNAME:奴隷%の裸を撮影している
                    EXP:奴隷:被写経験 ++
                    EXP:奴隷:ポルノ経験 ++
                ELSE
                    PRINTFORMW %NTR_NAME(0)%は%CALLNAME:奴隷%の下着を脱がせ、自分のポケットに押し込んだ
                    CFLAG:奴隷:服装_下半身下着２ = 0
                    EXP:奴隷:ポルノ経験 ++
                ENDIF
            ELSEIF RAND:100 < 20
                SIF RAND:3 < 1
                    CFLAG:奴隷:NTR睡姦 += 1
                PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の唇を塞いだ
                EXP:奴隷:キス経験 ++
                SOURCE:奴隷:情愛 = 10
                SOURCE:奴隷:性行動 = 20
                CFLAG:奴隷:性欲 += 5
                CALL LOST_VIRGIN_M(奴隷, 人物_訪問者)
            ELSEIF RAND:100 < 40
                SIF RAND:3 < 2
                    CFLAG:奴隷:NTR睡姦 += 1
                PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の胸を揉みしだいている
                EXP:奴隷:Ｂ経験 ++
                SOURCE:奴隷:快Ｂ = 80
                SOURCE:奴隷:情愛 = 50
                SOURCE:奴隷:性行動 = 60
                SOURCE:奴隷:露出 = 20
                CFLAG:奴隷:性欲 += 5
            ELSEIF RAND:100 < 60
                SIF RAND:3 < 2
                    CFLAG:奴隷:NTR睡姦 += 1
                PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の股間を愛撫している
                EXP:奴隷:Ｃ経験 ++
                SOURCE:奴隷:快Ｃ = 80
                SOURCE:奴隷:情愛 = 50
                SOURCE:奴隷:性行動 = 60
                SOURCE:奴隷:露出 = 20
                CFLAG:奴隷:性欲 += 5
            ELSEIF RAND:100 < 80
                CFLAG:奴隷:NTR睡姦 += 1
                PRINTFORMW %NTR_NAME(0)%は眠っている%CALLNAME:奴隷%の菊門を舐め解している
                EXP:奴隷:Ａ経験 ++
                SOURCE:奴隷:快Ａ = 80
                SOURCE:奴隷:情愛 = 100
                SOURCE:奴隷:性行動 = 160
                SOURCE:奴隷:露出 = 40
                CFLAG:奴隷:性欲 += 5
            ENDIF
            IF CFLAG:奴隷:覚醒 >= 7
                PRINTFORMW %CALLNAME:奴隷%は目を覚ましそうだ
            ELSEIF CFLAG:奴隷:覚醒 >= 5
                PRINTFORMW %CALLNAME:奴隷%は時折息を荒げている
            ELSEIF CFLAG:奴隷:覚醒 >= 3
                PRINTFORMW %CALLNAME:奴隷%は時折息を荒げているが、まだ起きる気配はない
            ELSEIF CFLAG:奴隷:覚醒 >= 1
                PRINTFORMW %CALLNAME:奴隷%は寝返りを打った
            ELSEIF CFLAG:奴隷:覚醒 == 0
                PRINTFORMW %CALLNAME:奴隷%は熟睡している
            ENDIF
        ELSE
            FLAG:睡姦フラグ = 0
            CFLAG:奴隷:NTR睡姦 = 0
            CFLAG:奴隷:覚醒 = 0
            CFLAG:奴隷:挿入 = 0
        ENDIF
    ELSE
    ENDIF

;-------------------------------------------------------------------------------
;ハーレムイベント関連
;同一箇所に屈服度>好意度な住人だけがいる時のnPイベント
;-------------------------------------------------------------------------------
;ハーレムイベント可否判定
@NTR_HARAM_ABLE
#DIM LOOP_CHR
#DIM 同席人数
    ;主人がいるとNG
SIF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
    RETURN 0
同席人数 = 0
FOR LOOP_CHR,1,CHARANUM
        ;訪問者と同じ場所にいる住人についてチェック
    IF CFLAG:LOOP_CHR:現在位置 == FLAG:訪問者の現在位置
            ;オトコがいたら自粛
        SIF !HAS_VAGINA(LOOP_CHR)
            RETURN 0
            ;妊婦がいたら自粛
        SIF CFLAG:LOOP_CHR:にんっしんっ > 0
            RETURN 0
            ;寝ている住人がいたら自粛
        SIF CFLAG:LOOP_CHR:睡眠 
            RETURN 0
            ;主人より好意度が高くないとNG
        SIF CFLAG:LOOP_CHR:屈服度 <= CFLAG:LOOP_CHR:好感度
            RETURN 0
            ;ストライクゾーン範囲外の時NG
        SIF !NTR_CHK_STRIKE_ZONE(LOOP_CHR)
            RETURN 0
            ;非恋慕住人が対象外のときNG
        SIF IS_NTR_ATTACK_LOVER_ONLY() && !TALENT:LOOP_CHR:恋慕 && !TALENT:LOOP_CHR:NTR
            RETURN 0
        同席人数 ++
    ENDIF
NEXT
    ;2人以上必要
SIF 同席人数 <= 1
    RETURN 0
    ;確率で失敗
SIF RAND:3 
    RETURN 0
IF FLAG:ハーレム時カウンタ == 0
    FLAG:ハーレム時カウンタ = 1
ENDIF
RETURN 1

;-------------------------------------------------------------------------------
;ハーレムイベント
;基本はVISITER_FRIENDSHIPと同じ。同時に多人数相手。
@NTR_HARAM
#DIM 浮気快楽強度
#DIM 密室度
#DIM 行為上限値
#DIM LOOP_CHR
IF FLAG:ハーレム時カウンタ == 1
    FOR LOOP_CHR,1,CHARANUM
        CFLAG:LOOP_CHR:NTRハーレム行為種別 = 0
        CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻 = 0
        CFLAG:LOOP_CHR:NTR訪問者との行為 = NTR_行為_なし
    NEXT
    密室度 = GET_ROOM_SECURITY(FLAG:訪問者の現在位置)
        ;条件を満たしていくと行動の選択肢が増える
    行為上限値 = 0
    FOR LOOP_CHR,1,CHARANUM
        CFLAG:LOOP_CHR:NTRハーレム行為種別 = 0
            ;訪問者と同じ場所にいる住人についてチェック
        IF CFLAG:LOOP_CHR:現在位置 == FLAG:訪問者の現在位置
            CFLAG:LOOP_CHR:訪問者行為CNT += 1
                ;SIF CFLAG:LOOP_CHR:屈服度 > CFLAG:LOOP_CHR:好感度 / 4
            SIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_キスする程度)
                行為上限値 += 1
                ;堂々としていない場所
            IF 密室度 > 0
                    ;SIF CFLAG:LOOP_CHR:屈服度 > CFLAG:LOOP_CHR:好感度 / 3
                SIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_体を触らせる程度)
                    行為上限値 += 1
                    ;さらに目立たない場所または私室
                IF 密室度 >= 2
                        ;SIF CFLAG:LOOP_CHR:屈服度 > CFLAG:LOOP_CHR:好感度 / 2
                    SIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_奉仕する程度)
                        行為上限値 += 1
                        ;SIF CFLAG:LOOP_CHR:屈服度 > CFLAG:LOOP_CHR:好感度 * 3 / 4
                    SIF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_うふふする程度)
                        行為上限値 += 1
                ENDIF
            ENDIF
            SIF CFLAG:LOOP_CHR:屈服度 > CFLAG:LOOP_CHR:好感度
                行為上限値 += 1
            SIF 行為上限値 == 0
                行為上限値 += 1
                ;ハーレム時さらに+1
            CFLAG:LOOP_CHR:NTRハーレム行為種別 = RAND:(行為上限値) + 1
        ELSE
            ; 訪問者と同じ場所にいない場合カウンタを初期化
            CFLAG:LOOP_CHR:訪問者行為CNT = 0
        ENDIF
    NEXT
        ;ハーレム状態の時の施錠処理を外す
        ;IF !FLAG:(300 + FLAG:訪問者の現在位置)
        ;   IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        ;       PRINTFORMW %NTR_NAME(0)%のハーレム状態のため【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】に入りづらくなった。
        ;   ENDIF
        ;ENDIF
        ;FLAG:(300 + FLAG:訪問者の現在位置) = 1
    FLAG:ハーレム時カウンタ ++
ENDIF
    ;全員に対して実行
FOR LOOP_CHR,1,CHARANUM
    浮気快楽強度 = 0
        ;訪問者と同じ場所にいる住人について処理
    IF CFLAG:LOOP_CHR:現在位置 == FLAG:訪問者の現在位置
            ;好感度変化
        IF TALENT:LOOP_CHR:親愛 && CFLAG:LOOP_CHR:屈服度 > 500
            CFLAG:LOOP_CHR:屈服度 -= 100
        ENDIF
        CALL NTR_ADD_SURRENDER(LOOP_CHR, (MIN(TIME_PROGRESS(TFLAG:300), 0) + RAND:2 + 1) )
            ;好感度吸収あり
        CALL NTR_DRAIN_LOVE(LOOP_CHR, RAND:5)
            ;その他の状態で行動中か行動が未決定(終了時間が0なら未決定とする)
        IF CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻 == 0
            FLAG:訪問者との行為の終了時刻 = 0
            IF CFLAG:LOOP_CHR:NTRハーレム行為種別 == NTR_ハーレム行為_なし || CFLAG:LOOP_CHR:NTRハーレム行為種別 == NTR_ハーレム行為_キス
                CALL NTR_KISS(LOOP_CHR)
            ELSEIF CFLAG:LOOP_CHR:NTRハーレム行為種別 == NTR_ハーレム行為_愛撫
                IF RAND:2 == 0
                    CALL NTR_PET(LOOP_CHR)
                ELSE
                    CALL NTR_BUST_PET(LOOP_CHR)
                ENDIF
            ELSEIF CFLAG:LOOP_CHR:NTRハーレム行為種別 == NTR_ハーレム行為_オーラル
                IF RAND:3 == 0
                    CALL NTR_FELLATIO(LOOP_CHR)
                ELSEIF RAND:2 == 0
                    CALL NTR_69(LOOP_CHR)
                ELSE
                    CALL NTR_THUG(LOOP_CHR)
                ENDIF
            ELSE    ; NTR_ハーレム行為_SEX以上
                IF IS_NTR_KEEP_VIRGIN() && TALENT:LOOP_CHR:処女
                        ;処女アナル厨の時はアナル貫通の閾値が低い
                    IF EXP:LOOP_CHR:Ａ経験 > 20
                        CALL NTR_A_SEX(LOOP_CHR, 密室度)
                    ELSE
                            ;条件を満たしていない時は69で我慢
                        CALL NTR_69(LOOP_CHR)
                    ENDIF
                ELSEIF RAND:2 == 0
                    CALL NTR_SEX(LOOP_CHR, 密室度)
                ELSE
                    CALL NTR_A_SEX(LOOP_CHR, 密室度)
                ENDIF
            ENDIF
            CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻 = FLAG:訪問者との行為の終了時刻
            CFLAG:LOOP_CHR:NTR訪問者との行為 = FLAG:訪問者との行為 
        ELSEIF CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻 > DATETIME()
            FLAG:訪問者との行為の終了時刻 = CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻
            FLAG:訪問者との行為 = CFLAG:LOOP_CHR:NTR訪問者との行為
            SELECTCASE FLAG:訪問者との行為
                CASE NTR_行為_キス
                    CALL NTR_KISS(LOOP_CHR)
                CASE NTR_行為_愛撫
                    CALL NTR_PET(LOOP_CHR)
                CASE NTR_行為_胸愛撫
                    CALL NTR_BUST_PET(LOOP_CHR)
                CASE NTR_行為_フェラチオ
                    CALL NTR_FELLATIO(LOOP_CHR)
                CASE NTR_行為_シックスナイン
                    CALL NTR_69(LOOP_CHR)
                CASE NTR_行為_素股
                    CALL NTR_THUG(LOOP_CHR)
                CASE NTR_行為_Ｖ正常位 TO NTR_行為_Ｖ背面立位
                    CALL NTR_SEX(LOOP_CHR, 密室度)
                CASE NTR_行為_Ａ正常位 TO NTR_行為_Ａ背面立位
                    CALL NTR_A_SEX(LOOP_CHR, 密室度)
                CASE 21 TO 27
                        ; 予約しますby別人の別人
                CASEELSE
                        ; なに？
            ENDSELECT
            CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻 = FLAG:訪問者との行為の終了時刻
            CFLAG:LOOP_CHR:NTR訪問者との行為 = FLAG:訪問者との行為 
        ELSE
            FLAG:訪問者との行為の終了時刻 = CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻
            FLAG:訪問者との行為 = CFLAG:LOOP_CHR:NTR訪問者との行為
            SELECTCASE FLAG:訪問者との行為
                CASE NTR_行為_キス
                    CALL NTR_KISS_FINISH(LOOP_CHR)
                CASE NTR_行為_愛撫
                    CALL NTR_PET_FINISH(LOOP_CHR)
                CASE NTR_行為_胸愛撫
                    CALL NTR_BUST_PET_FINISH(LOOP_CHR)
                CASE NTR_行為_フェラチオ
                    CALL NTR_FELLATIO_FINISH(LOOP_CHR)
                CASE NTR_行為_シックスナイン
                    CALL NTR_69_FINISH(LOOP_CHR)
                CASE NTR_行為_素股
                    CALL NTR_THUG_FINISH(LOOP_CHR)
                CASE NTR_行為_Ｖ正常位 TO NTR_行為_Ｖ背面立位
                    CALL NTR_SEX_FINISH(LOOP_CHR)
                CASE NTR_行為_Ａ正常位 TO NTR_行為_Ａ背面立位
                    CALL NTR_A_SEX_FINISH(LOOP_CHR)
                CASE 21 TO 27
                        ; 予約しますby別人の別人
                CASEELSE
                        ; なに？
            ENDSELECT
            CFLAG:LOOP_CHR:NTRハーレム行為種別 = 0
            CFLAG:LOOP_CHR:NTR訪問者との行為の終了時刻 = 0
            CFLAG:LOOP_CHR:NTR訪問者との行為 = NTR_行為_なし
            FLAG:ハーレム時カウンタ = 0
        ENDIF
        PRINTL
    ENDIF
NEXT
RETURN 0

;-------------------------------------------------------------------------------
;以下、訪問者の性行動 各ソースからコピペして少しいじっただけなので適当です
;キス
@NTR_KISS(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
#DIM 行為上限値
TCVAR:奴隷:行為者 = 調教者
TCVAR:行為者 = 調教者
    ;主人同席（見せつけ）
CALL NTR_KISS_PET_FELLA_MSG_KOJO_01(奴隷, 2)
IF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 2)
    SIF EXP:奴隷:NTR陥落経験 
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    SIF TALENT:奴隷:浮気な唇
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    BASE:奴隷:気力 -= 80
    IF TALENT:奴隷:浮気な唇
        SOURCE:奴隷:情愛 = 100
        SOURCE:奴隷:性行動 = 10
        SOURCE:奴隷:逸脱 = 10
    ELSE
        SOURCE:奴隷:情愛 = 50
        SOURCE:奴隷:性行動 = 10
        SOURCE:奴隷:逸脱 = 10
    ENDIF
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な唇
        SOURCE:奴隷:屈従 = 20
        SOURCE:奴隷:反感 = 0
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:屈従 = 15
        SOURCE:奴隷:反感 = 5
    ELSE
        SOURCE:奴隷:屈従 = 10
        SOURCE:奴隷:反感 = 10
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 10
    EXP:奴隷:キス経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気キス経験 ++
    FLAG:訪問者との行為の終了時刻 = DATETIME() + 10
    FLAG:訪問者との行為 = NTR_行為_キス
    CFLAG:奴隷:訪問者行為 = NTR_行為_キス
    CALL LOST_VIRGIN_M(奴隷, 人物_訪問者)
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;愛撫
@NTR_PET(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TCVAR:奴隷:行為者 = 調教者
CALL NTR_KISS_PET_FELLA_MSG_KOJO_01(奴隷, 3)
IF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 3)
    SIF EXP:奴隷:NTR陥落経験 
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    BASE:奴隷:体力 -= 5
    BASE:奴隷:気力 -= 50
    SOURCE:奴隷:快Ｃ = 80
    SOURCE:奴隷:快Ｂ = 80
    SOURCE:奴隷:情愛 = 50
    SOURCE:奴隷:性行動 = 60
    SOURCE:奴隷:露出 = 20
    SOURCE:奴隷:不潔 = 30
    SOURCE:奴隷:逸脱 = 20
    IF TALENT:奴隷:NTR
        SOURCE:奴隷:反感 = 5
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 10
    ELSE
        SOURCE:奴隷:反感 = 20
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 20
    EXP:奴隷:キス経験 ++
    EXP:奴隷:Ｃ経験 ++
    EXP:奴隷:Ｂ経験 ++
    SIF TALENT:奴隷:汚臭耐性 > 0
        SOURCE:奴隷:不潔 /= 4
    SIF TALENT:奴隷:汚臭耐性 < 0
        SOURCE:奴隷:不潔 *= 3
    SIF TALENT:奴隷:プライド > 0
        SOURCE:奴隷:不潔 *= 2
    FLAG:訪問者との行為の終了時刻 = DATETIME() + 10
    EXP:奴隷:Ｃ絶頂経験 ++
    EXP:奴隷:Ｂ絶頂経験 ++
    FLAG:訪問者との行為 = NTR_行為_愛撫
    CFLAG:奴隷:訪問者行為 = NTR_行為_愛撫
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;胸愛撫
@NTR_BUST_PET(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TCVAR:奴隷:行為者 = 調教者
CALL NTR_KISS_PET_FELLA_MSG_KOJO_01(奴隷, 4)
IF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 3)
    SIF EXP:奴隷:NTR陥落経験 
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    BASE:奴隷:体力 -= 5
    BASE:奴隷:気力 -= 50
    SOURCE:奴隷:快Ｂ = 120
    SOURCE:奴隷:歓楽 = 100
    SOURCE:奴隷:情愛 = 150
    SOURCE:奴隷:欲情 = 170
    SOURCE:奴隷:露出 = 70
    IF TALENT:奴隷:NTR
        SOURCE:奴隷:反感 = 150
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 250
    ELSE
        SOURCE:奴隷:反感 = 350
    ENDIF
    SOURCE:奴隷:受動 = 120 + 240 * ABL:奴隷:従順
    IF TEQUIP:奴隷:1 > 1
        TIMES SOURCE:奴隷:快Ｂ , 0.80
        TIMES SOURCE:奴隷:欲情 , 0.80
        TIMES SOURCE:奴隷:露出 , 0.80
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 20
    EXP:奴隷:Ｂ経験 ++
    FLAG:訪問者との行為の終了時刻 = DATETIME() + 10
    EXP:奴隷:Ｂ絶頂経験 ++
    FLAG:訪問者との行為 = NTR_行為_胸愛撫
    CFLAG:奴隷:訪問者行為 = NTR_行為_胸愛撫
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;フェラチオ
@NTR_FELLATIO(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TCVAR:奴隷:行為者 = 調教者
CALL NTR_KISS_PET_FELLA_MSG_KOJO_01(奴隷, 5)
IF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 3)
    SIF EXP:奴隷:NTR陥落経験 
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    BASE:奴隷:体力 -= 10
    BASE:奴隷:気力 -= 100
    SOURCE:奴隷:情愛 = 100
    SOURCE:奴隷:性行動 = 300
    SOURCE:奴隷:達成 = 150
    SOURCE:奴隷:屈従 = 700
    SOURCE:奴隷:不潔 = 200
    IF TALENT:奴隷:NTR
        SOURCE:奴隷:反感 = 50
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 100
    ELSE
        SOURCE:奴隷:反感 = 200
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 400
    EXP:奴隷:口淫経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気口淫経験 ++
    SIF TALENT:奴隷:猫舌
        EXP:奴隷:嗜虐快楽経験 ++
    CALL STAIN_MOVE_BY_PENIS(部位_口, 奴隷, 人物_訪問者)
    IF GETBIT(FLAG:訪問者との汚れ判定に使用,汚れB_精液)
        EXP:奴隷:精飲経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気精飲経験 ++
        CFLAG:奴隷:射精者M = 調教者
    ENDIF
    FLAG:訪問者との行為の終了時刻 = DATETIME() + 10
    FLAG:訪問者との行為 = NTR_行為_フェラチオ
    CFLAG:奴隷:訪問者行為 = NTR_行為_フェラチオ
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;シックスナイン
@NTR_69(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TCVAR:奴隷:行為者 = 調教者
CALL NTR_KISS_PET_FELLA_MSG_KOJO_01(奴隷, 6)
IF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 3)
    SIF EXP:奴隷:NTR陥落経験 
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    BASE:奴隷:体力 -= 20
    BASE:奴隷:気力 -= 160
    SOURCE:奴隷:快Ｃ = 100
    SOURCE:奴隷:情愛 = 100
    SOURCE:奴隷:性行動 = 450
    SOURCE:奴隷:達成 = 200
    SOURCE:奴隷:液体 = 80
    SOURCE:奴隷:露出 = 100
    SOURCE:奴隷:屈従 = 800
    SOURCE:奴隷:逸脱 = 600
    IF TALENT:奴隷:NTR
        SOURCE:奴隷:反感 = 200
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 400
    ELSE
        SOURCE:奴隷:反感 = 600
    ENDIF
    IF !TALENT:処女
        SOURCE:奴隷:快Ｖ += 120
        SOURCE:奴隷:苦痛 += 15
        SOURCE:奴隷:露出 += 10
        SOURCE:奴隷:逸脱 += 20
        SOURCE:奴隷:反感 += 20
    ELSE
            ;69で破瓜してしまうのを避けるためコメントアウト
            ;SOURCE:奴隷:快Ｖ += 60
        SOURCE:奴隷:苦痛 += 10
        SOURCE:奴隷:露出 += 30
        SOURCE:奴隷:逸脱 += 30
        SOURCE:奴隷:反感 += 30
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 800
    EXP:奴隷:口淫経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気口淫経験 ++
    EXP:奴隷:Ｃ経験 ++
    SIF TALENT:奴隷:猫舌
        EXP:奴隷:嗜虐快楽経験 += 1
    CALL STAIN_MOVE_BY_PENIS(部位_口, 奴隷, 人物_訪問者)
    IF GETBIT(FLAG:訪問者との汚れ判定に使用,汚れB_精液)
        EXP:奴隷:精飲経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気精飲経験 ++
        CFLAG:奴隷:射精者M = 調教者
    ENDIF
    FLAG:訪問者との行為の終了時刻 = DATETIME() + 10
    EXP:奴隷:Ｃ絶頂経験 ++
    FLAG:訪問者との行為 = NTR_行為_シックスナイン
    CFLAG:奴隷:訪問者行為 = NTR_行為_シックスナイン
        ;処女アナル厨時の特殊処理。アナルも責められる。
    IF IS_NTR_KEEP_VIRGIN()
        EXP:奴隷:Ａ経験 ++
        IF TALENT:奴隷:浮気な尻穴
            SOURCE:奴隷:快Ａ = 200
            SOURCE:奴隷:情愛 += 100
            SOURCE:奴隷:苦痛 += 100
        ELSE
            SOURCE:奴隷:快Ａ = 100
            SOURCE:奴隷:情愛 += 50
            SOURCE:奴隷:苦痛 += 200
            SOURCE:奴隷:逸脱 += 50
        ENDIF
        IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
            SOURCE:奴隷:反感 += 50
        ELSEIF CFLAG:奴隷:屈服度 > 1000
            SOURCE:奴隷:反感 += 100
        ELSE
            SOURCE:奴隷:反感 += 200
        ENDIF
        SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
            SOURCE:奴隷:鬱屈 += 100
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;素股
@NTR_THUG(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TCVAR:奴隷:行為者 = 調教者
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    PRINTFORM 【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】で%CALLNAME:奴隷%は%NTR_NAME(0)%のペニスを股にはさみ、
    IF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        PRINTFORM 陶酔しきった瞳で%NTR_NAME(0)%を見つめながら
    ELSEIF TALENT:奴隷:淫乱
        PRINTFORM 淫猥な目つきで挑発しながら
    ELSEIF TALENT:奴隷:羞恥心 < 0
        PRINTFORM 大胆に腰を動かしながら
    ELSEIF TALENT:奴隷:感情乏しい
        PRINTFORM うっすらと上気した顔で
    ELSE
        PRINT 恥ずかしそうに
    ENDIF
    IF FLAG:訪問者との行為の終了時刻 == 0
        PRINTFORMW %MSG_SLIT(奴隷)%をペニスに擦りつけた
        TRYCALLLIST
            FUNC NTR_KOJO_K{CFLAG:奴隷:297}_7_0(奴隷)
            FUNC NTR_KOJO_K_7_0(奴隷)
        ENDFUNC
    ELSE
        PRINTFORMW %MSG_SLIT(奴隷)%をペニスに擦りつけている
        TRYCALLLIST
            FUNC NTR_KOJO_K{CFLAG:奴隷:297}_7_1(奴隷)
            FUNC NTR_KOJO_K_7_1(奴隷)
        ENDFUNC
    ENDIF
ENDIF
IF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 4)
    SIF EXP:奴隷:NTR陥落経験 
        CALL NTR_ADD_SURRENDER(奴隷, 2)
    BASE:奴隷:体力 -= 40
    BASE:奴隷:気力 -= 130
    SOURCE:奴隷:快Ｃ = 150
    SOURCE:奴隷:情愛 = 80
    SOURCE:奴隷:性行動 = 250
    SOURCE:奴隷:達成 = 50
    SOURCE:奴隷:屈従 = 500
    SOURCE:奴隷:逸脱 = 120
    IF TALENT:奴隷:NTR
        SOURCE:奴隷:反感 = 60
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 100
    ELSE
        SOURCE:奴隷:反感 = 120
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 300
    EXP:奴隷:Ｃ経験 ++
    CALL STAIN_MOVE_BY_PENIS(部位_Ｖ, 奴隷, 人物_訪問者)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + 20  
    EXP:奴隷:Ｃ絶頂経験 ++
    FLAG:訪問者との行為 = NTR_行為_素股
    CFLAG:奴隷:訪問者行為 = NTR_行為_素股
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;性交
@NTR_SEX(奴隷,密室度,調教者=人物_訪問者)
#DIM 奴隷
#DIM 密室度
#DIM 調教者
#DIM 体位
    ;バグ回避用。汚いけど許せ。
IF IS_NTR_KEEP_VIRGIN() && TALENT:奴隷:処女
    CALL NTR_A_SEX(奴隷, 密室度, 調教者)
    RETURN
ENDIF
TCVAR:奴隷:行為者 = 調教者
TCVAR:行為者 = 調教者
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
CALL 締り具合変動, 奴隷, 3, 0
SIF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 10)
    ;CFLAG:奴隷:屈服度 += (FLAG:訪問者との行為の終了時刻 - DATETIME()) / 10
SIF EXP:奴隷:NTR陥落経験 
    CALL NTR_ADD_SURRENDER(奴隷, 2)
    ;体位の決定(目立たない場所か私室かで体位に違いを)
体位 = 0
SELECTCASE FLAG:訪問者との行為
    CASE NTR_行為_Ｖ正常位 TO NTR_行為_Ｖ背面座位
        体位 = FLAG:訪問者との行為 - NTR_行為_Ｖ正常位
    CASE IS > NTR_行為_Ｖ背面座位
        体位 = FLAG:訪問者との行為 - NTR_行為_Ｖ背面座位
    CASEELSE
        SIF 密室度 == 2
            体位 = 5 + RAND:2
        SIF 密室度 >= 3
            体位 = RAND:5
ENDSELECT
体位 = MIN(体位, 6)
CALLFORM NTR_SEX_{体位}(奴隷)
    ;汚れ等共通する処理
CALL STAIN_MOVE_BY_PENIS(部位_Ｖ, 奴隷, 人物_訪問者)
CALL STAIN_MOVE_BY_PENIS(部位_膣内, 奴隷, 人物_訪問者)
IF TALENT:奴隷:処女
    SETBIT FLAG:訪問者との汚れ判定に使用,汚れB_破瓜の血
    CALL LOST_VIRGIN(奴隷, 調教者)
        ;処女喪失中フラグセット
    CFLAG:奴隷:処女喪失中 = 1
ENDIF
CFLAG:奴隷:精液残留中 = 0
CFLAG:奴隷:NTR訪問者と最後にセックスした日時 = DATETIME()
RETURN 0

;-------------------------------------------------------------------------------
;キス、愛撫、奉仕時メッセージ・口上分岐
;主人同席での見せつけも考慮
;奴隷…対象キャラ
;行為…行為コード 2:キス 3:愛撫 4:胸愛撫 5:フェラチオ 6:69 7:素股
@NTR_KISS_PET_FELLA_MSG_KOJO_01(奴隷, 行為)
#DIM 奴隷
#DIM 行為
    ;主人同席（見せつけ）
IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 && 奴隷 != MASTER
        ;開始
    IF FLAG:訪問者との行為の終了時刻 == 0
        CALLFORM NTR_MESSAGE_W_{行為}_0(奴隷)
        TRYCALLLIST
            FUNC NTR_KOJO_KW{CFLAG:奴隷:297}_{行為}_0(奴隷)
            FUNC NTR_KOJO_KW_{行為}_0(奴隷)
            FUNC NTR_KOJO_K{CFLAG:奴隷:297}_{行為}_0(奴隷)
        ENDFUNC
            ;継続
    ELSE
        CALLFORM NTR_MESSAGE_W_{行為}_1(奴隷)
        TRYCALLLIST
            FUNC NTR_KOJO_KW{CFLAG:奴隷:297}_{行為}_1(奴隷)
            FUNC NTR_KOJO_KW_{行為}_1(奴隷)
            FUNC NTR_KOJO_K{CFLAG:奴隷:297}_{行為}_1(奴隷)
        ENDFUNC
    ENDIF
    CFLAG:奴隷:同席目撃回数 ++
    CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, 行為)
        ;二人きり
ELSE
    IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            ;開始
        IF FLAG:訪問者との行為の終了時刻 == 0
            CALLFORM NTR_MESSAGE_{行為}_0(奴隷)
            TRYCALLLIST
                FUNC NTR_KOJO_K{CFLAG:奴隷:297}_{行為}_0(奴隷)
                FUNC NTR_KOJO_K_{行為}_0(奴隷)
            ENDFUNC
                ;継続
        ELSE
            CALLFORM NTR_MESSAGE_{行為}_1(奴隷)
            TRYCALLLIST
                FUNC NTR_KOJO_K{CFLAG:奴隷:297}_{行為}_1(奴隷)
                FUNC NTR_KOJO_K_{行為}_1(奴隷)
            ENDFUNC
        ENDIF
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;キス、愛撫、奉仕時メッセージ・口上分岐
;主人同席での見せつけも考慮
;奴隷…対象キャラ
;行為…行為コード 2:キス 3:愛撫 4:胸愛撫 5:フェラチオ 6:69 7:素股
@NTR_KISS_PET_FELLA_MSG_KOJO_2(奴隷, 行為)
#DIM 奴隷
#DIM 行為
    ;主人同席（見せつけ）
IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 && 奴隷 != MASTER
    CALLFORM NTR_MESSAGE_{行為}_2(奴隷)
    TRYCALLLIST
        FUNC NTR_KOJO_KW{CFLAG:奴隷:297}_{行為}_2(奴隷)
        FUNC NTR_KOJO_KW_{行為}_2(奴隷)
        FUNC NTR_KOJO_K_{行為}_2(奴隷)
    ENDFUNC
    CFLAG:奴隷:同席目撃回数 ++
    CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, 行為)
        ;二人きり
ELSE
    IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        CALLFORM NTR_MESSAGE_{行為}_2(奴隷)
        TRYCALLLIST
            FUNC NTR_KOJO_K{CFLAG:奴隷:297}_{行為}_2(奴隷)
            FUNC NTR_KOJO_K_{行為}_2(奴隷)
        ENDFUNC
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;性交時メッセージ・口上分岐
;主人同席での見せつけも考慮
;奴隷…対象キャラ
@NTR_SEX_MSG_KOJO(奴隷)
#DIM 奴隷
#DIM 開始継続
#DIM 主人同席
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        ; 開始／継続フラグ
    開始継続 = ( FLAG:訪問者との行為の終了時刻 == 0 ? 0 # 1 )
        ; 主人同席（見せつけ）フラグ
    主人同席 = ( CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 ? 1 # 0 )
    CALL NTR_SEX_KOJO_EX(奴隷, 開始継続, 主人同席, "KOJO_PRE")
    CALL NTR_SEX_KOJO_EX(奴隷, 開始継続, 主人同席, "MESSAGE")
    CALL NTR_SEX_KOJO_EX(奴隷, 開始継続, 主人同席, "KOJO")
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;性交時メッセージ・口上分岐
;主人同席での見せつけも考慮
;奴隷…対象キャラ
@NTR_SEX_FINISH_MSG_KOJO(奴隷)
#DIM 奴隷
#DIM 主人同席
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        ; 主人同席（見せつけ）フラグ
    主人同席 = ( CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 ? 1 # 0 )
    CALL NTR_SEX_KOJO_EX(奴隷, 2, 主人同席, "KOJO_PRE")
    CALL NTR_SEX_KOJO_EX(奴隷, 2, 主人同席, "MESSAGE")
    CALL NTR_SEX_KOJO_EX(奴隷, 2, 主人同席, "KOJO")
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;性交時メッセージ分岐
;奴隷…対象キャラ
;行為段階…0=開始 1=継続 2=終了
;主人同席…0=二人きり 1=主人同席
;関数種別…口上または地の文の関数名の一部
@NTR_SEX_KOJO_EX(奴隷, 行為段階, 主人同席, 関数種別)
#DIM 奴隷
#DIM 行為段階
#DIM 主人同席
#DIMS 関数種別
#DIM 体位
SIF FLAG:口上テキスト設定 <= 0 && 関数種別 == "KOJO_PRE"
    RETURN 0
SIF FLAG:口上テキスト設定 <= 0 && 関数種別 == "KOJO"
    RETURN 0
SIF FLAG:情景テキスト設定 <= 0 && 関数種別 == "MESSAGE"
    RETURN 0
SIF 関数種別 != "MESSAGE" && 関数種別 != "KOJO" && 関数種別 != "KOJO_PRE"
    RETURN 0
体位 = FLAG:訪問者との行為 - NTR_行為_Ｖ正常位
SIF FLAG:訪問者との行為 > NTR_行為_Ｖ背面座位
    体位 = FLAG:訪問者との行為 - NTR_行為_Ｖ背面座位
IF 主人同席 != 0
    CFLAG:奴隷:同席目撃回数 ++
    CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, FLAG:訪問者との行為)
ENDIF
    ; ここで使われているLOCALSの用途が不明
TRYCALLLIST
        ;キャラ専用・体位専用
    FUNC NTR_%関数種別%_%LOCALS%{奴隷}_8_{体位}_{行為段階}(奴隷)
        ;キャラ専用・体位汎用
    FUNC NTR_%関数種別%_%LOCALS%{奴隷}_8_U_{行為段階}(奴隷)
        ;キャラ汎用・体位専用
    FUNC NTR_%関数種別%_%LOCALS%_8_{体位}_{行為段階}(奴隷)
        ;キャラ汎用・体位汎用
    FUNC NTR_%関数種別%_%LOCALS%_8_U_{行為段階}(奴隷)
        ;キャラ汎用・体位汎用がなければ正常位で代用
    FUNC NTR_%関数種別%_%LOCALS%_8_0_{行為段階}(奴隷)
ENDFUNC
IF 主人同席 != 0
        ; 同席のときは _KW, _K の順で検索
    TRYCALLLIST
            ;キャラ専用・体位専用
        FUNC NTR_%関数種別%_KW{CFLAG:奴隷:297}_8_{体位}_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_8_{体位}_{行為段階}(奴隷)
            ;キャラ専用・体位汎用
        FUNC NTR_%関数種別%_KW{CFLAG:奴隷:297}_8_U_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_8_U_{行為段階}(奴隷)
            ;キャラ汎用・体位専用
        FUNC NTR_%関数種別%_KW_8_{体位}_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K_8_{体位}_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用
        FUNC NTR_%関数種別%_KW_8_U_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K_8_U_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用がなければ正常位で代用
        FUNC NTR_%関数種別%_KW_8_0_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K_8_0_{行為段階}(奴隷)
    ENDFUNC
ELSE
        ; 同席でないときは _K の関数のみ検索
    TRYCALLLIST
            ;キャラ専用・体位専用
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_8_{体位}_{行為段階}(奴隷)
            ;キャラ専用・体位汎用
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_8_U_{行為段階}(奴隷)
            ;キャラ汎用・体位専用
        FUNC NTR_%関数種別%_K_8_{体位}_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用
        FUNC NTR_%関数種別%_K_8_U_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用がなければ正常位で代用
        FUNC NTR_%関数種別%_K_8_0_{行為段階}(奴隷)
    ENDFUNC
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;A性交時メッセージ・口上分岐
;主人同席での見せつけも考慮
;奴隷:対象キャラ
@NTR_A_SEX_MSG_KOJO(奴隷)
#DIM 奴隷
#DIM 開始継続
#DIM 主人同席
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        ; 開始／継続フラグ
    開始継続 = ( FLAG:訪問者との行為の終了時刻 == 0 ? 0 # 1 )
        ; 主人同席（見せつけ）フラグ
    主人同席 = ( CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 ? 1 # 0 )
    CALL NTR_A_SEX_KOJO_EX(奴隷, 開始継続, 主人同席, "KOJO_PRE")
    CALL NTR_A_SEX_KOJO_EX(奴隷, 開始継続, 主人同席, "MESSAGE")
    CALL NTR_A_SEX_KOJO_EX(奴隷, 開始継続, 主人同席, "KOJO")
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;A性交時メッセージ・口上分岐
;主人同席での見せつけも考慮
;奴隷:対象キャラ
@NTR_A_SEX_FINISH_MSG_KOJO(奴隷)
#DIM 奴隷
#DIM 主人同席
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        ; 主人同席（見せつけ）フラグ
    主人同席 = ( CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 ? 1 # 0 )
    CALL NTR_A_SEX_KOJO_EX(奴隷, 2, 主人同席, "KOJO_PRE")
    CALL NTR_A_SEX_KOJO_EX(奴隷, 2, 主人同席, "MESSAGE")
    CALL NTR_A_SEX_KOJO_EX(奴隷, 2, 主人同席, "KOJO")
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;A性交時メッセージ分岐
;奴隷…対象キャラ
;行為段階…0=開始 1=継続 2=終了
;主人同席…0=二人きり 1=主人同席
;関数種別…口上または地の文の関数名の一部
@NTR_A_SEX_KOJO_EX(奴隷, 行為段階, 主人同席, 関数種別)
#DIM 奴隷
#DIM 行為段階
#DIM 主人同席
#DIMS 関数種別
#DIM 体位
SIF FLAG:口上テキスト設定 <= 0 && 関数種別 == "KOJO_PRE"
    RETURN 0
SIF FLAG:口上テキスト設定 <= 0 && 関数種別 == "KOJO"
    RETURN 0
SIF FLAG:情景テキスト設定 <= 0 && 関数種別 == "MESSAGE"
    RETURN 0
SIF 関数種別 != "MESSAGE" && 関数種別 != "KOJO" && 関数種別 != "KOJO_PRE"
    RETURN 0
体位 = FLAG:訪問者との行為 - NTR_行為_Ａ正常位
SIF FLAG:訪問者との行為 > NTR_行為_Ａ背面座位
    体位 = FLAG:訪問者との行為 - NTR_行為_Ａ背面座位
IF 主人同席 != 0
    CFLAG:奴隷:同席目撃回数 ++
    CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, FLAG:訪問者との行為)
ENDIF
IF 主人同席 != 0
        ; 同席のときは _KW, _K の順で検索
    TRYCALLLIST
            ;キャラ専用・体位専用
        FUNC NTR_%関数種別%_KW{CFLAG:奴隷:297}_9_{体位}_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_9_{体位}_{行為段階}(奴隷)
            ;キャラ専用・体位汎用
        FUNC NTR_%関数種別%_KW{CFLAG:奴隷:297}_9_U_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_9_U_{行為段階}(奴隷)
            ;キャラ汎用・体位専用
        FUNC NTR_%関数種別%_KW_9_{体位}_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K_9_{体位}_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用
        FUNC NTR_%関数種別%_KW_9_U_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K_9_U_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用がなければ正常位で代用
        FUNC NTR_%関数種別%_KW_9_0_{行為段階}(奴隷)
        FUNC NTR_%関数種別%_K_9_0_{行為段階}(奴隷)
    ENDFUNC
ELSE
        ; 同席でないときは _K の関数のみ検索
    TRYCALLLIST
            ;キャラ専用・体位専用
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_9_{体位}_{行為段階}(奴隷)
            ;キャラ専用・体位汎用
        FUNC NTR_%関数種別%_K{CFLAG:奴隷:297}_9_U_{行為段階}(奴隷)
            ;キャラ汎用・体位専用
        FUNC NTR_%関数種別%_K_9_{体位}_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用
        FUNC NTR_%関数種別%_K_9_U_{行為段階}(奴隷)
            ;キャラ汎用・体位汎用がなければ正常位で代用
        FUNC NTR_%関数種別%_K_9_0_{行為段階}(奴隷)
    ENDFUNC
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;アナル性交
@NTR_A_SEX(奴隷,密室度,調教者=人物_訪問者)
#DIM 奴隷
#DIM 密室度
#DIM 調教者
#DIM 体位
TCVAR:奴隷:行為者 = 調教者
TCVAR:行為者 = 調教者
CALL 締り具合変動, 奴隷, 3, 1
SIF FLAG:訪問者との行為の終了時刻 == 0
    CALL NTR_ADD_SURRENDER(奴隷, 10)
    ;CFLAG:奴隷:屈服度 += (FLAG:訪問者との行為の終了時刻 - DATETIME()) / 10
SIF EXP:奴隷:NTR陥落経験 
    CALL NTR_ADD_SURRENDER(奴隷, 2)
    ;体位の決定(目立たない場所か私室かで体位に違いを)
体位 = 0
SELECTCASE FLAG:訪問者との行為
    CASE NTR_行為_Ａ正常位 TO NTR_行為_Ａ背面座位
        体位 = FLAG:訪問者との行為 - NTR_行為_Ａ正常位
    CASE IS > NTR_行為_Ａ背面座位
        体位 = FLAG:訪問者との行為 - NTR_行為_Ａ背面座位
    CASEELSE
        SIF 密室度 == 2
            体位 = 5 + RAND:2
        SIF 密室度 >= 3
            体位 = RAND:5
ENDSELECT
体位 = MIN(体位, 6)
CALLFORM NTR_A_SEX_{体位}(奴隷)
    ;汚れ等共通する処理
CALL STAIN_MOVE_BY_PENIS(部位_Ａ, 奴隷, 人物_訪問者)
CALL STAIN_MOVE_BY_PENIS(部位_腸内, 奴隷, 人物_訪問者)
CFLAG:奴隷:NTR訪問者と最後にセックスした日時 = DATETIME()
CALL LOST_VIRGIN_A(奴隷, 調教者)
RETURN 0

;-------------------------------------------------------------------------------
;正常位
@NTR_SEX_0(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ正常位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ正常位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 50
    BASE:奴隷:気力 -= 100
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 500
        SOURCE:奴隷:情愛 = 200
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 400
        SOURCE:奴隷:情愛 = 150
        SOURCE:奴隷:苦痛 = 500
    ENDIF
    SOURCE:奴隷:露出 = 50
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 150
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 240
    ELSE
        SOURCE:奴隷:反感 = 300
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 300
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++
    IF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++      
    ENDIF
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ正常位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ正常位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;後背位
@NTR_SEX_1(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ後背位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ後背位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 50
    BASE:奴隷:気力 -= 100
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 500
        SOURCE:奴隷:情愛 = 200
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 400
        SOURCE:奴隷:情愛 = 150
        SOURCE:奴隷:苦痛 = 400
    ENDIF
    SOURCE:奴隷:露出 = 70
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 150
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 240
    ELSE
        SOURCE:奴隷:反感 = 300
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 300
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ後背位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ後背位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;騎乗位
@NTR_SEX_2(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ騎乗位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ騎乗位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 60
    BASE:奴隷:気力 -= 150
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 700
        SOURCE:奴隷:情愛 = 400
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 500
        SOURCE:奴隷:情愛 = 250
        SOURCE:奴隷:苦痛 = 500
    ENDIF
    SOURCE:奴隷:性行動 = 250
    SOURCE:奴隷:達成 = 250
    SOURCE:奴隷:露出 = 120
    SOURCE:奴隷:逸脱 = 600
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 400
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 600
    ELSE
        SOURCE:奴隷:反感 = 800
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 800
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    SIF TALENT:奴隷:処女
        EXP:奴隷:異常経験 += 2
    SIF TALENT:奴隷:処女 && !GETBIT(CFLAG:奴隷:異常経験,1)
        SETBIT CFLAG:奴隷:異常経験,1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ騎乗位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ騎乗位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;対面座位
@NTR_SEX_3(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ対面座位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ対面座位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 50
    BASE:奴隷:気力 -= 100
    SOURCE:奴隷:快Ｃ = 250
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 500
        SOURCE:奴隷:情愛 = 450
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 350
        SOURCE:奴隷:情愛 = 350
        SOURCE:奴隷:苦痛 = 500
    ENDIF
    SOURCE:奴隷:恭順 = 300
    SOURCE:奴隷:逸脱 = 500
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 500
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 750
    ELSE
        SOURCE:奴隷:反感 = 1000
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 900
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ対面座位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ対面座位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;背面座位
@NTR_SEX_4(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ背面座位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ背面座位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 50
    BASE:奴隷:気力 -= 100
    SOURCE:奴隷:快Ｃ = 250
    SOURCE:奴隷:快Ｂ = 250
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 500
        SOURCE:奴隷:情愛 = 500
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 350
        SOURCE:奴隷:情愛 = 350
        SOURCE:奴隷:苦痛 = 400
    ENDIF
    SOURCE:奴隷:露出 = 200
    SOURCE:奴隷:逸脱 = 500
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 500
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 750
    ELSE
        SOURCE:奴隷:反感 = 1000
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 800
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ背面座位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ背面座位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;対面立位
@NTR_SEX_5(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ対面立位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ対面立位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 50
    BASE:奴隷:気力 -= 100
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 600
        SOURCE:奴隷:情愛 = 250
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 400
        SOURCE:奴隷:情愛 = 150
        SOURCE:奴隷:苦痛 = 500
    ENDIF
    SOURCE:奴隷:露出 = 50
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 150
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 240
    ELSE
        SOURCE:奴隷:反感 = 300
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 300
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ対面立位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ対面立位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;背面立位
@NTR_SEX_6(奴隷)
#DIM 奴隷
TEQUIP:奴隷:Ｖセックス = 人物_訪問者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ｖ背面立位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ背面立位
    ;性交時メッセージ・口上 主人同席での見せつけも考慮
CALL NTR_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 50
    BASE:奴隷:気力 -= 100
    IF TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:快Ｖ = 600
        SOURCE:奴隷:情愛 = 250
        SOURCE:奴隷:苦痛 = 200
    ELSE
        SOURCE:奴隷:快Ｖ = 400
        SOURCE:奴隷:情愛 = 150
        SOURCE:奴隷:苦痛 = 400
    ENDIF
    SOURCE:奴隷:露出 = 70
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な蜜壷
        SOURCE:奴隷:反感 = 150
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 240
    ELSE
        SOURCE:奴隷:反感 = 300
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 300
    SIF TALENT:奴隷:貞操 > 0 && CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度
        SOURCE:奴隷:反感 += 1000
    IF TALENT:奴隷:処女 == 1
        SOURCE:奴隷:苦痛 += 2000
        SOURCE:奴隷:反感 += 3000
    ENDIF
    IF TALENT:奴隷:処女 == 2
        SOURCE:奴隷:苦痛 += 500
        SOURCE:奴隷:反感 += 1000
    ENDIF
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ｖ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%の膣は、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ｖ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ｖ経験 ++
    EXP:奴隷:Ｖ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ｖ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ｖ背面立位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ｖ背面立位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;正常位アナル
@NTR_A_SEX_0(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ正常位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ正常位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 80
    BASE:奴隷:気力 -= 120
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 600
        SOURCE:奴隷:情愛 = 200
        SOURCE:奴隷:苦痛 = 400
    ELSE
        SOURCE:奴隷:快Ａ = 400
        SOURCE:奴隷:情愛 = 100
        SOURCE:奴隷:苦痛 = 800
    ENDIF
    SOURCE:奴隷:露出 = 60
    SOURCE:奴隷:逸脱 = 200
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 250
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 370
    ELSE
        SOURCE:奴隷:反感 = 500
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 500
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ正常位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ正常位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;後背位アナル
@NTR_A_SEX_1(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ後背位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ後背位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 80
    BASE:奴隷:気力 -= 120
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 600
        SOURCE:奴隷:情愛 = 200
        SOURCE:奴隷:苦痛 = 400
    ELSE
        SOURCE:奴隷:快Ａ = 400
        SOURCE:奴隷:情愛 = 100
        SOURCE:奴隷:苦痛 = 900
    ENDIF
    SOURCE:奴隷:露出 = 80
    SOURCE:奴隷:逸脱 = 200
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 250
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 370
    ELSE
        SOURCE:奴隷:反感 = 500
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 500
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ後背位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ後背位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;騎乗位アナル
@NTR_A_SEX_2(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ騎乗位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ騎乗位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 80
    BASE:奴隷:気力 -= 200
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 700
        SOURCE:奴隷:情愛 = 400
        SOURCE:奴隷:苦痛 = 400
    ELSE
        SOURCE:奴隷:快Ａ = 500
        SOURCE:奴隷:情愛 = 250
        SOURCE:奴隷:苦痛 = 800
    ENDIF
    SOURCE:奴隷:性行動 = 250
    SOURCE:奴隷:達成 = 250
    SOURCE:奴隷:露出 = 120
    SOURCE:奴隷:逸脱 = 700
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 450
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 670
    ELSE
        SOURCE:奴隷:反感 = 900
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 900
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ騎乗位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ騎乗位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;対面座位アナル
@NTR_A_SEX_3(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ対面座位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ対面座位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 70
    BASE:奴隷:気力 -= 150
    SOURCE:奴隷:快Ｃ = 250
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 600
        SOURCE:奴隷:情愛 = 500
        SOURCE:奴隷:苦痛 = 400
    ELSE
        SOURCE:奴隷:快Ａ = 350
        SOURCE:奴隷:情愛 = 350
        SOURCE:奴隷:苦痛 = 800
    ENDIF
    SOURCE:奴隷:恭順 = 300
    SOURCE:奴隷:逸脱 = 800
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 600
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 900
    ELSE
        SOURCE:奴隷:反感 = 1200
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 900
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ対面座位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ対面座位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;背面座位アナル
@NTR_A_SEX_4(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ背面座位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ背面座位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 70
    BASE:奴隷:気力 -= 150
    SOURCE:奴隷:快Ｃ = 250
    SOURCE:奴隷:快Ｂ = 250
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 500
        SOURCE:奴隷:情愛 = 450
        SOURCE:奴隷:苦痛 = 300
    ELSE
        SOURCE:奴隷:快Ａ = 350
        SOURCE:奴隷:情愛 = 350
        SOURCE:奴隷:苦痛 = 700
    ENDIF
    SOURCE:奴隷:露出 = 200
    SOURCE:奴隷:逸脱 = 800
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 600
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 900
    ELSE
        SOURCE:奴隷:反感 = 1200
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 900
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ背面座位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ背面座位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;対面立位アナル
@NTR_A_SEX_5(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ対面立位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ対面立位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 80
    BASE:奴隷:気力 -= 120
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 600
        SOURCE:奴隷:情愛 = 200
        SOURCE:奴隷:苦痛 = 400
    ELSE
        SOURCE:奴隷:快Ａ = 400
        SOURCE:奴隷:情愛 = 100
        SOURCE:奴隷:苦痛 = 800
    ENDIF
    SOURCE:奴隷:露出 = 60
    SOURCE:奴隷:逸脱 = 200
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 250
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 340
    ELSE
        SOURCE:奴隷:反感 = 500
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 500
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++ 
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++ 
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 ++ 
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ対面立位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ対面立位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;背面立位アナル
@NTR_A_SEX_6(奴隷,調教者=人物_訪問者)
#DIM 奴隷
#DIM 調教者
TEQUIP:奴隷:Ａセックス = 調教者
    ;性交時メッセージ・口上の前に設定
FLAG:訪問者との行為 = NTR_行為_Ａ背面立位
CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ背面立位
CALL NTR_A_SEX_MSG_KOJO(奴隷)
IF FLAG:訪問者との行為の終了時刻 == 0
    BASE:奴隷:体力 -= 80
    BASE:奴隷:気力 -= 120
    IF TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:快Ａ = 600
        SOURCE:奴隷:情愛 = 200
        SOURCE:奴隷:苦痛 = 400
    ELSE
        SOURCE:奴隷:快Ａ = 400
        SOURCE:奴隷:情愛 = 100
        SOURCE:奴隷:苦痛 = 900
    ENDIF
    SOURCE:奴隷:露出 = 80
    SOURCE:奴隷:逸脱 = 200
    IF TALENT:奴隷:NTR || TALENT:奴隷:浮気な尻穴
        SOURCE:奴隷:反感 = 250
    ELSEIF CFLAG:奴隷:屈服度 > 1000
        SOURCE:奴隷:反感 = 340
    ELSE
        SOURCE:奴隷:反感 = 500
    ENDIF
    SIF TALENT:奴隷:自己愛 < 0 || TALENT:奴隷:抵抗
        SOURCE:奴隷:鬱屈 += 500
    IF 訪問者_Ｐ大きさ == 2
        EXP:奴隷:Ａ拡張経験 += 1
        SIF GETBIT(FLAG:ＮＴＲパッチ設定,32) || CFLAG:MASTER:現在位置 == CFLAG:奴隷:現在位置
            PRINTFORML %CALLNAME:奴隷%のアヌスは、%NTR_NAME(0)%の大きすぎるペニスによって拡張されている…
        IF ( TALENT:奴隷:マゾ || ABL:奴隷:マゾっ気 > 2 ) && EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:欲情 += 500
            CUP:奴隷:苦痛 += 250
        ELSEIF EXP:奴隷:Ａ拡張経験 < 450
            CUP:奴隷:苦痛 += 500
        ENDIF
    ENDIF
    EXP:奴隷:Ａ経験 ++
    EXP:奴隷:Ａ性交経験 ++
    SIF !TALENT:奴隷:親愛
        EXP:奴隷:浮気Ａ性交経験 ++
    SIF TALENT:奴隷:親愛
        EXP:奴隷:被強姦経験 += 1
    CALL NTR_GET_WEAKNESS_2(奴隷)
    FLAG:訪問者との行為の終了時刻 = DATETIME() + (RAND:30 + 30)
    FLAG:訪問者との行為 = NTR_行為_Ａ背面立位
    CFLAG:奴隷:訪問者行為 = NTR_行為_Ａ背面立位
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;キス終了（絶頂）
;@return 常に0
@NTR_KISS_FINISH(奴隷)
#DIM 奴隷
CALL NTR_KISS_PET_FELLA_MSG_KOJO_2(奴隷, 2)
RETURN 0

;-------------------------------------------------------------------------------
;愛撫終了（絶頂）
;@return 常に0
@NTR_PET_FINISH(奴隷)
#DIM 奴隷
CALL NTR_KISS_PET_FELLA_MSG_KOJO_2(奴隷, 3)
RETURN 0

;-------------------------------------------------------------------------------
;胸愛撫終了（絶頂）
;@return 常に0
@NTR_BUST_PET_FINISH(奴隷)
#DIM 奴隷
CALL NTR_KISS_PET_FELLA_MSG_KOJO_2(奴隷, 4)
RETURN 0

;-------------------------------------------------------------------------------
;フェラチオ終了（絶頂）
;@return 常に0
@NTR_FELLATIO_FINISH(奴隷)
#DIM 奴隷
CALL NTR_KISS_PET_FELLA_MSG_KOJO_2(奴隷, 5)
CALL EJACULATION_M(奴隷, 人物_訪問者)
EXP:奴隷:口淫経験 ++
SIF !TALENT:奴隷:親愛
    EXP:奴隷:浮気口淫経験 ++
RETURN 0

;-------------------------------------------------------------------------------
;シックスナイン終了（絶頂）
;@return 常に0
@NTR_69_FINISH(奴隷)
#DIM 奴隷
CALL NTR_KISS_PET_FELLA_MSG_KOJO_2(奴隷, 6)
CALL EJACULATION_M(奴隷, 人物_訪問者)
EXP:奴隷:口淫経験 ++
SIF !TALENT:奴隷:親愛
    EXP:奴隷:浮気口淫経験 ++
RETURN 0

;-------------------------------------------------------------------------------
;素股終了（絶頂）
;@return 常に0
@NTR_THUG_FINISH(奴隷)
#DIM 奴隷
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    PRINTFORMW 【%NTR_GETPLACENAME(FLAG:訪問者の現在位置)%】で%CALLNAME:奴隷%の股にはさんだ%NTR_NAME(0)%のペニスから勢いよく精液が噴き出した
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_7_2(奴隷)
        FUNC NTR_KOJO_K_7_2(奴隷)
    ENDFUNC
ENDIF
CALL NTR_SEMEN_STAIN(奴隷)
EXP:奴隷:精液経験 ++
SIF !TALENT:奴隷:親愛
    EXP:奴隷:浮気精液経験 ++
TRYCALL 精力取得, 人物_訪問者
    ;素股で口は汚れなくていいと思う
    ;TRYCALL NTR_SAMEN_EXP_PLUS(奴隷, 1)
    ;SETBIT STAIN:奴隷:口,2
    ;CLEARBIT FLAG:訪問者との汚れ判定に使用,2
CFLAG:奴隷:射精者V = 人物_訪問者
RETURN 0

;-------------------------------------------------------------------------------
;性交終了（絶頂）
;@return 常に0
@NTR_SEX_FINISH(奴隷)
#DIM 奴隷
CALL NTR_SEX_FINISH_MSG_KOJO(奴隷)
CALL EJACULATION_V(奴隷, 人物_訪問者)
EXP:奴隷:Ｖ絶頂経験 ++
EXP:奴隷:絶頂経験 ++
IF !TALENT:奴隷:親愛
    EXP:奴隷:浮気絶頂経験 ++
ENDIF
SIF TALENT:奴隷:親愛
    EXP:奴隷:被強姦経験 ++
    ;V感覚が高いと絶頂経験加算（強絶頂扱い）
CALL NTR_V_EXP_PLUS(奴隷)
SIF RAND:3 == 0
    CALL NTR_PUNISHMENT_10(奴隷, 0)
RETURN 0

;-------------------------------------------------------------------------------
;アナル性交終了（絶頂）
;@return 常に0
@NTR_A_SEX_FINISH(奴隷)
#DIM 奴隷
CALL NTR_A_SEX_FINISH_MSG_KOJO(奴隷)
CALL EJACULATION_A(奴隷, 人物_訪問者)
EXP:奴隷:Ａ絶頂経験 ++
EXP:奴隷:絶頂経験 ++
IF !TALENT:奴隷:親愛
    EXP:奴隷:浮気絶頂経験 ++
ENDIF     
SIF TALENT:奴隷:親愛
    EXP:奴隷:被強姦経験 ++
    ;A感覚が高いと絶頂経験加算（強絶頂扱い）
CALL NTR_A_EXP_PLUS(奴隷)
SIF RAND:3 == 0
    CALL NTR_PUNISHMENT_10(奴隷, 1)
RETURN 0

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@NTR_SEMEN_STAIN(奴隷)
#DIM 奴隷
#DIM 判定値
判定値 = CFLAG:奴隷:睡眠 ? 0 # 1 + TALENT:奴隷:幼稚
FLAG:(100 + CFLAG:奴隷:現在位置) = MAX(FLAG:(100 + CFLAG:奴隷:現在位置) + 判定値 * TIME_PROGRESS(TFLAG:300),0)
FLAG:(100 + CFLAG:奴隷:現在位置) = MIN(FLAG:(100 + CFLAG:奴隷:現在位置),6000)

;-------------------------------------------------------------------------------
;訪問者によるお仕置き
@NTR_PUNISHMENT(奴隷)
#DIM 奴隷
#DIM 仕置き行為
#DIM 仕置き行為上限
    ;あなた限定
IF 奴隷 == 0
    CALL NTR_PUNISHMENT_2(0)
        ;その他住人
ELSE
    仕置き行為上限=1
        ;公衆便所
    IF TALENT:奴隷:公衆便所
        仕置き行為上限=5
            ;寝取られ
    ELSEIF TALENT:奴隷:NTR
        仕置き行為上限=4
    ELSE
            ;行為種別で分岐
        IF FLAG:訪問者のムード == 2
            仕置き行為上限=1
        ELSEIF FLAG:訪問者のムード == 3
            仕置き行為上限=2
        ELSEIF FLAG:訪問者のムード == 4
            仕置き行為上限=3
        ENDIF
    ENDIF
    仕置き行為 = RAND:仕置き行為上限
    IF 仕置き行為 > 3
        仕置き行為 = 3
    ENDIF
        ;処女にローターV挿入はしない
    IF TALENT:奴隷:処女
        IF 仕置き行為 == 2
            仕置き行為 = 0
        ELSEIF 仕置き行為 == 3
            仕置き行為 = 1
        ENDIF
    ENDIF
        ;公衆便所にノーパンはない
    IF TALENT:奴隷:公衆便所 && 仕置き行為 == 0
        仕置き行為 = 1
    ENDIF
        ;結果に応じて処理
    IF 仕置き行為 == 3
        CALL NTR_PUNISHMENT_3(奴隷)
    ELSEIF 仕置き行為 == 2
        CALL NTR_PUNISHMENT_1(奴隷)
    ELSEIF 仕置き行為 == 1
        CALL NTR_PUNISHMENT_2(奴隷)
    ELSE
        CALL NTR_PUNISHMENT_0(奴隷)
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;パンツを脱がせる
@NTR_PUNISHMENT_0(奴隷)
#DIM 奴隷
SIF !CFLAG:奴隷:服装_下半身下着２
    RETURN 1
CFLAG:奴隷:服装_下半身下着２ = 0
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の下着を奪って
    PRINTFORML 今日一日ノーパンで過ごすように命令し着衣の乱れを整えさせた…
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_15_0(奴隷)
        FUNC NTR_KOJO_K_15_0(奴隷)
    ENDFUNC
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;ローター挿入
@NTR_PUNISHMENT_1(奴隷)
#DIM 奴隷
SIF !HAS_VAGINA(奴隷)
    RETURN 1
SIF CFLAG:奴隷:ローター挿入 != 0
    RETURN 1
IF TALENT:奴隷:処女
    CALL NTR_PUNISHMENT_2(奴隷)
    RETURN 0
ENDIF
CFLAG:奴隷:ローター挿入 = 240
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    IF TALENT:奴隷:公衆便所
        PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の秘所にローターを挿入して固定すると
        PRINTFORML その上から貞操帯を装着させ鍵をかけた。
        PRINTFORML そしてしばらくそのままで居るように命令して着衣の乱れを整えさせた…
    ELSE
        PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の秘所にローターを挿入して固定すると
        PRINTFORML しばらくそのままで居るように命令して着衣の乱れを整えさせた…
    ENDIF
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_15_1(奴隷)
        FUNC NTR_KOJO_K_15_1(奴隷)
    ENDFUNC
    CFLAG:奴隷:ローター挿入者 = 人物_訪問者
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;ローターA挿入
@NTR_PUNISHMENT_2(奴隷)
#DIM 奴隷
SIF CFLAG:奴隷:ローターA挿入 != 0
    RETURN 1
CFLAG:奴隷:ローターA挿入 = 240
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    IF TALENT:奴隷:公衆便所
        PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%のアヌスにローターを挿入して固定し
        PRINTFORML その上から貞操帯を装着させ鍵をかけた。
        PRINTFORML そしてしばらくそのままで居るように命令して着衣の乱れを整えさせた…
    ELSE
        PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%のアヌスにローターを挿入して固定し
        PRINTFORML しばらくそのままで居るように命令して着衣の乱れを整えさせた…
    ENDIF
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_15_2(奴隷)
        FUNC NTR_KOJO_K_15_2(奴隷)
    ENDFUNC
    CFLAG:奴隷:ローター挿入者 = 人物_訪問者
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;ローター前後挿入
@NTR_PUNISHMENT_3(奴隷)
#DIM 奴隷
IF !HAS_VAGINA(奴隷)
    CALL NTR_PUNISHMENT_2(奴隷)
    RETURN 0
ENDIF
CFLAG:奴隷:ローター挿入 = 240
CFLAG:奴隷:ローターA挿入 = 240
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    IF TALENT:奴隷:公衆便所
        PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の秘所とアヌスにローターを挿入して固定し
        PRINTFORML その上から貞操帯を装着させ鍵をかけた。
        PRINTFORML そしてしばらくそのままで居るように命令して着衣の乱れを整えさせた…
    ELSE
        PRINTFORML %NTR_NAME(0)%は%CALLNAME:奴隷%の秘所とアヌスにローターを挿入して固定し
        PRINTFORML しばらくそのままで居るように命令して着衣の乱れを整えさせた…
    ENDIF
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_15_3(奴隷)
        FUNC NTR_KOJO_K_15_3(奴隷)
    ENDFUNC
    CFLAG:奴隷:ローター挿入者 = 人物_訪問者
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;精液残留
;奴隷 … 対象者コード
;部位 … 0:膣内 1:アナル
@NTR_PUNISHMENT_10(奴隷, 部位)
#DIM 奴隷
#DIM 部位
SIF !HAS_VAGINA(奴隷)
    RETURN 1
SIF CFLAG:奴隷:精液残留中 != 0
    RETURN 1
CFLAG:奴隷:精液残留中 = 40
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    PRINTFORML 
    IF 部位 == 0
        PRINTFORML %NTR_NAME(0)%によって注ぎ込まれた大量の精液は、溢れ出てくるのを拒否するかのように%CALLNAME:奴隷%の膣内に留まっている…
    ELSE
        PRINTFORML %NTR_NAME(0)%によって注ぎ込まれた大量の精液は、溢れ出てくるのを拒否するかのように%CALLNAME:奴隷%の腸内に留まっている…
    ENDIF
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_15_10(奴隷)
        FUNC NTR_KOJO_K_15_10(奴隷)
    ENDFUNC
ENDIF
RETURN 0

;-----------------------------------------------------------
;公衆便所の貞操帯チェック
@NTR_LOCK(奴隷)
#FUNCTION
#DIM 奴隷
IF TALENT:奴隷:公衆便所
        ;鍵を持っていたらロック解除
    IF FLAG:貞操帯鍵購入フラグ == 奴隷
        RETURNF 0
    ENDIF
    RETURNF 1
ELSE
    RETURNF 0
ENDIF

;-----------------------------------------------------------
;公衆便所利用権のお値段を求める
;@param 奴隷     キャラクターの番号
;@param 鍵の種類 鍵の種類（ビット演算）
;    0b00000001:ニプルシールド
;    0b00000010:フルカップ
;    0b00000100:ブラジャー
;    0b00001000:アナルシールド
;    0b00010000:リアシールド
;    0b00100000:自慰防止板
;    0b01000000:フロントシールド
;    0b10000000:ウエストベルト
;@return 鍵のお値段
@NTR_COST_UNLOCK(奴隷, 鍵の種類)
#FUNCTION
#DIM 奴隷
#DIM 鍵の種類
#DIM 基本価格
#DIM 基本倍率
#DIM 購入価格
SIF 鍵の種類 == 0
    鍵の種類 = 0b11111000
    ;素質により基本価格決定。
基本価格 = MAX(TALENT:奴隷:淫乱*10,10)
基本価格 += LIMIT(TALENT:奴隷:性的魅力*3,0,3)
    ;部位の技能が高いほどお値段も高くなります。
基本倍率 = 1
IF GETBIT(鍵の種類,0) ;乳首権
    基本倍率 += LIMIT(ABL:奴隷:Ｂ感覚,1,2)
ENDIF
IF GETBIT(鍵の種類,1) ;乳房権
    基本倍率 += LIMIT(ABL:奴隷:胸,0,2)
ENDIF
IF GETBIT(鍵の種類,2) ;上半身権
    基本倍率 += LIMIT(ABL:奴隷:胸,0,2)
ENDIF
IF GETBIT(鍵の種類,3) ;Ａ愛撫権
    基本倍率 += LIMIT(ABL:奴隷:Ａ感覚,1,2)
ENDIF
IF GETBIT(鍵の種類,4) ;Ａ挿入権
    基本倍率 += (LIMIT(ABL:奴隷:アナル,0,3) + LIMIT(ABL:奴隷:腰,0,3)) / ((BASE:奴隷:Ａ緩さ>700)+(BASE:奴隷:Ａ緩さ>450)+(BASE:奴隷:Ａ緩さ>250)+1)
ENDIF
IF GETBIT(鍵の種類,5) ;Ｃ愛撫権
    基本倍率 += LIMIT(ABL:奴隷:Ｃ感覚,1,2)
ENDIF
IF GETBIT(鍵の種類,6) ;Ｖ挿入権
    基本倍率 += (LIMIT(ABL:奴隷:Ｖ感覚,1,2) + LIMIT(ABL:奴隷:膣,0,3) + LIMIT(ABL:奴隷:腰,0,3)) / ((BASE:奴隷:Ｖ緩さ>700)+(BASE:奴隷:Ｖ緩さ>450)+(BASE:奴隷:Ｖ緩さ>250)+1)
ENDIF
IF GETBIT(鍵の種類,7) ;種付け権
    基本倍率 += (LIMIT(ABL:奴隷:Ｖ感覚,1,100)+LIMIT(ABL:奴隷:膣,1,100)+LIMIT(ABL:奴隷:腰,1,100)) / ((BASE:奴隷:Ｖ緩さ>700)+(BASE:奴隷:Ｖ緩さ>450)+(BASE:奴隷:Ｖ緩さ>250)+1)
ENDIF
    ;妊娠していると半額。逆に妊娠していなくて危険日だと5割増
IF TALENT:奴隷:妊娠
    基本倍率 /= 2
ELSEIF TALENT:奴隷:危険日
    基本倍率 *= 2
    基本倍率 /= 2
ENDIF
DEBUGPRINTFORML %"『"+CALLNAME:奴隷+"』の素質による基本価格:"+TOSTR(基本価格)+"、技能による基本倍率:"+TOSTR(基本倍率)%
SELECTCASE 奴隷
    CASE 人物_美鈴
        購入価格 = ( 基本価格 * 基本倍率 *  5 ) 
    CASE 人物_小悪魔
        購入価格 = ( 基本価格 * 基本倍率 *  5 )
    CASE 人物_パチュリー
        購入価格 = ( 基本価格 * 基本倍率 *  7 )
    CASE 人物_咲夜
        購入価格 = ( 基本価格 * 基本倍率 *  6 )
    CASE 人物_レミリア
        購入価格 = ( 基本価格 * 基本倍率 * 10 )
    CASE 人物_フラン
        購入価格 = ( 基本価格 * 基本倍率 * 10 )
    CASE 人物_子悪魔
        購入価格 = ( 基本価格 * 基本倍率 *  5 )
    CASE 人物_チルノ
        購入価格 = ( 基本価格 * 基本倍率 *  3 )
    CASE 人物_大妖精
        購入価格 = ( 基本価格 * 基本倍率 *  3 )
    CASE 人物_魔理沙
        購入価格 = ( 基本価格 * 基本倍率 *  5 )
    CASE 人物_霊夢
        購入価格 = ( 基本価格 * 基本倍率 * 10 )
    CASE 人物_ルーミア
        購入価格 = ( 基本価格 * 基本倍率 *  3 )
    CASE 人物_アリス
        購入価格 = ( 基本価格 * 基本倍率 *  7 )
    CASEELSE ;その他
        購入価格 = ( 基本価格 * 基本倍率 *  5 )
ENDSELECT
RETURNF 購入価格

;-----------------------------------------------------------
;公衆便所利用権のお値段を求める（あなた向け特別価格）
@NTR_COST_UNLOCK_SP(奴隷,価格)
#FUNCTION
#DIM 奴隷
#DIM 価格
    ;「あなた」向けのペナルティ。寝取り返す事に対するお仕置きとして、陥落回数で金額が飛躍的に伸びます。
DEBUGPRINTFORML %"『"+CALLNAME:奴隷+"』の修正前価格:"+TOSTR(価格)%
価格 = 価格 + ( 価格 * EXP:奴隷:NTR陥落経験*EXP:奴隷:NTR陥落経験 /100 )
    ;「あなた」向けのペナルティ。恋人だと買えば買うほどお値段割増。
IF TALENT:奴隷:恋慕
    IF TALENT:奴隷:人妻
        価格 = 価格 + ( 価格 * SQRT(EXP:MASTER:買春経験) / 6 )
    ELSE
        価格 = 価格 + ( 価格 * SQRT(EXP:MASTER:買春経験) / 10 )
    ENDIF
ENDIF
    ;「あなた」向けのペナルティ。浮気公認してるとその分お値段割増。
IF TALENT:奴隷:浮気公認
    価格 = 価格 + ( 価格 * TALENT:奴隷:浮気公認 / 10 )
ENDIF
DEBUGPRINTFORML %"『"+CALLNAME:奴隷+"』の修正後価格:"+TOSTR(価格)%
RETURNF 価格

;-----------------------------------------------------------
;貞操帯の鍵を発見した時の反応
;奴隷…発見したキャラクター
@NTR_LOCK_REACTION(奴隷)
#DIM 奴隷
    ;鍵を持っていなければ処理なし
IF !FLAG:貞操帯鍵購入フラグ
    RETURN 0
ENDIF
    ;一度反応しているのならそれ以上は反応しない
IF !CFLAG:奴隷:NTR貞操帯反応
    RETURN 0
ENDIF
    ;本人の鍵かどうかで反応が変わる
IF FLAG:貞操帯鍵購入フラグ == 奴隷
        ;買われた本人の反応
    PRINTFORM %CALLNAME:MASTER%が持っている鍵を見つけた%CALLNAME:奴隷%は、
    IF TALENT:奴隷:親愛
        PRINTFORMW 自分を繋ぎとめてくれようとしているのだと喜んでいる。
        CFLAG:奴隷:好感度 += 100
    ELSE
        PRINTFORMW %NTR_NAME(0)%の役に立てて喜んでいる。
        CFLAG:奴隷:好感度 += 50
    ENDIF
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_16_0(奴隷)
        FUNC NTR_KOJO_K_16_0(奴隷)
    ENDFUNC
    PRINTFORMW 
ELSE
        ;本人以外の鍵を見つけた場合
    PRINTFORM %CALLNAME:MASTER%が持っている鍵を見つけた%CALLNAME:奴隷%は、
    IF TALENT:奴隷:公衆便所  && TALENT:奴隷:親愛 
        PRINTFORMW 悲しそうなまなざしで%CALLNAME:MASTER%を見つめた。
        CFLAG:奴隷:好感度 -= 100
    ELSEIF TALENT:奴隷:公衆便所
        PRINTFORMW %NTR_NAME(0)%のためになることだと喜んでいる。
    ELSEIF TALENT:奴隷:NTR
        PRINTFORMW %NTR_NAME(0)%のためになることだと喜んでいる。
    ELSEIF TALENT:奴隷:恋慕
        PRINTFORMW 軽蔑のまなざしで%CALLNAME:MASTER%を睨んだ。
        CFLAG:奴隷:好感度 -= 500
    ELSEIF 奴隷==人物_美鈴 || 奴隷==人物_パチュリー || 奴隷==人物_咲夜 || 奴隷==人物_レミリア || 奴隷==人物_魔理沙 || 奴隷==人物_霊夢 || 奴隷==人物_アリス
        PRINTFORMW 軽蔑のまなざしで%CALLNAME:MASTER%を睨んだ。
        CFLAG:奴隷:好感度 -= 200
    ELSE
        PRINTFORMW 呆れたようなまなざしで%CALLNAME:MASTER%を見つめた。
        CFLAG:奴隷:好感度 -= 100
    ENDIF
    TRYCALLLIST
        FUNC NTR_KOJO_K{CFLAG:奴隷:297}_16_1(奴隷)
        FUNC NTR_KOJO_K_16_1(奴隷)
    ENDFUNC
    PRINTFORMW 
ENDIF
    ;反応フラグ解除
CFLAG:奴隷:NTR貞操帯反応 = 0
RETURN 1

;-------------------------------------------------------------------------------
;コマンドに応じた貞操帯鍵購入反応呼び出し
@NTR_LOCK_REACTION_COM(奴隷)
#DIM 奴隷
    ;貞操帯購入チェックの必要なコマンド一覧
    ;アナル愛撫、クリ愛撫、指挿れ
IF SELECTCOM == 314 || SELECTCOM == 315 || SELECTCOM == 316 
    CALL NTR_LOCK_REACTION(奴隷)
ENDIF
RETURN 1

;-------------------------------------------------------------------------------
;同行者への影響チェック
@NTR_CHK_GOWITH(経過時間)
#DIM 経過時間
#DIM LOOP_CHR
FOR LOOP_CHR,1,CHARANUM
        ;訪問者の影響
    IF CFLAG:LOOP_CHR:現在位置 == FLAG:訪問者の現在位置
        IF CFLAG:LOOP_CHR:同行 
                ;NTRなら即座に同行解除
            IF TALENT:LOOP_CHR:NTR
                CFLAG:LOOP_CHR:同行 = 0
                TRYCALLLIST
                    FUNC NTR_KOJO_K{LOOP_CHR}_21(LOOP_CHR)
                    FUNC NTR_KOJO_K_21(LOOP_CHR)
                ENDFUNC
                PRINTFORMW %CALLNAME:LOOP_CHR%は%CALLNAME:MASTER%から離れ%NTR_NAME(0)%の方に歩いていった。
            ELSE
                    ;ただいるだけで影響あり
                    ;寝取られそうだと影響大
                IF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_主人より高い)
                    CFLAG:LOOP_CHR:同行 = MAX(CFLAG:LOOP_CHR:同行 - 経過時間 * 2, 0)
                ELSE
                    CFLAG:LOOP_CHR:同行 = MAX(CFLAG:LOOP_CHR:同行 - 経過時間, 0)
                ENDIF
                IF CFLAG:LOOP_CHR:同行 == 0
                        ;別れる前に一声
                    TRYCALLLIST
                        FUNC NTR_KOJO_K{LOOP_CHR}_21(LOOP_CHR)
                        FUNC NTR_KOJO_K_21(LOOP_CHR)
                    ENDFUNC
                    IF RESULT != 1
                        IF NTR_CHK_FAVORABLY(LOOP_CHR, FAV_主人より高い)
                            PRINTFORMW %CALLNAME:LOOP_CHR%は%CALLNAME:MASTER%から離れ%NTR_NAME(0)%の方に歩いていった。
                        ELSE
                            PRINTFORMW %CALLNAME:LOOP_CHR%は%CALLNAME:MASTER%から離れた。
                        ENDIF
                    ENDIF
                ELSE
                    TRYCALLLIST
                        FUNC NTR_KOJO_K{LOOP_CHR}_22(LOOP_CHR)
                        FUNC NTR_KOJO_K_22(LOOP_CHR)
                    ENDFUNC
                    IF RESULT != 1
                        PRINTFORMW %CALLNAME:LOOP_CHR%は%NTR_NAME(0)%が気になるようだ。
                    ENDIF
                ENDIF
            ENDIF
        ENDIF
    ENDIF
NEXT
RETURN

;-------------------------------------------------------------------------------
;施錠可否判定
@IS_CAN_LOCK(場所)
#FUNCTION
#DIM 場所
SIF 場所 == 場所_正門
    RETURNF 0
SIF 場所 == 場所_広間
    RETURNF 0
SIF 場所 == 場所_庭
    RETURNF 0
SIF 場所 == 場所_二階踊り場
    RETURNF 0
SIF 場所 == 場所_二階廊下
    RETURNF 0
SIF 場所 == 場所_あなた私室
    RETURNF 0
SIF 場所 == 場所_湖
    RETURNF 0
SIF 場所 == 場所_湖南部
    RETURNF 0
SIF 場所 == 場所_魔法の森内部
    RETURNF 0
RETURNF 1

;-------------------------------------------------------------------------------
;NTRカウンター関連
;住人が訪問者に対して軽いセクハラを実行
@NTR_COUNTER(奴隷)
#DIM 奴隷
#DIM セクハラ行為
#DIM セクハラ行為上限
セクハラ行為 = NTR_CNT_なし
セクハラ行為上限 = NTR_CNT_なし
IF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ)
    セクハラ行為上限 = NTR_CNT_ディープキス
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ寸前)
    SIF RAND:2
        セクハラ行為上限 = NTR_CNT_ディープキス
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られそう)
        ;主人も同席
    IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            ;浮気公認レベルで変化
        IF TALENT:奴隷:浮気公認 == 0
            SIF RAND:3
                セクハラ行為上限 = NTR_CNT_股間をまさぐる
        ELSE
            SIF RAND:2
                セクハラ行為上限 = NTR_CNT_ディープキス
        ENDIF
            ;主人不在
    ELSE
        SIF RAND:2
            セクハラ行為上限 = NTR_CNT_ディープキス
    ENDIF
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_主人より高い)
        ;主人も同席
    IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            ;浮気公認レベルで変化
        IF TALENT:奴隷:浮気公認 == 0
            SIF RAND:3
                セクハラ行為上限 = NTR_CNT_キス
        ELSEIF TALENT:奴隷:浮気公認 == 1
            SIF RAND:2
                セクハラ行為上限 = NTR_CNT_股間をまさぐる
        ELSE
            SIF RAND:2
                セクハラ行為上限 = NTR_CNT_ディープキス
        ENDIF
            ;主人不在
    ELSE
        SIF RAND:2
            セクハラ行為上限 = NTR_CNT_ディープキス
    ENDIF
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_うふふする程度)
        ;主人も同席
    IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置 
        SIF RAND:4
            セクハラ行為上限 = NTR_CNT_耳元に息
            ;主人不在
    ELSE
        SIF RAND:3
            セクハラ行為上限 = NTR_CNT_対面抱擁
    ENDIF
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_奉仕する程度)
        ;主人も同席
    IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
        SIF RAND:5
            セクハラ行為上限 = NTR_CNT_見つめる
            ;主人不在
    ELSE
        SIF RAND:4
            セクハラ行為上限 = NTR_CNT_キス
    ENDIF
ELSE
    セクハラ行為上限 = NTR_CNT_なし
ENDIF
    ;寝ていたらカウンターはしない
IF CFLAG:奴隷:睡眠
    セクハラ行為上限 = NTR_CNT_なし
ENDIF
; 訪問者のムードによる補正
SELECTCASE FLAG:訪問者のムード
    CASE NTR_MOOD_会話
        セクハラ行為上限 = MIN(セクハラ行為上限, NTR_CNT_見つめる)
    CASE NTR_MOOD_キス
        セクハラ行為上限 = MIN(セクハラ行為上限, NTR_CNT_耳元に息)
    CASE NTR_MOOD_愛撫
        セクハラ行為上限 = MIN(セクハラ行為上限, NTR_CNT_キス)
ENDSELECT
;上限値をもとに行為を決定
IF セクハラ行為上限
    セクハラ行為 = RAND:(セクハラ行為上限+1)
ENDIF
IF セクハラ行為
    CALL NTR_COUNTER_DO(奴隷, セクハラ行為)
ENDIF
    ;NTRカウンター実行の保存
CFLAG:奴隷:NTRカウンターセクハラ = セクハラ行為
RETURN 1

;-------------------------------------------------------------------------------
;NTRカウンター実行
@NTR_COUNTER_DO(奴隷,セクハラ行為)
#DIM 奴隷
#DIM セクハラ行為
SELECTCASE セクハラ行為
    CASE NTR_CNT_色っぽいしぐさ
        SOURCE:奴隷:誘惑 += 150
        SOURCE:奴隷:挑発 += 50
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORMW %CALLNAME:奴隷%は色っぽい仕草で%NTR_NAME(0)%を誘惑した…
        ENDIF
    CASE NTR_CNT_見つめる
        SOURCE:奴隷:誘惑 += 80
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%を潤んだ瞳でじっと見つめている…
        ENDIF
    CASE NTR_CNT_身体摺り寄せ
        SOURCE:奴隷:誘惑 += 100
        SOURCE:奴隷:奉仕 += 100
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%に身体を摺り寄せた…
        ENDIF
    CASE NTR_CNT_耳元に息
        SOURCE:奴隷:誘惑 += 50
        SOURCE:奴隷:挑発 += 100
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%に近寄り耳元に息を吹きかけた…
        ENDIF
    CASE NTR_CNT_キス
        SOURCE:奴隷:誘惑 += 250
        SOURCE:奴隷:奉仕 += 100
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            PRINTFORM %CALLNAME:奴隷%は
                ;主人公より好意度がかなり高いか、浮気公認だと同席でも堂々とキスする
            IF CFLAG:奴隷:屈服度 > (CFLAG:奴隷:好感度 * 2) || TALENT:奴隷:浮気公認 > 0
                PRINTFORM %ANATA_LOVER(奴隷)%の目の前で
                IF TALENT:奴隷:浮気公認 > 0
                    PRINTFORM 堂々と
                ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ寸前)
                    PRINTFORM もはや隠そうともせずに
                ELSE
                ENDIF
            ELSE
                PRINTFORM %ANATA_LOVER(奴隷)%の目を盗んで
            ENDIF
            PRINTFORMW %NTR_NAME(0)%に唇を重ねた…
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%に唇を重ねた…
            ENDIF
        ENDIF
        EXP:奴隷:キス経験 ++
        EXP:奴隷:浮気キス経験 ++
        CALL LOST_VIRGIN_M(奴隷, 人物_訪問者)
        CALL NTR_ADD_SURRENDER(奴隷, 1)
        SIF TALENT:奴隷:浮気な唇
            CALL NTR_ADD_SURRENDER(奴隷, 1)
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            CFLAG:奴隷:同席目撃回数 ++
            CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, 1)
        ENDIF
    CASE NTR_CNT_背面抱擁
        SOURCE:奴隷:誘惑 += 300
        SOURCE:奴隷:奉仕 += 100
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            PRINTFORM %CALLNAME:奴隷%は
            PRINTFORM %ANATA_LOVER(奴隷)%の目の前で
            IF TALENT:奴隷:浮気公認 > 0
                PRINTFORM 堂々と
            ELSE
            ENDIF
            PRINTFORMW 背後から%NTR_NAME(0)%に抱きついた
            SIF TALENT:奴隷:バストサイズ > 0
                PRINTFORML %NTR_NAME(0)%の背中に%CALLNAME:奴隷%の柔らかな胸が押し当てられている…
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%は背後から%NTR_NAME(0)%に抱きついた
                SIF TALENT:奴隷:バストサイズ > 0
                    PRINTFORML %NTR_NAME(0)%の背中に%CALLNAME:奴隷%の柔らかな胸が押し当てられている…
            ENDIF
        ENDIF
    CASE NTR_CNT_対面抱擁
        SOURCE:奴隷:誘惑 += 300
        SOURCE:奴隷:奉仕 += 100
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            PRINTFORM %CALLNAME:奴隷%は
            PRINTFORM %ANATA_LOVER(奴隷)%の目の前で
            IF TALENT:奴隷:浮気公認 > 0
                PRINTFORM 堂々と
            ELSE
            ENDIF
            PRINTFORMW %NTR_NAME(0)%を抱きしめた
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%は%NTR_NAME(0)%を抱きしめた
            ENDIF
        ENDIF
    CASE NTR_CNT_胸を揉ませる
        SOURCE:奴隷:誘惑 += 300
        SOURCE:奴隷:奉仕 += 200
        SOURCE:奴隷:強要 += 200
        SOURCE:奴隷:快Ｂ += 200
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            PRINTFORM %CALLNAME:奴隷%は
            IF TALENT:奴隷:浮気公認 > 0
                PRINTFORM %ANATA_LOVER(奴隷)%の目の前で
            ELSE
            ENDIF
            IF TALENT:奴隷:浮気公認 > 0
                PRINTFORM 堂々と
            ELSE
            ENDIF
            IF TALENT:奴隷:バストサイズ > 0
                PRINTFORMW %NTR_NAME(0)%の手を取り、自分の胸を揉ませた…
            ELSE
                PRINTFORMW %NTR_NAME(0)%の手を取り、自分の胸を撫でさせた…
            ENDIF
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORM %CALLNAME:奴隷%は
                IF TALENT:奴隷:バストサイズ > 0
                    PRINTFORMW %NTR_NAME(0)%の手を取り、自分の胸を揉ませた…
                ELSE
                    PRINTFORMW %NTR_NAME(0)%の手を取り、自分の胸を撫でさせた…
                ENDIF
            ENDIF
        ENDIF
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    CASE NTR_CNT_股間をまさぐる
        SOURCE:奴隷:誘惑 += 300
        SOURCE:奴隷:挑発 += 200
        SOURCE:奴隷:奉仕 += 200
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            PRINTFORM %CALLNAME:奴隷%は頬を染めると
            IF TALENT:奴隷:浮気公認 > 0
                PRINTFORM %ANATA_LOVER(奴隷)%に見せつけるかのように
            ELSE
                PRINTFORM %ANATA_LOVER(奴隷)%の目の前で
            ENDIF
            PRINTFORMW %NTR_NAME(0)%の股間に手を伸ばしそっとまさぐった…
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORM %CALLNAME:奴隷%は頬を染めると
                PRINTFORMW %NTR_NAME(0)%の股間に手を伸ばしそっとまさぐった…
            ENDIF
        ENDIF
        CALL NTR_ADD_SURRENDER(奴隷, 1)
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            CFLAG:奴隷:同席目撃回数 ++
            CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, 2)
        ENDIF
    CASE NTR_CNT_スカートの中を見せる
        SOURCE:奴隷:誘惑 += 400
        SOURCE:奴隷:挑発 += 100
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORML %CALLNAME:奴隷%は\@ TALENT:奴隷:羞恥心 > 0 ? おずおずと # \@自分のスカートを捲り
            PRINTFORM %NTR_NAME(0)%の目の前に
            IF EQUIP:奴隷:下半身下着１
                IF GETBIT(FLAG:匂いフェチ,1) 
                    PRINTFORM %PANTS_DESCRIPTION(EQUIP:奴隷:下半身下着１)%%IRUINAME_SMELL(EQUIP:奴隷:下半身下着１)%%PANTSNAME(EQUIP:奴隷:下半身下着１)%
                ELSE
                    PRINTFORM %PANTS_DESCRIPTION(EQUIP:奴隷:下半身下着１)%%PANTSNAME(EQUIP:奴隷:下半身下着１)%
                ENDIF
            ELSEIF !EQUIP:奴隷:下半身下着２
                PRINTFORM スカートの中の何も着ていない下半身
            ELSE
                IF GETBIT(FLAG:匂いフェチ,1) 
                    PRINTFORM %PANTS_DESCRIPTION(EQUIP:奴隷:下半身下着２)%%IRUINAME_SMELL(EQUIP:奴隷:下半身下着２)%%PANTSNAME(EQUIP:奴隷:下半身下着２)%
                ELSE
                    PRINTFORM %PANTS_DESCRIPTION(EQUIP:奴隷:下半身下着２)%%PANTSNAME(EQUIP:奴隷:下半身下着２)%
                ENDIF
            ENDIF
            PRINTFORML を晒した…
        ENDIF
        CALL NTR_ADD_SURRENDER(奴隷, 1)
    CASE NTR_CNT_ディープキス
        SOURCE:奴隷:性行動 += 1000
        SOURCE:奴隷:誘惑 += 150
        SOURCE:奴隷:奉仕 += 150
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            PRINTFORM %CALLNAME:奴隷%は
            IF TALENT:奴隷:浮気公認 > 0
                PRINTFORM %ANATA_LOVER(奴隷)%に見せつけるかのように
            ELSE
                PRINTFORM %ANATA_LOVER(奴隷)%の目の前で
            ENDIF
            IF TALENT:奴隷:淫乱|| TALENT:奴隷:浮気な唇
                PRINTFORML %NTR_NAME(0)%に唇を重ねると情熱的に舌を絡め唾液を流し込んだ…
            ELSE
                PRINTFORML %NTR_NAME(0)%に唇を重ねると情熱的に舌を絡めた…
            ENDIF
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORM %CALLNAME:奴隷%は
                IF TALENT:奴隷:淫乱|| TALENT:奴隷:浮気な唇
                    PRINTFORML %NTR_NAME(0)%に唇を重ねると情熱的に舌を絡め唾液を流し込んだ…
                ELSE
                    PRINTFORML %NTR_NAME(0)%に唇を重ねると情熱的に舌を絡めた…
                ENDIF
            ENDIF
        ENDIF
        EXP:奴隷:キス経験 ++
        EXP:奴隷:浮気キス経験 ++
        CALL LOST_VIRGIN_M(奴隷, 人物_訪問者)
        CALL NTR_ADD_SURRENDER(奴隷, 2)
        SIF TALENT:奴隷:浮気な唇
            CALL NTR_ADD_SURRENDER(奴隷, 2)
        IF CFLAG:MASTER:現在位置 == FLAG:訪問者の現在位置
            CFLAG:奴隷:同席目撃回数 ++
            CFLAG:奴隷:同席目撃時行為 = MAX(CFLAG:奴隷:同席目撃時行為, 1)
        ENDIF
ENDSELECT
RETURN 1

;-------------------------------------------------------------------------------
;NTRカウンターに対するカウンター
@NTR_COUNTER_COUNTER(奴隷,行為上限)
#DIM 奴隷
#DIM 行為上限
#DIM ムード
#DIM 激化       ; 1:覗きバレ後行為エスカレート
ムード = 0
    ;RAND時激化 = 1
激化 = 0

    ;会話しかできない時は判定しない
IF 行為上限 == NTR_MOOD_会話
    RETURN NTR_MOOD_会話
ENDIF
    ;以下の判定で、最低でもキスはできるものとする。
SELECTCASE CFLAG:奴隷:NTRカウンターセクハラ
            ;色っぽいしぐさ
    CASE NTR_CNT_色っぽいしぐさ
            ;特に影響なし
        ムード = RAND:(行為上限+1)
        激化 = 1
            ;見つめる
    CASE NTR_CNT_見つめる
            ;1/2でキス
        IF RAND:2 == 0
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%に見つめられた%NTR_NAME(0)%は彼女の唇を奪った…
            ENDIF
            ムード = NTR_MOOD_キス
        ELSE
            ムード = RAND:(行為上限+1)
            激化 = 1
        ENDIF
            ;身体を摺り寄せる
    CASE NTR_CNT_身体摺り寄せ
            ;1/2で愛撫
        IF 行為上限 >= NTR_MOOD_愛撫 && RAND:2 == 0
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%と密着した%NTR_NAME(0)%は彼女の身体に触れた…
            ENDIF
            ムード = NTR_MOOD_愛撫
                ;1/2でキス
        ELSEIF 行為上限 >= NTR_MOOD_愛撫
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%と密着した%NTR_NAME(0)%は彼女の唇を奪った…
            ENDIF
            ムード = NTR_MOOD_キス
        ENDIF
            ;耳元に息を吹きかける
    CASE NTR_CNT_耳元に息
            ;特に影響なし
        ムード = RAND:(行為上限+1)
        激化 = 1
            ;キス
    CASE NTR_CNT_キス
            ;1/2で愛撫
        IF 行為上限 >= NTR_MOOD_愛撫 && RAND:2 == 0
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%にキスされた%NTR_NAME(0)%は彼女の身体に触れた…
            ENDIF
            ムード = NTR_MOOD_愛撫
            ;1/2でキス
        ELSE
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%ににキスされた%NTR_NAME(0)%はお望みとあらばと彼女の唇を奪った…
            ENDIF
            ムード = NTR_MOOD_キス
        ENDIF
            ;後ろから抱きつく
    CASE NTR_CNT_背面抱擁
            ;特に影響なし
        ムード = RAND:(行為上限+1)
        激化 = 1
            ;前から抱きつく
    CASE NTR_CNT_対面抱擁
            ;1/2でキス
        IF RAND:2
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%に抱きつかれた%NTR_NAME(0)%は彼女の唇を奪った…
            ENDIF
            ムード = NTR_MOOD_キス
        ELSE
            ムード = RAND:(行為上限+1)
            激化 = 1
        ENDIF
            ;胸を揉ませる
    CASE NTR_CNT_胸を揉ませる
            ;愛撫
        IF 行為上限 >= NTR_MOOD_愛撫
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%の胸を揉んだ%NTR_NAME(0)%は彼女の身体に触れた…
            ENDIF
            ムード = NTR_MOOD_愛撫
        ELSE
            ムード = RAND:(行為上限+1)
            激化 = 1
        ENDIF
            ;股間をまさぐる
    CASE NTR_CNT_股間をまさぐる
            ;奉仕
        IF 行為上限 >= NTR_MOOD_奉仕
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%に股間をまさぐられた%NTR_NAME(0)%はいきり立つものへの奉仕を求めた…
            ENDIF
            ムード = NTR_MOOD_奉仕
        ELSE
            ムード = RAND:(行為上限+1)
            激化 = 1
        ENDIF
            ;スカートの中を見せる
    CASE NTR_CNT_スカートの中を見せる
            ;性交
        IF 行為上限 >= NTR_MOOD_性交
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%の下半身に欲情した%NTR_NAME(0)%は彼女に性交奉仕を求めた…
            ENDIF
            ムード = NTR_MOOD_性交
                ;愛撫
        ELSEIF 行為上限 >= NTR_MOOD_愛撫
            ムード = NTR_MOOD_愛撫
        ELSE
            ムード = RAND:(行為上限+1)
            激化 = 1
        ENDIF
            ;ディープキス
    CASE NTR_CNT_ディープキス
            ;1/2で奉仕
        IF 行為上限 >= NTR_MOOD_奉仕 && RAND:2 == 0
            IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
                PRINTFORMW %CALLNAME:奴隷%の濃厚なキスに満足した%NTR_NAME(0)%は彼女に唇での奉仕を求めた…
            ENDIF
            ムード = NTR_MOOD_奉仕
        ELSE
            ムード = RAND:(行為上限+1)
            激化 = 1
        ENDIF
ENDSELECT
ムード = LIMIT(ムード, NTR_MOOD_会話, 行為上限)
IF 激化 && !IS_NTR_SOFT()
        ;覗きバレ後は行為エスカレート
    IF CFLAG:奴隷:覗き発覚回数 && FLAG:訪問者のムード < 2
        FLAG:訪問者のムード += 1
    ENDIF
ENDIF
RETURN ムード

;-------------------------------------------------------------------------------
;覗きバレした時の見せつけ
@NTR_SHOW_PEEP(奴隷)
#DIM 奴隷
IF CFLAG:奴隷:睡眠
    PRINTFORMW %NTR_NAME(0)%は%CALLNAME:MASTER%の視線に気づいたようだ
ELSE
    PRINTFORMW %NTR_NAME(0)%と%CALLNAME:奴隷%は%CALLNAME:MASTER%の視線に気づいたようだ
        ;NTR覗き発覚カウンタ更新
    CFLAG:奴隷:覗き発覚回数 ++
        ;NTR覗き発覚時行為コード更新
    CFLAG:奴隷:覗き発覚時行為 = MAX(CFLAG:奴隷:覗き発覚時行為, FLAG:訪問者との行為)
        ;会話以外の時覗きバレが２回目以降だと好意度低下
    IF FLAG:訪問者との行為 != 0 && CFLAG:奴隷:覗き発覚回数 > 1
            ;NTRの場合減らないものとする。
        SIF !TALENT:奴隷:NTR
            CFLAG:奴隷:好感度 --
        SIF CFLAG:奴隷:睡眠
            CFLAG:奴隷:好感度 --
    ENDIF
    SELECTCASE FLAG:訪問者との行為
                ;会話
        CASE 0
                ;単に話している時は何もなし
        CASE NTR_行為_キス
            CALL NTR_MESSAGE_KISS_SHOW(奴隷)
        CASE NTR_行為_愛撫
            CALL NTR_MESSAGE_PET_SHOW(奴隷)
        CASE NTR_行為_胸愛撫
            CALL NTR_MESSAGE_BUST_PET_SHOW(奴隷)
        CASE NTR_行為_フェラチオ
            CALL NTR_MESSAGE_FELLATIO_SHOW(奴隷)
        CASE NTR_行為_シックスナイン
            CALL NTR_MESSAGE_69_SHOW(奴隷)
        CASE NTR_行為_素股
            CALL NTR_MESSAGE_THUG_SHOW(奴隷)
                ;セックス
        CASE NTR_行為_Ｖ正常位 TO NTR_行為_Ｖ背面立位
            CALL NTR_MESSAGE_SEX_SHOW(奴隷)
                ;アナルセックス
        CASE NTR_行為_Ａ正常位 TO NTR_行為_Ａ背面立位
            CALL NTR_MESSAGE_A_SEX_SHOW(奴隷)
        CASEELSE
            PRINTW バグです
    ENDSELECT
ENDIF
RETURN 1

;-------------------------------------------------------------------------------
;主人空気化判定
;戻り値…0=空気じゃない 1=キス許容 2=おさわり許容 3=奉仕許容 4=セックス許容
@IS_AIR_MASTER(奴隷)
#FUNCTION
#DIM 奴隷
#DIM 結果
結果 = 0
    ;キス許容
SIF CFLAG:MASTER:屈服度 > 200
    結果 = 1
    ;おさわり許容
SIF CFLAG:MASTER:屈服度 > 400
    結果 = 2
    ;奉仕許容
SIF CFLAG:MASTER:屈服度 > 600
    結果 = 3
    ;セックス許容
SIF CFLAG:MASTER:屈服度 > 1000
    結果 = 4
    ;住人による補正
IF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ)
    結果 += 2
        ;寝とられ寸前
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られ寸前)
    結果 += 2
        ;寝とられそう
ELSEIF NTR_CHK_FAVORABLY(奴隷, FAV_寝取られそう)
    結果 += 1
        ;恋慕で主人への好意度高い
ELSEIF CFLAG:奴隷:屈服度 < CFLAG:奴隷:好感度 && TALENT:奴隷:恋慕
    結果 -= 1
ENDIF
    ;浮気を公認している場合その分足す
結果 += TALENT:奴隷:浮気公認
    ;デバッグ用
    ;結果 = 4
RETURNF 結果

;-------------------------------------------------------------------------------
;NTR性交時体位名取得
@NTR_GET_SEX_LAGE
#FUNCTIONS
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ正常位
    RETURNF "正常位"
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ後背位
    RETURNF "後背位"
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ騎乗位
    RETURNF "騎乗位"
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ対面座位
    RETURNF "対面座位"
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ背面座位
    RETURNF "背面座位"
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ対面立位
    RETURNF "対面立位"
SIF FLAG:訪問者との行為 == NTR_行為_Ｖ背面立位
    RETURNF "背面立位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ正常位
    RETURNF "正常位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ後背位
    RETURNF "後背位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ騎乗位
    RETURNF "騎乗位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ対面座位
    RETURNF "対面座位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ背面座位
    RETURNF "背面座位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ対面立位
    RETURNF "対面立位"
SIF FLAG:訪問者との行為 == NTR_行為_Ａ背面立位
    RETURNF "背面立位"
RETURNF "**バグ**"

;-------------------------------------------------------------------------------
;住人の訪問者に対する好感度チェック
;戻り値…1:条件成立 0:条件非成立
@NTR_CHK_FAVORABLY(奴隷, 好感度LV)
#FUNCTION
#DIM 奴隷
#DIM 好感度LV
#DIM 屈服度閾値
IF 好感度LV == FAV_寝取り返し寸前
    SIF TALENT:奴隷:NTR && CFLAG:奴隷:好感度 > 900
        RETURNF 1
ELSEIF 好感度LV == FAV_寝取り返し中
    SIF TALENT:奴隷:NTR && CFLAG:奴隷:好感度 > 500
        RETURNF 1
ELSEIF 好感度LV == FAV_寝取られ
    SIF TALENT:奴隷:NTR
        RETURNF 1
ELSEIF 好感度LV == FAV_寝取られ寸前
        ;判定基準をEVENTTURNEND()と同一に。
        ;従来どおりの判定をさせたい場合はELSEの場合のみ有効とすればよい
    IF TALENT:奴隷:浮気公認 > 0
        屈服度閾値 = (CFLAG:奴隷:好感度 * TALENT:奴隷:浮気公認 * 10 )
        SIF CFLAG:奴隷:屈服度 * 10 > 屈服度閾値 * 9
            RETURNF 1
    ELSEIF TALENT:奴隷:浮気癖
        屈服度閾値 = (2000-(500*TALENT:奴隷:淫乱))
        SIF CFLAG:奴隷:屈服度 * 10 > 屈服度閾値 * 9
            RETURNF 1
    ELSE
        SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 && CFLAG:奴隷:屈服度 > 2000 && 1000 > CFLAG:奴隷:好感度
            RETURNF 1
    ENDIF
ELSEIF 好感度LV == FAV_寝取られそう
        ;判定基準をEVENTTURNEND()と同一に。
        ;従来どおりの判定をさせたい場合はELSEの場合のみ有効とすればよい
    IF TALENT:奴隷:浮気公認 > 0
        屈服度閾値 = (CFLAG:奴隷:好感度 * TALENT:奴隷:浮気公認 * 10 )
        SIF CFLAG:奴隷:屈服度 > (屈服度閾値 - TALENT:奴隷:浮気公認 * 10 * 500)
            RETURNF 1
    ELSEIF TALENT:奴隷:浮気癖
        屈服度閾値 = (2000-(500*TALENT:奴隷:淫乱))
        SIF CFLAG:奴隷:屈服度 > (屈服度閾値 - 500) 
            RETURNF 1
    ELSE
        SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 && CFLAG:奴隷:屈服度 > 2000 && 1500 > CFLAG:奴隷:好感度
            RETURNF 1
    ENDIF
ELSEIF 好感度LV == FAV_主人より高い
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 && CFLAG:奴隷:屈服度 > 1000
        RETURNF 1
ELSEIF 好感度LV == FAV_うふふする程度2
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 * 5 / 6 && CFLAG:奴隷:屈服度 > 700
        RETURNF 1
ELSEIF 好感度LV == FAV_うふふする程度
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 * 3 / 4 && CFLAG:奴隷:屈服度 > 500
        RETURNF 1
ELSEIF 好感度LV == FAV_奉仕する程度
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 / 2 && CFLAG:奴隷:屈服度 > 400
        RETURNF 1
ELSEIF 好感度LV == FAV_体を触らせる程度
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 / 3 && CFLAG:奴隷:屈服度 > 150
        RETURNF 1
ELSEIF 好感度LV == FAV_キスする程度
    SIF CFLAG:奴隷:屈服度 > CFLAG:奴隷:好感度 / 4 && CFLAG:奴隷:屈服度 > 100
        RETURNF 1
ELSE
    PRINTFORML !!! バグ [{好感度LV}]
ENDIF
RETURNF 0

;-------------------------------------------------------------------------------
;訪問者行為のリセット
;@return 常に0
@NTR_RESET_VISITOR_ACTION(奴隷)
#DIM 奴隷
FLAG:訪問者のムード = 0
FLAG:訪問者との行為の終了時刻 = 0
FLAG:訪問者との行為 = NTR_行為_なし
IF 奴隷 >= 0
    CFLAG:奴隷:訪問者行為 = NTR_行為_なし
    CFLAG:奴隷:処女喪失中 = 0
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;NTR文を表示できるか評価する。CAN_MOVE、同じ場所、FLAG:訪問者との汚れ判定に使用の32bit目で評価。
;戻り値…1:条件成立 0:条件非成立
@NTR_CHK_VISIBLE(場所)
#FUNCTION
#DIM 場所
IF IS_NTR_SHOW_ALL()
    RETURNF 1
ENDIF
IF CFLAG:MASTER:現在位置 == 場所
    RETURNF 1
ENDIF
IF CAN_MOVE(CFLAG:MASTER:現在位置, 場所) == 2
    RETURNF 1
ENDIF
IF 場所 == TFLAG:現在覗いている場所
    RETURNF 1
ENDIF
RETURNF 0

;-------------------------------------------------------------------------------
;覗き発覚時に連続して覗いたかどうかのチェック
;戻り値…1:条件成立 0:条件非成立
@NTR_CHK_PEEP_CONT(奴隷)
#FUNCTION
#DIM 奴隷
SIF CFLAG:奴隷:覗き発覚回数 && PREVCOM == 404 && SELECTCOM == 404
    RETURNF 1
RETURNF 0

;-------------------------------------------------------------------------------
;見せつけ有無判定
;　見せつけ条件
;　・サド または サドっ気Lv3以上
;　・小悪魔
;　・浮気公認Lv3以上 かつ 傷心
;戻り値…1:条件成立 0:条件非成立
@NTR_CHK_MISETUKE(奴隷)
#FUNCTION
#DIM 奴隷
SIF TALENT:奴隷:サド || ABL:奴隷:サドっ気 >= 3
    RETURNF 1
SIF TALENT:奴隷:小悪魔
    RETURNF 1
SIF TALENT:奴隷:浮気公認 >= 3 && TALENT:奴隷:傷心
    RETURNF 1
RETURNF 0

;-------------------------------------------------------------------------------
;Ｖ感覚高いときの絶頂経験加算（強絶頂のようなもの）
@NTR_V_EXP_PLUS(奴隷)
#DIM 奴隷
IF ABL:奴隷:Ｖ感覚 >= 2
    IF RAND:3 == 0
        EXP:奴隷:Ｖ経験 ++
        EXP:奴隷:Ｖ絶頂経験 ++
        EXP:奴隷:絶頂経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気絶頂経験 ++
    ENDIF
ELSEIF ABL:奴隷:Ｖ感覚 >= 4
    IF RAND:2 == 0
        EXP:奴隷:Ｖ経験 ++
        EXP:奴隷:Ｖ絶頂経験 ++
        EXP:奴隷:絶頂経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気絶頂経験 ++
    ENDIF
ENDIF
IF TALENT:奴隷:浮気な蜜壷
    IF RAND:2 == 0
        EXP:奴隷:Ｖ経験 ++
        EXP:奴隷:Ｖ絶頂経験 ++
        EXP:奴隷:絶頂経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気絶頂経験 ++
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;Ａ感覚高いときの絶頂経験加算（強絶頂のようなもの）
@NTR_A_EXP_PLUS(奴隷)
#DIM 奴隷
IF ABL:奴隷:Ａ感覚 >= 2
    IF RAND:3 == 0
        EXP:奴隷:Ａ経験 ++
        EXP:奴隷:Ａ絶頂経験 ++
        EXP:奴隷:絶頂経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気絶頂経験 ++
    ENDIF
ELSEIF ABL:奴隷:Ａ感覚 >= 4
    IF RAND:2 == 0
        EXP:奴隷:Ａ経験 ++
        EXP:奴隷:Ａ絶頂経験 ++
        EXP:奴隷:絶頂経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気絶頂経験 ++
    ENDIF
ENDIF
IF TALENT:奴隷:浮気な尻穴
    IF RAND:2 == 0
        EXP:奴隷:Ａ経験 ++
        EXP:奴隷:Ａ絶頂経験 ++
        EXP:奴隷:絶頂経験 ++
        SIF !TALENT:奴隷:親愛
            EXP:奴隷:浮気絶頂経験 ++
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@NTR_SOURCE_CHECK(奴隷,調教者)
#DIM 奴隷
#DIM 調教者
#DIM SOURCE番号
#DIM LOOP_I
TCVAR:奴隷:行為者 = 調教者
CALL SOURCE_EXP(奴隷,調教者)
CALL SOURCE_快Ｃ(奴隷,調教者)
CALL SOURCE_快Ｖ(奴隷,調教者)
CALL SOURCE_快Ａ(奴隷,調教者)
CALL SOURCE_快Ｂ(奴隷,調教者)
CALL SOURCE_CVAB_EXTRA(奴隷,調教者)
CALL SOURCE_情愛(奴隷,調教者)
CALL SOURCE_性行動(奴隷,調教者)
CALL SOURCE_達成(奴隷,調教者)
CALL SOURCE_苦痛(奴隷,調教者)
CALL SOURCE_恐怖(奴隷,調教者)
CALL SOURCE_液体(奴隷,調教者)
CALL SOURCE_欲情(奴隷,調教者)
CALL SOURCE_恭順(奴隷,調教者)
CALL SOURCE_露出(奴隷,調教者)
CALL SOURCE_屈従(奴隷,調教者)
CALL SOURCE_歓楽(奴隷,調教者)
CALL SOURCE_征服(奴隷,調教者)
CALL SOURCE_受動(奴隷,調教者)
CALL SOURCE_不潔(奴隷,調教者)
CALL SOURCE_鬱屈(奴隷,調教者)
CALL SOURCE_逸脱(奴隷,調教者)
CALL SOURCE_反感(奴隷,調教者)
CALL SOURCE_EXTRA(奴隷,調教者)
CALL SOURCE_DOWNBASE(奴隷,調教者)
CALL SOURCE_ABLUP(奴隷)
CALL MARK_GOT_CHECK(奴隷,調教者)
CALL KOJO_MESSAGE_MARKCNG(奴隷)
    ;パラメータの増加
FOR LOOP_I,0,100
    SIF PALAMNAME:LOOP_I == ""
        CONTINUE
    PALAM:奴隷:LOOP_I += CUP:奴隷:LOOP_I - CDOWN:奴隷:LOOP_I
    CUP:奴隷:LOOP_I = 0
    CDOWN:奴隷:LOOP_I = 0
    PALAM:奴隷:LOOP_I = MAX(PALAM:奴隷:LOOP_I, 0)
NEXT
CALL LOST_VIRGIN(奴隷, 調教者)
CALL LOST_VIRGIN_A(奴隷, 調教者)
CALL LOST_VIRGIN_M(奴隷, 調教者)
FOR SOURCE番号,0,VARSIZE("SOURCE")
    SOURCE:奴隷:SOURCE番号 = 0
NEXT
RETURN 0

;-------------------------------------------------------------------------------
;浮気快楽刻印の付与
;@return 浮気快楽が増えたら1、増えなければ0
@NTR_MARK_5(奴隷,浮気快楽強度)
#DIM 奴隷
#DIM 浮気快楽強度
IF MARK:奴隷:浮気快楽刻印 < 浮気快楽強度
    MARK:奴隷:浮気快楽刻印 = MIN(浮気快楽強度,MARK:奴隷:浮気快楽刻印+1)
    IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        IF 奴隷 != MASTER
            PRINTFORML %CALLNAME:奴隷+"は"+CALLNAME:MASTER+"とのセックスでは得られなかった激しい快楽で朦朧としている……"%
        ENDIF
        SETCOLOR 0xE6399B
        PRINTFORML %CALLNAME:奴隷+"は浮気快楽刻印LV"+TOSTR(MARK:奴隷:浮気快楽刻印)+"を得た"%
        RESETCOLOR
        TRYCALLLIST
            FUNC  NTR_KOJO_K{CFLAG:奴隷:297}_MARK_5(奴隷, MARK:奴隷:浮気快楽刻印)
            FUNC  NTR_KOJO_KU_MARK_5(奴隷, MARK:奴隷:浮気快楽刻印)
        ENDFUNC
    ENDIF
    RETURN 1
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;あなたとのセックスで満足できるかチェック
; RETURN 0 あなたとのセックスで満足できる
; RETURN 1 あなたとのセックスで満足できない
@CHK_NTR_SATISFACTORY(奴隷)
#FUNCTION
#DIM 奴隷

    ;快楽刻印の主があなたではない
SIF CFLAG:奴隷:快楽刻印主人 != MASTER
    RETURNF 1
    ;快楽刻印の主があなただが、浮気快楽刻印の方が勝る
SIF MARK:奴隷:快楽刻印 < MARK:奴隷:浮気快楽刻印
    RETURNF 1
RETURNF 0

;-------------------------------------------------------------------------------
;屈服度加算
;　・加算する屈服度が0以下なら何もしない
;　・加算する屈服度が1以上なら加算する
;　・将来難易度調整で加算する屈服度を増減する場合、1が0にはならないようにする
;@return 常に0
@NTR_ADD_SURRENDER(奴隷, 加算値)
#DIM 奴隷
#DIM 加算値
    ;加算値0以下ならなにもしない
IF 0 >= 加算値
    RETURN 0
ENDIF
    ;結婚指輪していると若干影響軽減。0にはならない。
IF EQUIP:奴隷:アクセサリ == 衣装_アクセサリ_結婚指輪
    加算値 = (加算値 * 4) / 5
    SIF 加算値 < 1
        加算値 = 1
ENDIF
    ;NTR和姦の時は若干影響軽減(2/3)
IF IS_NTR_SOFT()
    加算値 = MAX(((加算値 * 2) / 3), 1)
ENDIF
    ;屈服度補正をかける。最大50倍。屈服度倍率が0のときはかけないようにする
IF FLAG:屈服度倍率 == 0
    CFLAG:奴隷:屈服度 += 加算値
ELSE
    CFLAG:奴隷:屈服度 += 加算値 * (FLAG:屈服度倍率) / 10
ENDIF
IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
    IF FLAG:屈服度倍率 == 0
        PRINTFORML 屈服度+{加算値}
    ELSE
        PRINTFORML 屈服度+{加算値 * (FLAG:屈服度倍率) / 10}
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;好感度吸収
;@return 常に0
@NTR_DRAIN_LOVE(奴隷,減少値)
#DIM 奴隷
#DIM 減少値
    ;親愛があれば減らない
SIF TALENT:奴隷:親愛
    RETURN 0
    ;結婚指輪していると若干影響軽減(4/5)。0にはならない。
IF EQUIP:奴隷:アクセサリ == 衣装_アクセサリ_結婚指輪
    減少値 = MAX(((減少値 * 4) / 5), 1)
ENDIF
    ;NTR和姦の時は影響軽減(1/4)
IF IS_NTR_SOFT()
    減少値 = MAX(((減少値 * 1) / 4), 1)
ENDIF
    ;好感度吸収がONの時だけ減る
IF IS_NTR_DRAIN_LOVE()
    CFLAG:奴隷:好感度 -= 減少値
        ;FOR DEBUG 訪問者からの屈服度が高いと好感度吸収も大きい
        ;IF CFLAG:奴隷:屈服度 > 500 && CFLAG:奴隷:好感度 > 2000
        ;   CFLAG:奴隷:好感度 -= 減少値
        ;ENDIF
        ;IF CFLAG:奴隷:屈服度 > 1000 && CFLAG:奴隷:好感度 > 3000
        ;   CFLAG:奴隷:好感度 -= 減少値
        ;ENDIF
ENDIF
    ;恋慕かつ浮気公認してる場合好感度の下限値を設定
IF TALENT:奴隷:恋慕 && TALENT:奴隷:浮気公認 > 1
    CFLAG:奴隷:好感度 = LIMIT(CFLAG:奴隷:好感度, 1599-TALENT:奴隷:浮気公認*200, 999999)
ENDIF
IF (TCVAR:行為者 < CHARANUM)
    CALL FAVOR_CALC(TARGET)
ELSE
    IF IS_NTR_DRAIN_LOVE()
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORML 好感度-{減少値}
        ENDIF
    ENDIF
ENDIF
RETURN 0

;-------------------------------------------------------------------------------
;浮気した経験を記録し、合計の経験人数を返す
;@return 経験人数
@NTR_FickleCount(奴隷,相手,相手番号)
#FUNCTION
#DIM 奴隷
#DIM 相手
#DIM 相手番号
#DIMS 相手文字列
IF 相手 == 人物_客 || 相手 == 人物_村人
    相手文字列 = %TOSTR(相手)+"-"+TOSTR(TB:奴隷:相手番号:TB_客番号,"000")%
ELSE
    相手文字列 = %TOSTR(相手)%
ENDIF
SIF CSTR:奴隷:セックスした相手 == ""
    CSTR:奴隷:セックスした相手 = /
LOCALS = %"/"+相手文字列+"/"%
IF STRCOUNT(CSTR:奴隷:セックスした相手,LOCALS)
        ;すでに記録済
ELSE
    CSTR:奴隷:セックスした相手 = %CSTR:奴隷:セックスした相手+相手文字列+"/"%
    EXP:奴隷:前回浮気人数 += 1
ENDIF
    ;初回判定更新
RETURNF (STRCOUNT(CSTR:奴隷:セックスした相手,"/")-1)

;-------------------------------------------------------------------------------
;住人が移動したことで空気が変わるかのチェック
@NTR_CHK_CHAR_MOVE(奴隷)
#DIM 奴隷   ; 移動した人物
#DIM 結果   ; 1:空気が変わった 0:空気変わらない
結果 = 0
    ;訪問者の現在位置に移動してきたかチェック
SIF CFLAG:奴隷:睡眠 
    RETURN 結果
SIF CFLAG:奴隷:現在位置 == CFLAG:奴隷:前ターン位置
    RETURN 結果
SIF CFLAG:奴隷:現在位置 != FLAG:訪問者の現在位置
    RETURN 結果
    ;NTR, 公衆便所な住人だと空気変わらない
IF TALENT:奴隷:NTR || TALENT:奴隷:公衆便所
    IF FLAG:訪問者との行為 != NTR_行為_なし
        IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
            PRINTFORML %CALLNAME:奴隷%が入ってきたが、%NTR_NAME(0)%は気にもせず行為を続行した。
        ENDIF
    ENDIF
    RETURN 結果
ENDIF
    ;空気変化
結果 = 1
    ;訪問者移動時はムード等リセット
IF FLAG:訪問者との行為 != NTR_行為_なし
    IF NTR_CHK_VISIBLE(FLAG:訪問者の現在位置)
        PRINTFORML %CALLNAME:奴隷%が入ってきたことにより空気が変わったため、%NTR_NAME(0)%は行為を中断した。
    ENDIF
ENDIF
CALL NTR_RESET_VISITOR_ACTION(-1)
RETURN 結果 

;-------------------------------------------------------------------------------
;対象がストライクゾーン範囲かチェックする
;　戻り値：1…範囲内 0…範囲外
@NTR_CHK_STRIKE_ZONE(奴隷)
#FUNCTION
#DIM 奴隷
    ;初期配置キャラは全員範囲内
SIF 奴隷 < 開始時人数
    RETURNF 1
SIF CFLAG:奴隷:成長度 >= FLAG:訪問者のストライクゾーン下限
    RETURNF 1
RETURNF 0

;-------------------------------------------------------------------------------
;貞操帯解除処理
;　戻り値：1…解除成功　0…解除失敗
@NTR_UNLOCK_CHASTITY_BELT(奴隷)
#DIM 奴隷
    ;そもそも奴隷じゃないので解除不要、成功扱いとする（フェイルセーフ）
SIF !TALENT:奴隷:公衆便所
    RETURN 1
    ;ノーパンなら解除不要、成功扱いとする（フェイルセーフ）
SIF EQUIP:奴隷:下半身下着１ == 0 && EQUIP:奴隷:下半身下着２ == 0
    RETURN 1
    ;鍵を持ってないと解除不可能
SIF FLAG:貞操帯鍵購入フラグ != 奴隷
    RETURN 0
PRINTFORML %CALLNAME:MASTER%は%NTR_NAME(0)%から買った鍵を使って%CALLNAME:奴隷%が身に着けた貞操帯を外した。
EQUIP:奴隷:下半身下着１ = 0
EQUIP:奴隷:下半身下着２ = 0
RETURN 1

