@ITEM_BUY
#DIM LOOP_CHR
#DIM LOOP_ITEM
#DIM ITEM_NO

;PRINTFORML {ITEMSALES:62}
CALL ITEM_SALES
PRINT_ITEM
PRINTFORML 请选择购买的物品 所持金:${MONEY}
CALL SHOW_ITEM
PRINTL [100] - 返回
PRINT [200] - 物品重置
$INPUT_LOOP
INPUT
ITEM_NO = RESULT
IF RESULT == 100
	RETURN 0
ELSEIF RESULT == 200
	LOCALS = アイテム個数をリセットしますか？
	CALL CHOICE(LOCALS, "是的", "不要")
	SIF RESULT
		RESTART
	FOR LOOP_ITEM, 0, 100
		ITEMSALES:LOOP_ITEM = 0
	NEXT
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 1 || ITEMSTOCK(RESULT) == 4 || RESULT < 0 || RESULT > 100
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 2
	PRINTW 已售罄
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 3
	PRINTW 所需金额不足
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 5
	PRINTW 持有数量已达上限
	RESTART
ENDIF
;アイテムの説明
DRAWLINE
PRINTL
PRINTFORML ～%ITEMNAME:ITEM_NO%～
CALLFORM アイテム説明_{ITEM_NO}
PRINTL
DRAWLINE

;個別に処理すべきもの
IF ITEM_NO == 60 || ITEM_NO == 61 || ITEM_NO == 62
	LOCALS = %ITEMNAME:ITEM_NO%を习得しますか？
	CALL CHOICE(LOCALS, "是的", "不要")
	SIF RESULT
		RESTART
	MONEY -= ITEMPRICE:ITEM_NO
	SELECTCASE ITEM_NO
		CASE 60
			TALENT:MASTER:污臭耐性 = 2
		CASE 61
			TALENT:MASTER:调和知识 = 1
		CASE 62
			TALENT:MASTER:禁断的知识 = 1
	ENDSELECT
	ITEMSALES:ITEM_NO = -1
	RESTART
ENDIF
IF ITEM_NO == 63
	CALL CHOICE("【技巧UP】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	MONEY -= ITEMPRICE:ITEM_NO
	ABL:MASTER:技巧 += 1
	RESTART
ENDIF
IF ITEM_NO == 64
	CALL CHOICE("【技巧DOWN】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	MONEY -= ITEMPRICE:ITEM_NO
	ABL:MASTER:技巧 -= 1
	RESTART
ENDIF
IF ITEM_NO == 70
	CALL CHOICE("【元气之药】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		IF BASE:LOOP_CHR:0 < MAXBASE:LOOP_CHR:0
			PRINTFORM [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
			CALL PRINT_BASE("体力",LOOP_CHR,0,32)
			PRINTL
		ENDIF
	NEXT
	$INPUT_LOOP_70
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || BASE:RESULT:0 == MAXBASE:RESULT:0
		GOTO INPUT_LOOP_70
	ELSE
		PRINTFORMW %CALLNAME:RESULT%の体力+300
		MONEY -= ITEMPRICE:ITEM_NO
		BASE:RESULT:0 += 300
		SIF BASE:RESULT:0 > MAXBASE:RESULT:0
			BASE:RESULT:0 = MAXBASE:RESULT:0
	ENDIF
	RESTART
ENDIF
IF ITEM_NO == 71
	CALL CHOICE("【薬の材料(双)】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF TALENT:LOOP_CHR:2 == 1
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_71
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:2 != 1
		GOTO INPUT_LOOP_71
	ELSE
		PRINTFORMW %CALLNAME:RESULT%成为了扶她
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:2 |= 2
		MAXBASE:RESULT:射精 = 10000
		IF MAXBASE:RESULT:精力 > 0
			MAXBASE:RESULT:精力 = LIMIT(MAXBASE:RESULT:精力,200,1000)
		ELSE
			MAXBASE:RESULT:精力 = 1000
		ENDIF
		IF MAXBASE:RESULT:勃起 > 0
			MAXBASE:RESULT:勃起 = LIMIT(MAXBASE:RESULT:勃起,500,1500)
		ELSE
			MAXBASE:RESULT:勃起 = 1500
		ENDIF
	ENDIF
	RESTART
ENDIF
IF ITEM_NO == 72
	CALL CHOICE("【薬の材料(消)】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF TALENT:LOOP_CHR:2 == 3
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_72
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:2 != 3
		GOTO INPUT_LOOP_72
	ELSE
		PRINTFORMW %CALLNAME:RESULT%变成了女孩子
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:2 = 1
		MAXBASE:RESULT:2 = 0
		MAXBASE:RESULT:精力 = 0
	ENDIF
	RESTART
ENDIF
IF ITEM_NO == 73
	CALL CHOICE("【青色糖果】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF !TALENT:LOOP_CHR:泌乳体质
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_73
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:149
		GOTO INPUT_LOOP_73
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は[泌乳体质]获得了
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:泌乳体质 = 1
	ENDIF
	RESTART
ENDIF
IF ITEM_NO == 74
	CALL CHOICE("【赤色糖果】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF HAS_VAGINA(LOOP_CHR) && !TALENT:LOOP_CHR:处女
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_74
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || (TALENT:RESULT:处女 || !HAS_VAGINA(RESULT))
		GOTO INPUT_LOOP_74
	ELSE
		PRINTFORMW %CALLNAME:RESULT%的处女膜再生了
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:处女 = 2
	ENDIF
	RESTART
ENDIF
IF ITEM_NO == 77
	CALL CHOICE("【橙色糖果】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL (※強度が高いほど一度に産む子供の数が多くなりやすくなります)
	PRINTL (※強度が６の状態で使うと０に戻ります)
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF TALENT:LOOP_CHR:2 != 2
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% (強度 {CFLAG:LOOP_CHR:355})
	NEXT
	$INPUT_LOOP_77
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || (TALENT:RESULT:0 || TALENT:RESULT:1)
		GOTO INPUT_LOOP_77
	ELSE
		IF CFLAG:RESULT:355 == 6
			CFLAG:RESULT:355 = 0
		ELSE
			CFLAG:RESULT:355 ++
		ENDIF
		PRINTFORML %CALLNAME:RESULT%は橙色糖果を使用しました
		PRINTFORMW 現在の強度 {CFLAG:RESULT:355}
		MONEY -= ITEMPRICE:ITEM_NO
	ENDIF
	RESTART
ENDIF
IF ITEM_NO == 91
	CALL CHOICE("【排卵诱发剂】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	FOR LOOP_CHR, 0, CHARANUM
		SIF NO:(LOOP_CHR) == 149 && CFLAG:LOOP_CHR:75 < 3 && !TALENT:MASTER:禁断的知识
			CONTINUE
		SIF TALENT:LOOP_CHR:妊娠
			CONTINUE
		SIF GETBIT(TALENT:LOOP_CHR:2,0) && CFLAG:LOOP_CHR:81 != 3
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	PRINTL [999] - 返回
	$INPUT_LOOP_91
	INPUT
	IF RESULT == 999
		RESTART
	ELSEIF RESULT >= CHARANUM || !GETBIT(TALENT:RESULT:2,0)
		GOTO INPUT_LOOP_91
	ELSE
		PRINTFORM %CALLNAME:RESULT%
		IF RESULT == 0
			PRINTW は排卵诱发剂を飲みました
		ELSE
			PRINTW に排卵诱发剂を渡しました
		ENDIF
		MONEY -= ITEMPRICE:ITEM_NO
		CFLAG:RESULT:81 = 2
		TRYCALL 排卵诱发剂追加処理, RESULT
	ENDIF
	RESTART
ENDIF
; IF ITEM_NO == 92
; CALL CHOICE("购买【避孕药】？", "是的", "不要")
; SIF RESULT
; RESTART
; PRINTL 对谁使用？
; FOR LOOP_CHR, 0, CHARANUM
; SIF NO:(LOOP_CHR) == 149 && CFLAG:LOOP_CHR:75 < 3; && !TALENT:MASTER:禁断的知识
; CONTINUE
; SIF TALENT:LOOP_CHR:妊娠
; CONTINUE
; SIF GETBIT(TALENT:LOOP_CHR:2,0) && CFLAG:LOOP_CHR:81 != 3
; PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
; NEXT
; PRINTL [999] - 返回
; $INPUT_LOOP_92
; INPUT
; IF RESULT == 999
; RESTART
; ELSEIF RESULT >= CHARANUM || !GETBIT(TALENT:RESULT:2,0)
; GOTO INPUT_LOOP_92
; ELSE
; PRINTFORM %CALLNAME:RESULT%
; IF RESULT == 0
; PRINTW 喝下了避孕药
; ELSE
; PRINTW 交出了避孕药
; ENDIF
; MONEY -= ITEMPRICE:ITEM_NO
; CFLAG:RESULT:81 = 3
; ENDIF
; RESTART
; ENDIF

IF ITEM_NO == 93
	CALL CHOICE("【彩色糖果】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF !TALENT:LOOP_CHR:恋慕
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_93
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:3
		GOTO INPUT_LOOP_93
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は[恋慕]获得了
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:NTR = 0
		TALENT:RESULT:浮気公認 = 0
		TALENT:RESULT:恋慕 = 1
	ENDIF
	RESTART
ENDIF

IF ITEM_NO == 94
	CALL CHOICE("【黑色糖果】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF !TALENT:LOOP_CHR:NTR
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_94
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:6
		GOTO INPUT_LOOP_94
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は[NTR]获得了
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:恋慕 = 0
		TALENT:RESULT:人妻 = 0
		TALENT:RESULT:NTR = 1
	ENDIF
	RESTART
ENDIF

IF ITEM_NO == 95
	CALL CHOICE("【钻石】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 0, CHARANUM
		SIF CFLAG:LOOP_CHR:MASTERの弱味
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_95
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:6
		GOTO INPUT_LOOP_95
	ELSE
		PRINTFORMW %CALLNAME:RESULT%的弱点去除了
		MONEY -= ITEMPRICE:ITEM_NO
		CFLAG:RESULT:MASTERの弱味 = 0
	ENDIF
	RESTART
ENDIF

IF ITEM_NO == 96
	CALL CHOICE("【结婚戒指】を購入しますか？", "是的", "不要")
	SIF RESULT
		RESTART
	PRINTL 对谁使用？
	PRINTL [-1] - 返回
	FOR LOOP_CHR, 1, CHARANUM
		SIF (TALENT:LOOP_CHR:亲爱||(TALENT:LOOP_CHR:恋慕&&CFLAG:LOOP_CHR:好感度>5000))&&TALENT:LOOP_CHR:人妻 == 0
			PRINTFORML [{LOOP_CHR,3}] - %CALLNAME:(LOOP_CHR)% 
	NEXT
	$INPUT_LOOP_96
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:6 || !((TALENT:RESULT:亲爱||(TALENT:RESULT:恋慕&&CFLAG:RESULT:好感度>5000))&&TALENT:RESULT:人妻 == 0)
		GOTO INPUT_LOOP_96
	ELSE
		PRINTFORMW %CALLNAME:RESULT%收到了戒指，成为了人妻
		MONEY -= ITEMPRICE:ITEM_NO
		TALENT:RESULT:人妻 = 1
	ENDIF
	RESTART
ENDIF

IF ITEM_NO == 41
	MONEY -= ITEMPRICE:ITEM_NO
	ITEM:ITEM_NO ++
	PRINTW 精制了媚药
	RESTART
ENDIF
;複数所持アイテム
SELECTCASE ITEM_NO
	CASE 40 TO 60, 91, 92,
		PRINTFORM 要购买%ITEMNAME:ITEM_NO%吗？
		SIF ITEM_NO == 50
			PRINTFORM (あと{ITEMSALES:ITEM_NO}個)
		PRINTFORML 
		;金欠、アイテム数の超過はあとで合わせる
		PRINTL [0] - 放弃
		PRINT [1] - 1　
		PRINT [5] - 5　
		PRINT [10] - 10　
		PRINT [20] - 20　
		PRINT [50] - 50　
		PRINT [999] - 買えるだけ
		INPUT
		SIF RESULT <= 0
			RESTART
		SIF RESULT * ITEMPRICE:ITEM_NO > MONEY
			RESULT = MONEY / ITEMPRICE:ITEM_NO
		;個数限定
		IF ITEMSALES:ITEM_NO
			IF RESULT >= ITEMSALES:ITEM_NO
				RESULT = ITEMSALES:ITEM_NO
				ITEMSALES:ITEM_NO = -1
			ELSE
				ITEMSALES:ITEM_NO -= RESULT
			ENDIF
		ELSE
			ITEM:ITEM_NO += RESULT
			IF ITEM:ITEM_NO > 999
				RESULT = 999 - (ITEM:ITEM_NO - RESULT)
				ITEM:ITEM_NO = 999
			ENDIF
		ENDIF
		PRINTFORMW %ITEMNAME:ITEM_NO%を{RESULT}個、${RESULT * ITEMPRICE:ITEM_NO}で購入しました
		MONEY -= RESULT * ITEMPRICE:ITEM_NO
		RESTART
		;単品アイテム
	CASE 0 TO 39
		PRINTFORML %ITEMNAME:ITEM_NO%を購入しますか？
		PRINTL [0] - 是的  [1] - 不要
		INPUT
		SIF RESULT
			RESTART
		ITEM:ITEM_NO ++
		ITEMSALES:ITEM_NO --
		MONEY -= ITEMPRICE:ITEM_NO
		RESTART
ENDSELECT

@SHOW_ITEM
#DIM LOOP_I
#DIM ITEM_CNT

DRAWLINE
ITEM_CNT = 0
FOR LOOP_I,0,100
	;表示しない
	SIF ITEMSTOCK(LOOP_I) == 1
		CONTINUE
	SIF ITEMSTOCK(LOOP_I) == 4
		CONTINUE
	LOCALS = [{LOOP_I}]%ITEMNAME:(LOOP_I)% (${ITEMPRICE:(LOOP_I)})
	;売り切れ
	IF ITEMSTOCK(LOOP_I) == 2
		LOCALS = [{LOOP_I}]%ITEMNAME:LOOP_I% (売切)
		SETCOLOR 色設定_テキスト_無効
	ELSEIF ITEMSTOCK(LOOP_I) == 5
		LOCALS = [{LOOP_I}]%ITEMNAME:LOOP_I%
		SETCOLOR 色設定_テキスト_無効
	ENDIF
	PRINTFORM %LOCALS,28,LEFT%
	RESETCOLOR
	ITEM_CNT += 1
	SIF ITEM_CNT % 3 == 0
		PRINTL
NEXT
PRINTL

;条件付きアイテムの処理
@ITEM_SALES
#DIM LOOP_I
#DIM LOOP_CHR
;ITEMSALES = 0 購入可
;ITEMSALES = -1 売切
;ITEMSALES = -2 封印
;技巧
IF ABL:MASTER:技巧 < 5
	ITEMSALES:63 = 0
ELSE
	ITEMSALES:63 = -2
ENDIF
IF ABL:MASTER:技巧
	ITEMSALES:64 = 0
ELSE
	ITEMSALES:64 = -2
ENDIF

SIF TALENT:MASTER:禁断的知识
	ITEMSALES:62 = -1
SIF TALENT:MASTER:调和知识
	ITEMSALES:61 = -1
SIF TALENT:MASTER:污臭耐性 == 2
	ITEMSALES:60 = -1
SIF FLAG:真实模式 == 0
	ITEMSALES:18 = -2
;結婚
;SIF TALENT:MASTER:恋慕 || TALENT:MASTER:亲爱
;		ITEMSALES:96 =  0
ITEMSALES:96 =  0

;媚药
IF ABL:MASTER:教养 < 1
	ITEMSALES:41 = -2
ELSE
	IF ITEM:41
		ITEMSALES:41 = -1
	ELSE
		ITEMSALES:41 = 0
	ENDIF
ENDIF
;禁断
FOR LOOP_I,70,96
	;売切の場合はそのまま
	SIF ITEMSALES:LOOP_I == -1
		CONTINUE
	ITEMSALES:LOOP_I = -2
	;禁断的知识
	IF (LOOP_I > 70 && LOOP_I < 89) || LOOP_I == 90 || LOOP_I == 95
		SIF TALENT:MASTER:禁断的知识 || (ASSI > 0 && TALENT:ASSI:禁断的知识)
			ITEMSALES:LOOP_I = 0
		;调和知识
	ELSEIF LOOP_I == 70 || LOOP_I == 91 || LOOP_I == 93 || LOOP_I == 94; || LOOP_I == 92
		SIF TALENT:MASTER:调和知识 || (ASSI > 0 && TALENT:ASSI:调和知识)
			ITEMSALES:LOOP_I = 0
	ENDIF
NEXT
ITEMSALES:92 = 0
