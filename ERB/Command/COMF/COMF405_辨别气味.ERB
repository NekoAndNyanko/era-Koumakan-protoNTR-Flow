;-------------------------------------------------
;闻气味
;-------------------------------------------------
@COM405
#DIM 対象
#DIM LOOP_CHR
#DIM BK_SELCOM

IF (GETBIT(ROOM_SMELL_BIT(FLAG:(部屋のにおい_初期FLAG + CFLAG:MASTER:現在位置)), 气味类型B_ゴミ) || GETBIT(ROOM_SMELL_BIT(FLAG:(部屋のにおい_初期FLAG_2 + CFLAG:MASTER:現在位置)), 气味类型B_ゴミ))
	PRINTFORML 房间里到处都是垃圾…
	PRINTFORMW 要仔细闻的话还是先打扫干净比较好。
	RETURN 0
ENDIF

PRINTL 要闻谁身上的气味？
;対象を探す
FOR LOOP_CHR, 0, MIN(CHARANUM, バグ回避用キャラ最大値)
	SIF CFLAG:MASTER:現在位置 == CFLAG:LOOP_CHR:現在位置
		PRINTFORML %"["+TOSTR(LOOP_CHR)+"] - "+CALLNAME:(LOOP_CHR)%
NEXT
SIF CFLAG:MASTER:現在位置 == FLAG:访问者当前位置
	PRINTFORML [998] - %NTR_NAME(0)%
PRINTFORML [999] %"放弃"%

$INPUT_LOOP
INPUT
IF RESULT < 0
	GOTO INPUT_LOOP
ELSEIF  RESULT == 998
	LOCAL:10 = ROOM_SMELL_WHOSE(FLAG:訪問者の他人のにおい)
	SIF LOCAL:10 >= CHARANUM
		LOCAL:10 = バグ回避用キャラ最大値
	;CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + バグ回避用キャラ最大値) = 50
	CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + バグ回避用キャラ最大値)++
	PRINTFORM %NTR_NAME(0)%的身上
	IF ROOM_SMELL_WHOSE_NAME(FLAG:訪問者の他人のにおい) == "無臭"
		PRINTW 没什么气味
	ELSEIF GETBIT(ROOM_SMELL_BIT(FLAG:訪問者の他人のにおい), 气味类型B_ゴミ)
		PRINTW 有垃圾的气味
	ELSEIF CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + LOCAL:10) >= においの判別_詳細
		IF GETBIT(FLAG:部屋のにおい_初期FLAG, 1)
			PRINTFORMW 有%ROOM_SMELL_WHOSE_NAME(FLAG:訪問者の他人のにおい)%の%ROOM_SMELL_KINDS(FLAG:訪問者の他人のにおい)%的气味
		ELSE
			IF GETBIT(ROOM_SMELL_BIT(FLAG:訪問者の他人のにおい), 气味类型B_精液) || GETBIT(ROOM_SMELL_BIT(FLAG:訪問者の他人のにおい), 气味类型B_愛液)
				PRINTFORMW 有不知何人的%ROOM_SMELL_KINDS(FLAG:訪問者の他人のにおい)%的气味
			ELSE
				PRINTFORMW 有%ROOM_SMELL_WHOSE_NAME(FLAG:訪問者の他人のにおい)%的%ROOM_SMELL_KINDS(FLAG:訪問者の他人のにおい)%的气味
			ENDIF
		ENDIF
	ELSEIF CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + LOCAL:10) >= においの判別_可能 || LOCAL:10 == ROOM_SMELL_WHOSE(FLAG:訪問者の他人のにおい)
		PRINTFORMW 有%ROOM_SMELL_WHOSE_NAME(FLAG:訪問者の他人のにおい)%的气味
	ELSE
		PRINTFORMW 有不知何人的气味
	ENDIF
ELSEIF RESULT < CHARANUM && RESULT < バグ回避用キャラ最大値
	LOCAL:10 = ROOM_SMELL_WHOSE(ROOM_SMELL_CHARA_MOST(RESULT))
	SIF LOCAL:10 >= CHARANUM
		LOCAL:10 = バグ回避用キャラ最大値
	CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + LOCAL:10)++
	IF RESULT == 人物_あなた
		PRINT 自己的
	ELSE
		PRINTFORM %CALLNAME:RESULT%的
	ENDIF
	PRINT 身上
	IF ROOM_SMELL_WHOSE_NAME(ROOM_SMELL_CHARA_MOST(RESULT)) == "無臭"
		PRINTW 没什么气味
	ELSEIF GETBIT(ROOM_SMELL_BIT(ROOM_SMELL_CHARA_MOST(RESULT)), 气味类型B_ゴミ)
		PRINTW 有垃圾的气味
	ELSEIF CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + LOCAL:10) >= においの判別_詳細
		IF GETBIT(FLAG:部屋のにおい_初期FLAG, 1)
			PRINTFORMW 有%ROOM_SMELL_WHOSE_NAME(ROOM_SMELL_CHARA_MOST(RESULT))%の%ROOM_SMELL_KINDS(ROOM_SMELL_CHARA_MOST(RESULT))%的气味
		ELSE
			IF GETBIT(ROOM_SMELL_BIT(ROOM_SMELL_CHARA_MOST(RESULT)), 气味类型B_精液) || GETBIT(ROOM_SMELL_BIT(ROOM_SMELL_CHARA_MOST(RESULT)), 气味类型B_愛液)
				IF RESULT == 人物_あなた
					PRINTFORM 有%ROOM_SMELL_WHOSE_NAME(ROOM_SMELL_CHARA_MOST(RESULT))%的
				ELSE
					PRINT 不知是谁的
				ENDIF
				PRINTFORMW %ROOM_SMELL_KINDS(ROOM_SMELL_CHARA_MOST(RESULT))%的气味
			ELSE
				PRINTFORMW 有%ROOM_SMELL_WHOSE_NAME(ROOM_SMELL_CHARA_MOST(RESULT))%的%ROOM_SMELL_KINDS(ROOM_SMELL_CHARA_MOST(RESULT))%的气味
			ENDIF
		ENDIF
	ELSEIF CFLAG:MASTER:(キャラのにおいの嗅ぎ分け + LOCAL:10) >= においの判別_可能 || LOCAL:10 == ROOM_SMELL_WHOSE(ROOM_SMELL_CHARA_MOST(RESULT))
		PRINTFORMW 有%ROOM_SMELL_WHOSE_NAME(ROOM_SMELL_CHARA_MOST(RESULT))%的气味
	ELSE
		PRINTFORMW 有不知是何人的气味
	ENDIF
ELSEIF RESULT == 999
	RETURN 0
ELSE
	GOTO INPUT_LOOP
ENDIF

;同一コマンド連続実行を回避させないための処理
BK_SELCOM = SELECTCOM
SELECTCOM = 405

;SOURCEまでを回さないのでここで口上を表示させる
IF TEQUIP:口球 && SELECTCOM != 106 && FLAG:情景テキスト設定 > 0
	SELECTCOM = BK_SELCOM
	RETURN 1
ELSE
	RESULT = 0
	RESULTS =
	;口上の存在判定 and RESULTSに文字列代入
	TRYCALLFORM KOJO_K{対象}
	IF !RESULT && FLAG:情景テキスト設定 > 0
		SELECTCOM = BK_SELCOM
		RETURN 1
	ENDIF
	RESULT = 0
	TRYCALLFORM KOJO%RESULTS%_MESSAGE_COM_K{対象}_405
ENDIF

TIME += 1
SELECTCOM = BK_SELCOM
RETURN 1