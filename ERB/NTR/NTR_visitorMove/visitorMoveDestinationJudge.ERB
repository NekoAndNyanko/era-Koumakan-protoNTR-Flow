;-------------------------------------------------------------------------------
;訪問者移动先判定
;戻り値…訪問者の移动先
@JUDGE_VISITOR_MOVE_POS
#DIM RET_POS		; 戻り値（場所)
#DIM 位置概率, 場所番号最大値+1	; 部屋ごとの確率
#DIM 最大移动概率	; その部屋に行く最大確率
#DIM 上回最大概率		; 過去最大の確率
#DIM 位置编号		; ループ変数(場所)
#DIM LOOP_I			; ループ変数
#DIM RATE_WK		; 移动確率判定用ワーク
RET_POS = 0
位置概率:0 = 0
上回最大概率 = 0
;;肉便器系追加処理
;;人里プレイが開始したら、人里周辺へ移动。人里周辺に居るなら、移动しない。１時間経過してるとあなたの元へ
IF TALENT:MASTER:肉便器 && CFLAG:MASTER:WC_人里プレイ開始 > 0
	SELECTCASE FLAG:訪問者の現在位置
		CASE 位置_人間の里,位置_人間の里周辺
			SIF TIME_PROGRESS(CFLAG:MASTER:WC_人里プレイ開始) >= 90 && CFLAG:MASTER:WC_人里プレイ開始 != 0
				RETURN CFLAG:MASTER:現在位置
		CASEELSE
			;;同行フラグを解除しておく
			FLAG:訪問者同行フラグ = 0
			RETURN 位置_人間の里周辺
	ENDSELECT
ENDIF
;;
FOR 位置编号,1,MAXROOM()
	; 位置编号…ループ変数「部屋番号」
	; 初期化
	位置概率:位置编号 = 0
	; 入れない場合はcontinue
	SIF CAN_MOVE(FLAG:訪問者の現在位置, 位置编号) == 0
		CONTINUE
		;基本確率 / 施錠時は確率半減。 / 人数補正2.5％／人
	最大移动概率 = (FLAG:(300 + 位置编号) ? 3000 # 10000) + CHK_TGT_IN_POS(位置编号) * 250
		;行きにくくしたい補正
		;睡眠中、妊娠中の住人がいる部屋は確率半減
	SIF GET_ATTRIBUTE_OF_PERSON_IN_ROOM(位置编号)
		最大移动概率 /= 2
		;嫌いなキャラが登録ずみ、居た場合確率1/4
	IF FLAG:訪問者の嫌いな相手 != 999 && FLAG:訪問者の嫌いな相手 < CHARANUM && 位置编号 == CFLAG:(FLAG:訪問者の嫌いな相手):現在位置
		最大移动概率 /= 4
	ENDIF

	IF FLAG:訪問者のお気に入り != 999 && FLAG:訪問者のお気に入り < CHARANUM 
		IF 位置编号 == CFLAG:(FLAG:訪問者のお気に入り):現在位置 
			最大移动概率 *= 5
		ELSEIF 位置编号 == SAFE_NEXT_POS(FLAG:訪問者の現在位置, CFLAG:(FLAG:訪問者のお気に入り):現在位置)
			最大移动概率 *= 5
		ENDIF
	ENDIF
		;住人がいない部屋は確率半減
	SIF CHK_TGT_IN_POS(位置编号) == 0
		最大移动概率 /= 2
		;見えるけど直接行けない部屋は確率半減
	SIF CAN_MOVE(FLAG:訪問者の現在位置, 位置编号) > 1
		最大移动概率 /= 2
	位置概率:位置编号 = RAND:最大移动概率 + 1
		;誰かいると移动確率が増える
		;人数分だけループを回す
	FOR LOOP_I, 1, CHK_TGT_IN_POS(位置编号)
		RATE_WK = RAND:最大移动概率 + 1
		SIF 位置概率:位置编号 < RATE_WK
			位置概率:位置编号 = RATE_WK
	NEXT
		;正門にいるとき、広間への確率を多めに補正
	IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
		RATE_WK = RAND:(最大移动概率 + 7500) + 2500
		SIF 位置概率:位置编号 < RATE_WK
			位置概率:位置编号 = RATE_WK
	ENDIF
		;気になる場所が設定されていて、今日は1度気になる場所に到達していて、気になる場所へ移动できる場合確率を多めに補正
	IF FLAG:訪問者の気になる場所 != 0 && FLAG:1832 >= 1 && FLAG:訪問者の現在位置 != FLAG:訪問者の気になる場所 && 位置编号 == FLAG:訪問者の気になる場所 && SETTING_VISITOR_STAY_AT_FAV_POS()
		RATE_WK = RAND:(最大移动概率 + 7500) + 7500
		SIF 位置概率:位置编号 < RATE_WK
			位置概率:位置编号 = RATE_WK
	ENDIF
		;気になる場所が設定されていて、今日は一度も気になる場所に到達しておらず、お気に入りのキャラがあなたではない場合のみ
	IF FLAG:訪問者の気になる場所 != 0 && FLAG:1832 == 0 && FLAG:訪問者のお気に入り != 0
		SELECTCASE FLAG:訪問者の気になる場所
				;正門を除く広間に隣接した場所が気になる場合
			CASE 3,4,11,17,18,23
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;庭、屋外厕所、厨房が気になる場合
			CASE 5,10,22
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == 位置_食堂
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_食堂 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;パチュリー私室、小恶魔私室が気になる場合
			CASE 7,8
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == 位置_图书室
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_图书室 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;二階廊下、蕾米莉亚私室が気になる場合
			CASE 12,16
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == 位置_二楼楼梯间
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_二楼楼梯间 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;咲夜私室、妖精メイド詰め所、玩家房间、2F厕所が気になる場合
			CASE 13,14,15,24
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == 位置_二楼楼梯间
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_二楼楼梯间 && 位置编号 == 位置_二楼走廊
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_二楼走廊 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;3F阳台が気になる場合
			CASE 26
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_大厅
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == 位置_二楼楼梯间
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_二楼楼梯间 && 位置编号 == 位置_蕾米莉亚私室
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_蕾米莉亚私室 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;湖南部、魔法の森内部が気になる場合
			CASE 27,28
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_湖
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_湖 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;琪露诺的家、大妖精的家が気になる場合
			CASE 20,21
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_湖
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_湖 && 位置编号 == 位置_湖南部
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_湖南部 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;魔理沙の家、ルーミアの住処、アリスの家が気になる場合
			CASE 25,29,30
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == 位置_湖
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_湖 && 位置编号 == 位置_魔法の森内部
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ELSEIF FLAG:訪問者の現在位置 == 位置_魔法の森内部 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
				;正門に隣接した場所が気になる場合
			CASEELSE
				IF FLAG:訪問者の現在位置 == 位置_红魔馆正门 && 位置编号 == FLAG:訪問者の気になる場所
					RATE_WK = RAND:(最大移动概率 + 7500) + 12500
					SIF 位置概率:位置编号 < RATE_WK
						位置概率:位置编号 = RATE_WK
				ENDIF
		ENDSELECT
	ENDIF
	;条件(女あなたがお気に入り + 女あなたが私室にいる + 訪問者が館内にいる)を満たしたらまっしぐら
	IF FLAG:訪問者のお気に入り == 0 && CFLAG:MASTER:現在位置 == 位置_玩家房间 && FLAG:1840 == 0
		IF (FLAG:訪問者の現在位置 == 位置_仓库 || FLAG:訪問者の現在位置 == 位置_守卫小屋 || FLAG:訪問者の現在位置 == 位置_院子 || FLAG:訪問者の現在位置 == 位置_屋外厕所) && 位置编号 == 位置_红魔馆正门
			RATE_WK = RAND:(最大移动概率 + 7500) + 12500
			SIF 位置概率:位置编号 < RATE_WK
				位置概率:位置编号 = RATE_WK
		ELSEIF (FLAG:訪問者の現在位置 == 位置_红魔馆正门 || FLAG:訪問者の現在位置 == 位置_食堂) && 位置编号 == 位置_大厅
			RATE_WK = RAND:(最大移动概率 + 7500) + 12500
			SIF 位置概率:位置编号 < RATE_WK
				位置概率:位置编号 = RATE_WK
		ELSEIF FLAG:訪問者の現在位置 == 位置_大厅 && 位置编号 == 位置_二楼楼梯间
			RATE_WK = RAND:(最大移动概率 + 7500) + 12500
			SIF 位置概率:位置编号 < RATE_WK
				位置概率:位置编号 = RATE_WK
		ELSEIF FLAG:訪問者の現在位置 == 位置_二楼楼梯间 && 位置编号 == 位置_二楼走廊
			RATE_WK = RAND:(最大移动概率 + 7500) + 12500
			SIF 位置概率:位置编号 < RATE_WK
				位置概率:位置编号 = RATE_WK
		ELSEIF FLAG:訪問者の現在位置 == 位置_二楼走廊 && 位置编号 == 位置_玩家房间
			RATE_WK = RAND:(最大移动概率 + 7500) + 12500
			SIF 位置概率:位置编号 < RATE_WK
				位置概率:位置编号 = RATE_WK
		ENDIF
	ENDIF
	; 最大値更新？
	IF 位置概率:位置编号 > 上回最大概率
		上回最大概率 = 位置概率:位置编号
		RET_POS = 位置编号
	ENDIF
	DEBUGPRINTFORML 移动確率 {位置编号}：【%GETPLACENAME(位置编号)%】→ {位置概率:位置编号}／{最大移动概率}％、{CHK_TGT_IN_POS(位置编号)}人在室
NEXT
SIF FLAG:訪問者同行フラグ
	RETURN CFLAG:MASTER:現在位置
RETURN RET_POS